STDOUT:
........s............FF................................................. [ 11%]
........................................................................ [ 23%]
FFFFFF.......F.............................................FF........... [ 35%]
........................................................................ [ 47%]
........................................................................ [ 59%]
........................................................................ [ 71%]
..........................F............................................. [ 83%]
........................................................................ [ 95%]
..............................                                           [100%]
=================================== FAILURES ===================================
_______________________ test_ai_chat_shortcut_suggestion _______________________

    def test_ai_chat_shortcut_suggestion():
        """Verify that the AI suggests a shortcut form instead of direct mutation."""
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ai-chat/message",
            data={"message": "Erstelle aufmaß für Müller"},
            headers=headers,
        )
        assert response.status_code == 200
>       assert "KI-Vorschlag:" in response.text
E       assert 'KI-Vorschlag:' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:21: AssertionError
________________________ test_ai_chat_unhandled_message ________________________

    def test_ai_chat_unhandled_message():
        """Verify handling of unknown messages."""
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ai-chat/message", data={"message": "Hallo wie gehts"}, headers=headers
        )
        assert response.status_code == 200
>       assert "konnte aber keinen eindeutigen Workflow zuordnen" in response.text
E       assert 'konnte aber keinen eindeutigen Workflow zuordnen' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:39: AssertionError
_____________ test_scan_history_is_recorded_and_visible_in_health ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_scan_history_is_recorded_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b712ff0>

    def test_scan_history_is_recorded_and_visible_in_health(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        monkeypatch.setenv("KUKANILEA_ANONYMIZATION_KEY", "scan-test-key")
        knowledge_policy_update(
            "TENANT_A",
            actor_user_id="dev",
            allow_customer_pii=True,
            allow_documents=True,
        )
    
        docs = tmp_path / "docs"
        docs.mkdir(parents=True, exist_ok=True)
        (docs / "doc.txt").write_text("content", encoding="utf-8")
        source_watch_config_update("TENANT_A", documents_inbox_dir=str(docs), enabled=True)
    
        result = scan_sources_once("TENANT_A", actor_user_id="dev")
        assert int(result["ingested_ok"]) == 1
    
>       overview = get_health_overview("TENANT_A", history_limit=10)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: get_health_overview() got an unexpected keyword argument 'history_limit'

tests/test_autonomy_health_record.py:40: TypeError
________________________ test_smoke_test_updates_status ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_smoke_test_updates_status0')

    def test_smoke_test_updates_status(tmp_path: Path) -> None:
        _init_core(tmp_path)
>       result = run_smoke_test("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_smoke_test() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_health_record.py:49: TypeError
______________ test_rotate_logs_compresses_and_deletes_old_files _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_rotate_logs_compresses_an0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b7124b0>

    def test_rotate_logs_compresses_and_deletes_old_files(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        log_dir = tmp_path / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_dir))
    
        old_log = log_dir / "old.log"
        old_log.write_text("old", encoding="utf-8")
        old_gz = log_dir / "old.log.gz"
        old_gz.write_bytes(b"oldgz")
        fresh_log = log_dir / "fresh.log"
        fresh_log.write_text("fresh", encoding="utf-8")
    
        old_ts = time.time() - (40 * 24 * 3600)
        os.utime(old_log, (old_ts, old_ts))
        os.utime(old_gz, (old_ts, old_ts))
    
>       result = rotate_logs("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: rotate_logs() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_log_rotation.py:39: TypeError
________________ test_run_backup_once_creates_backup_and_event _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_run_backup_once_creates_b0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b7138c0>

    def test_run_backup_once_creates_backup_and_event(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
>       result = run_backup_once(tenant_id="TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup_once() got an unexpected keyword argument 'tenant_id'

tests/test_autonomy_maintenance.py:24: TypeError
_____________________ test_backup_create_rotate_and_verify _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_backup_create_rotate_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b713020>

    def test_backup_create_rotate_and_verify(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        tenant_dir = backup_root / "TENANT_A"
        tenant_dir.mkdir(parents=True, exist_ok=True)
        old_file = tenant_dir / "backup-old.sqlite"
        old_file.write_bytes(b"old")
        old_ts = time.time() - (10 * 24 * 3600)
        os.utime(old_file, (old_ts, old_ts))
    
>       result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:36: TypeError
____________________ test_backup_read_only_blocks_file_ops _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_backup_read_only_blocks_f0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b710140>

    def test_backup_read_only_blocks_file_ops(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        app = Flask(__name__)
        app.config["READ_ONLY"] = True
        with app.app_context():
>           result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:73: TypeError
____________________ test_autonomy_health_page_and_actions _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-135/test_autonomy_health_page_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10b713140>

    def test_autonomy_health_page_and_actions(tmp_path: Path, monkeypatch) -> None:
        backup_root = tmp_path / "backups"
        log_root = tmp_path / "logs"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_root))
    
        client = _client(tmp_path, read_only=False)
        page = client.get("/autonomy/health")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autonomy_ui_health.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:30:54,614 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=d6434e9e6d154e[REDACTED_PII]b8d[REDACTED_PII]f5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 143, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 165, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/web.py", line 7502, in autonomy_health_page
    data = get_health_overview(current_tenant(), history_limit=25)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: get_health_overview() got an unexpected keyword argument 'history_limit'
[REDACTED_PII] 23:30:54,625 - kukanilea - INFO - GET /autonomy/health 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=d6434e9e6d154e158615b8d5383330f5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 143, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 165, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/web.py", line 7502, in autonomy_health_page
    data = get_health_overview(current_tenant(), history_limit=25)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: get_health_overview() got an unexpected keyword argument 'history_limit'
INFO     kukanilea:__init__.py:116 GET /autonomy/health 500
____________________ test_run_native_desktop_bootstrap_flow ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10bad45f0>

    def test_run_native_desktop_bootstrap_flow(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5123,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:43: TypeError
________________ test_run_native_desktop_raises_when_not_ready _________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10bad4f20>

    def test_run_native_desktop_raises_when_not_ready(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5124,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:81: TypeError
___________________________ test_onboarding_seeding ____________________________

    def test_onboarding_seeding():
        """Verify that vertical kit selection seeds the database correctly."""
        init_db()
    
        # Select SHK kit
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ui/onboarding/setup", data={"vertical": "shk"}, headers=headers
        )
        assert response.status_code == 204
        assert response.headers["HX-Redirect"] == "/crm/"
    
        # Check DB content
        conn = get_db_connection()
        rows = conn.execute("SELECT name FROM templates WHERE vertical = 'shk'").fetchall()
        names = [row["name"] for row in rows]
    
>       assert "Protokoll: Wartung Gastherme" in names
E       AssertionError: assert 'Protokoll: Wartung Gastherme' in []

tests/test_onboarding.py:30: AssertionError
----------------------------- Captured stdout call -----------------------------
Database initialized at instance/kukanilea.db with FTS5.
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:31:05,625 - kukanilea.onboarding - INFO - User test-user applying Vertical Kit: shk
[REDACTED_PII] 23:31:05,626 - kukanilea.seeder - INFO - Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
[REDACTED_PII] 23:31:05,626 - kukanilea.onboarding - INFO - Successfully seeded vertical 'shk'.
------------------------------ Captured log call -------------------------------
INFO     kukanilea.onboarding:onboarding.py:37 User test-user applying Vertical Kit: shk
INFO     kukanilea.seeder:seeder.py:35 Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
INFO     kukanilea.onboarding:onboarding.py:45 Successfully seeded vertical 'shk'.
=============================== warnings summary ===============================
kukanilea_app.py:40
  /Users/gensuminguyen/Tophandwerk/kukanilea-git/kukanilea_app.py:40: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/test_offline_proof.py::test_csp_header_enforces_offline_policy
tests/test_offline_proof.py::test_no_rogue_external_urls_in_rendered_html
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/starlette/templating.py:162: DeprecationWarning: The `name` is not the first parameter anymore. The first parameter should be the `Request` instance.
  Replace `TemplateResponse(name, {"request": request})` by `TemplateResponse(request, name)`.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_ai_chat.py::test_ai_chat_shortcut_suggestion - assert 'KI-V...
FAILED tests/test_ai_chat.py::test_ai_chat_unhandled_message - assert 'konnte...
FAILED tests/test_autonomy_health_record.py::test_scan_history_is_recorded_and_visible_in_health
FAILED tests/test_autonomy_health_record.py::test_smoke_test_updates_status
FAILED tests/test_autonomy_log_rotation.py::test_rotate_logs_compresses_and_deletes_old_files
FAILED tests/test_autonomy_maintenance.py::test_run_backup_once_creates_backup_and_event
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_create_rotate_and_verify
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_read_only_blocks_file_ops
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_page_and_actions
FAILED tests/test_desktop_mode.py::test_run_native_desktop_bootstrap_flow - T...
FAILED tests/test_desktop_mode.py::test_run_native_desktop_raises_when_not_ready
FAILED tests/test_onboarding.py::test_onboarding_seeding - AssertionError: as...
12 failed, 593 passed, 1 skipped, 4 warnings in 43.89s


STDERR:
