STDOUT:
FFFFFFF.s..FF........FF........................................FFFFFF... [ 11%]
.........................FFFFFFFFFFFFFFF....F.........F..........FFFFF.. [ 23%]
FFFFFF.......FF.......FF....F.F.FFF......F....FFFF.........FF........... [ 35%]
.....................................................FF....F....FF...FFF [ 47%]
F........FFFF...F.FFFF.....FFF...FFFFFF.........F.FF....FF..F..........F [ 59%]
FFFFFFFF.FFFFFF..............F.......................................... [ 71%]
........................FFF.................................FFFFFFF..... [ 83%]
....FFF..F..................FF.........FFF.....FFFFF.FFFF............... [ 95%]
.....FFFFF.......FFFFF....FFFF                                           [100%]
=================================== FAILURES ===================================
____________ test_ai_chat_widget_with_mocked_orchestrator[chromium] ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f69ff80>
page = <Page url='http://127.0.0.1:49653/'>, base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_ai_chat_widget_with_mocked_orchestrator(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **_: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(webmod, "ollama_list_models", lambda **_: ["llama3.1:8b"])
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **_: {
                "status": "ok",
                "response": "Ich habe 1 Kontakt gefunden.",
                "conversation_id": "conv-e2e-1",
                "tool_used": ["search_contacts"],
            },
        )
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        page.goto(f"{base_url}/")
        _open_chat(page)
        page.wait_for_selector("#chatWidgetInput", state="visible")
>       assert page.locator("#chatWidgetSend").is_enabled()
E       AssertionError: assert False
E        +  where False = is_enabled()
E        +    where is_enabled = <Locator frame=<Frame name= url='http://127.0.0.1:49653/'> selector='#chatWidgetSend'>.is_enabled
E        +      where <Locator frame=<Frame name= url='http://127.0.0.1:49653/'> selector='#chatWidgetSend'> = locator('#chatWidgetSend')
E        +        where locator = <Page url='http://127.0.0.1:49653/'>.locator

tests/e2e/test_ai_chat.py:50: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:24:29,528 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:24:29,721 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:24:29,724 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e2582d2c9b[REDACTED_PII]b[REDACTED_PII]ad[REDACTED_PII]c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,728 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:29,731 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=2dcb34ea[REDACTED_PII]e[REDACTED_PII]f3c3c9d3d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,732 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:29,733 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:24:29,751 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:29,784 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=8e[REDACTED_PII]d9f[REDACTED_PII]baed[REDACTED_PII]d5486ce
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,793 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:29,794 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e9ab80b65f5849e6aa0dbcfd1e2c803e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,807 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:29,808 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=3becf2bf[REDACTED_PII]cd493f0e726f435aa68
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,823 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:29,824 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d77cc037b7794ebaa3413bbcb7e4cd1d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,835 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:29,836 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=771a5e7071e740bb91c191a2f7a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,846 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:29,846 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:29,952 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:24:29,956 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=06dae43a1e4f4bfc9f5746db6dad0e9c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:29,965 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:30,025 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:30,028 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=efd6cec6ace[REDACTED_PII]a67f69f2e0725d68
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,029 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:30,033 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a[REDACTED_PII]b[REDACTED_PII]a42b0898a436b886
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,034 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:30,036 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:30,046 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:30,049 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=500b6ae2f3c[REDACTED_PII]a6c[REDACTED_PII]f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,058 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:30,061 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=18daac48eb[REDACTED_PII]a8b3f630e4e268cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,071 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:30,073 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f007f3f6d8c[REDACTED_PII]b1cb00b9217b75f9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,082 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:30,084 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=faa[REDACTED_PII]d4bd79d9dc88b[REDACTED_PII]edc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,094 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:30,099 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=79fc26ae30b548a98be84d312e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,108 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:30,110 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:30,610 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=af1b[REDACTED_PII]a1d30d9de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,631 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:30,686 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:30,689 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0b2e53bd[REDACTED_PII]e9082cabbd752ee6221
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,689 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:30,692 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d0e014bd08f440e[REDACTED_PII]dd6f95b52f39
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,693 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:30,695 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:30,704 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:30,706 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e360a01cbaa44cd[REDACTED_PII]ae417b78db24
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,718 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:30,723 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c7800a[REDACTED_PII]bdc[REDACTED_PII]edc3a6ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,735 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:30,740 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]c9aa2f0d8cdfb2cb833
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,753 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:30,757 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9eab[REDACTED_PII]b4b[REDACTED_PII]d4f96f9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,758 - kukanilea - INFO - GET /api/ai/status 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e2582d2c9b754182b55440ad0234271c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=2dcb34ea86324e799312836f3c3c9d3d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=8e634134d9f24431baed20964d5486ce
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e9ab80b65f5849e6aa0dbcfd1e2c803e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=3becf2bf03224cd493f0e726f435aa68
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d77cc037b7794ebaa3413bbcb7e4cd1d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=771a5e7071e740bb91c191a2f7a61070
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=06dae43a1e4f4bfc9f5746db6dad0e9c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:29] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=efd6cec6ace34372a67f69f2e0725d68
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a68234b138844553a42b0898a436b886
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=500b6ae2f3c8492797771a6c4444051f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=18daac48eb424657a8b3f630e4e268cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f007f3f6d8c24679b1cb00b9217b75f9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=faa96408474d4bd79d9dc88b69388edc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=79fc26ae30b548a98be84d312e101081
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=af1b2855866342189392842a1d30d9de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0b2e53bd64484e9082cabbd752ee6221
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d0e014bd08f440e48311dd6f95b52f39
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e360a01cbaa44cd18810ae417b78db24
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c7800a2491044836bdc58442edc3a6ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0120763813624c9aa2f0d8cdfb2cb833
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9eab7869562144b4b98966770d4f96f9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
--------------------------- Captured stderr teardown ---------------------------
[REDACTED_PII] 23:24:30,763 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7633d56aaea149beb1bd02af07dbd0e9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,775 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:30,784 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=63a2ba14ede[REDACTED_PII]b5a58c4354c801f6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,793 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:30,799 - kukanilea - INFO - GET /app.webmanifest 200
______________ test_ai_status_and_chat_smoke_with_mock[chromium] _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f0f2e70>
page = <Page url='http://127.0.0.1:49653/'>, base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_ai_status_and_chat_smoke_with_mock(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **_: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(webmod, "ollama_list_models", lambda **_: ["llama3.1:8b"])
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **kwargs: {
                "status": "ok",
                "response": f"Mock-Antwort fuer: {kwargs.get('user_message', '')}",
                "conversation_id": "conv-smoke-1",
                "tool_used": [],
            },
        )
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        status = page.request.get(f"{base_url}/api/ai/status")
>       assert status.ok
E       AssertionError: assert False
E        +  where False = <APIResponse url='http://127.0.0.1:49653/api/ai/status' status=500 status_text='INTERNAL SERVER ERROR'>.ok

tests/e2e/test_ai_smoke.py:55: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:24:30,890 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:24:30,994 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:24:30,996 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=3972d20ef6e34fc[REDACTED_PII]aa35ca[REDACTED_PII]f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:30,998 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:31,003 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=0fa7df79a[REDACTED_PII]fb8acb41cd1c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,006 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:31,008 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:24:31,010 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:31,020 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]b6a694b8fa365cd266f3148e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,030 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:31,039 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=adc51e6f8c3f44d5a0af1a3a03e920d2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,051 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:31,052 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5fad20fd4b[REDACTED_PII]b84accecf[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,061 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:31,062 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d859e29ea53b[REDACTED_PII]ff[REDACTED_PII]d203
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,074 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:31,075 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5fa46ac3c[REDACTED_PII]ad9edbedfca66f7515
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,085 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:31,086 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:31,165 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:24:31,168 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=bf[REDACTED_PII]dda451bb5b3e96bbba317e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,178 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:31,229 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:31,233 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d5f5c62aa6c24ab8ac3e8d[REDACTED_PII]de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,233 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:31,235 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=25c26cc74b494da3b388fd19cde2a2e4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,236 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:31,238 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:31,247 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:31,250 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=685f273b913c460ba1419fa8bdbcb4de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,259 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:31,262 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]a68ea9e41dda66cc3ef[REDACTED_PII]a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,272 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:31,275 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a070cf82bc0d435fa846efeb2d35ebb0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,284 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:31,286 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e57ac616ab3243b1a7af1a70cbb4f8a9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,295 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:31,296 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1b2efa[REDACTED_PII]d71a243e60de94ac1b7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:31,305 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:31,307 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:46,236 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e42f[REDACTED_PII]0b[REDACTED_PII]d3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,238 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:46,246 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8b4597e5e7ab4fd289f37dc7765ad552
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,248 - kukanilea - INFO - GET /api/ai/status 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=3972d20ef6e34fc68015aa35ca61005f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:30] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=0fa7df79a298434fb8acb41cd1c69651
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=0647824b6a694b8fa365cd266f3148e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=adc51e6f8c3f44d5a0af1a3a03e920d2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5fad20fd4b534818b84accecf9172870
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d859e29ea53b49319ff183516380d203
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5fa46ac3c16249ad9edbedfca66f7515
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=bf7081616dda451bb5b3e96bbba317e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d5f5c62aa6c24ab8ac3e8d27275720de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=25c26cc74b494da3b388fd19cde2a2e4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=685f273b913c460ba1419fa8bdbcb4de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=68511a68ea9e41dda66cc3ef448756a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a070cf82bc0d435fa846efeb2d35ebb0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e57ac616ab3243b1a7af1a70cbb4f8a9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1b2efa5089524d71a243e60de94ac1b7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:31] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e42f80479796425181055930b40745d3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8b4597e5e7ab4fd289f37dc7765ad552
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
___________________ test_crm_customers_page_loads[chromium] ____________________

page = <Page url='http://127.0.0.1:49653/crm/customers'>
base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_crm_customers_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/crm/customers")
>       nav.expect_text("CRM · Kunden")

tests/e2e/test_crm.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10fb6b7d0>
text = 'CRM · Kunden'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:24:46,341 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:24:46,464 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:24:46,467 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e592f7985e0d4fb[REDACTED_PII]f0f48b0bd4e8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,468 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:46,470 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=6d1906e0a34e41d892fc82d7569afb1e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,471 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:46,474 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:24:46,478 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:46,485 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=799bf17be5084e018ef[REDACTED_PII]d05a4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,498 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:46,500 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=ae5f4561cbab405da0d6e957b44ea5c9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,517 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:46,518 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=532d6441eee346bc8ebd9545e9cd3df6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,528 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:46,529 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=38f77d9b0ab[REDACTED_PII]d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,540 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:46,541 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=7fc[REDACTED_PII]a84bb7b7ebd220dd44c7d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,553 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:46,554 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:46,638 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:24:46,642 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b54de806f9e84cc4a7f5608b9c9e31aa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,652 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:46,785 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:46,790 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7b2ce61ef85d477da[REDACTED_PII]b3a02
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,791 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:46,795 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9fac064a6b[REDACTED_PII]a0d7f[REDACTED_PII]fb9c21
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,802 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:46,809 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:46,824 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:46,828 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=99df[REDACTED_PII]a[REDACTED_PII]b41e83d720de52e7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,848 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:46,853 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4ce3b9a8d[REDACTED_PII]a61cdc28
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,871 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:46,874 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5db7cc8922a[REDACTED_PII]af76b721cbea633b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,900 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:46,904 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e90ac2ad08c[REDACTED_PII]ba[REDACTED_PII]caf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,922 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:46,925 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c3d4c04d848f49c1ab20c6d7dc0c3aa5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:46,936 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:46,940 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:47,391 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5bac5f6b8dd545d8a7bb79c31ec19c6e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,413 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:47,471 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:47,473 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]b[REDACTED_PII]d989cb5f5d2be6bcaf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,474 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:47,476 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d5a821bca38d4fc084ea5116c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,477 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:47,479 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:47,489 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:47,491 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=04d92decfaf2450c938af31a4b7130e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,502 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:47,505 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6133f06a48df4fed966ea95a1b2e8ef1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,514 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:47,516 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a6d2697d[REDACTED_PII]b2bb7e1b[REDACTED_PII]edc1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,525 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:47,527 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1887b62d[REDACTED_PII]df792f2d9e9530b3e61
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,536 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:47,538 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d1526e242dda[REDACTED_PII]d4a47fd14f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:47,547 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:47,549 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e592f7985e0d4fb49225f0f48b0bd4e8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=6d1906e0a34e41d892fc82d7569afb1e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=799bf17be5084e018ef59820903d05a4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=ae5f4561cbab405da0d6e957b44ea5c9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=532d6441eee346bc8ebd9545e9cd3df6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=38f77d9b0ab947838d02220962199405
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7fc7717516a84bb7b7ebd220dd44c7d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b54de806f9e84cc4a7f5608b9c9e31aa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7b2ce61ef85d477da9153585109b3a02
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9fac064a6b534245a0d7f21646fb9c21
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=99df377699a04745b41e83d720de52e7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4ce3b9a8d771401995594700a61cdc28
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5db7cc8922a04550af76b721cbea633b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e90ac2ad08c74142803289ba12503caf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c3d4c04d848f49c1ab20c6d7dc0c3aa5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:46] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5bac5f6b8dd545d8a7bb79c31ec19c6e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=96973b6032804d989cb5f5d2be6bcaf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d5a821bca38d4fc084ea5116c3986887
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=04d92decfaf2450c938af31a4b7130e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6133f06a48df4fed966ea95a1b2e8ef1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a6d2697d96484b2bb7e1b7147080edc1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1887b62d66904df792f2d9e9530b3e61
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=71275d1526e242dda71537d4a47fd14f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:47] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
_________________ test_knowledge_settings_page_loads[chromium] _________________

page = <Page url='http://127.0.0.1:49653/knowledge/settings'>
base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_knowledge_settings_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/knowledge/settings")
>       nav.expect_text("Knowledge · Einstellungen")

tests/e2e/test_docs.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10fb33e30>
text = 'Knowledge · Einstellungen'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:24:48,150 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:24:48,263 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:24:48,265 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]d0c84a43dd9ccb[REDACTED_PII]e0886cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,267 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:48,268 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=64ac4021e6714c998ce7a7277a97df79
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,268 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:48,270 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:24:48,280 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:48,286 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=1b6d05efdc7c4bd5be582cb6b7bc721f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,299 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:48,300 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=542e00a95a[REDACTED_PII]cb[REDACTED_PII]db43b0879d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,314 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:48,315 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=a7401c686d8842e6af928b4e355fe1ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,325 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:48,326 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=35ffb13dec074f[REDACTED_PII]cfb3b9d1d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,336 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:48,336 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=1ab2f5bec1f5453dab891c99ec2b90ba
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,347 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:48,348 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:48,434 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:24:48,438 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6b7dcff3760e498ab9af983f382f14cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,449 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:48,518 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:48,520 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d1e268b4072b132ae85a4c0631a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,521 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:48,524 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6f7c2fed00df488c9b[REDACTED_PII]a85c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,525 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:48,534 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:48,551 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:48,555 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4d7eb0b4be8041e1b64c[REDACTED_PII]e092cd6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,567 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:48,570 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=107fbdc995e846a[REDACTED_PII]d386ab874f1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,580 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:48,586 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=40f0902a13a[REDACTED_PII]b4f11fa0de[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,596 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:48,599 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a16c3ab4d89d4463ae[REDACTED_PII]efc0a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,609 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:48,611 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7d1d001fdcdc41bb8172e5f66e7f228e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:48,623 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:48,625 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:49,112 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5af3f32bee114b2aaf62a13a8d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,126 - kukanilea - INFO - GET /knowledge/settings 500
[REDACTED_PII] 23:24:49,179 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:49,183 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=58ec4d61bc9d4ebeaf329fd[REDACTED_PII]b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,184 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:49,187 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=529c07eabef840b6b[REDACTED_PII]cb0a92ad5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,188 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:49,190 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:49,202 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:49,204 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f6d[REDACTED_PII]c7e[REDACTED_PII]cbca4e68a728
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,216 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:49,220 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f9e97ebdf45c4db997b[REDACTED_PII]a8c9bbc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,229 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:49,232 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c539a04a9b[REDACTED_PII]a[REDACTED_PII]d9914c4f729
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,241 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:49,243 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0f612b88d8804f2aa3ef08f8167fcbe3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,256 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:49,258 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c7bd1cd[REDACTED_PII]a[REDACTED_PII]a451f13c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,274 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:49,276 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=907483d0c84a43dd9ccb32750e0886cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=64ac4021e6714c998ce7a7277a97df79
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=1b6d05efdc7c4bd5be582cb6b7bc721f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=542e00a95a63419cb16260db43b0879d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=a7401c686d8842e6af928b4e355fe1ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=35ffb13dec074f70811209cfb3b9d1d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=1ab2f5bec1f5453dab891c99ec2b90ba
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6b7dcff3760e498ab9af983f382f14cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=92124d1e268b4072b132ae85a4c0631a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6f7c2fed00df488c9b32287a85c71528
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4d7eb0b4be8041e1b64c07271e092cd6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=107fbdc995e846a389055d386ab874f1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=40f0902a13a84397b4f11fa0de663091
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a16c3ab4d89d4463ae696103760efc0a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7d1d001fdcdc41bb8172e5f66e7f228e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:48] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5af3f32bee114b2aaf62a13a8d284001
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /knowledge/settings 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /knowledge/settings HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=58ec4d61bc9d4ebeaf329fd73306416b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=529c07eabef840b6b117387cb0a92ad5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f6d44492c7e447519455cbca4e68a728
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f9e97ebdf45c4db997b694573a8c9bbc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c539a04a9b72456a83115d9914c4f729
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0f612b88d8804f2aa3ef08f8167fcbe3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c7bd1cd1287748528a952380a451f13c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
___________________ test_hardening_top_flows_smoke[chromium] ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fa94fe0>
page = <Page url='http://127.0.0.1:49653/crm/customers'>
base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_hardening_top_flows_smoke(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        _ensure_artifact_dir()
        request_ids = _attach_request_id_collector(page)
    
        # Keep AI deterministic and verify graceful handling on provider-down behavior.
        # The widget disables input when status endpoint reports unavailable, so keep
        # availability true and force an error response from chat processing instead.
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **_: {
                "status": "error",
                "response": "Provider unavailable, fallback pending.",
                "conversation_id": "conv-hardening-e2e-1",
                "tool_used": [],
            },
        )
    
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        # 1) Login
        login.goto()
        login.login("e2e_admin", "e2e_admin")
        page.screenshot(path=str(ARTIFACT_DIR / "flow-login.png"), full_page=True)
    
        # 2) CRM: create/search/open
        nav.open("/crm/customers")
        customer_name = "Smoke Customer 2026"
>       page.fill("#createCustomerForm input[name='name']", customer_name)

tests/e2e/test_hardening_smoke.py:90: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/sync_api/_generated.py:10177: in fill
    self._sync(
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_page.py:893: in fill
    return await self._main_frame.fill(**locals_to_params(locals()))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_frame.py:607: in fill
    await self._fill(**locals_to_params(locals()))
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_frame.py:619: in _fill
    await self._channel.send("fill", self._timeout, locals_to_params(locals()))
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_connection.py:69: in send
    return await self._connection.wrap_api_call(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <playwright._impl._connection.Connection object at 0x10f7a9130>
cb = <function Channel.send.<locals>.<lambda> at 0x10fb67240>
is_internal = False, title = None

    async def wrap_api_call(
        self, cb: Callable[[], Any], is_internal: bool = False, title: str = None
    ) -> Any:
        if self._api_zone.get():
            return await cb()
        task = asyncio.current_task(self._loop)
        st: List[inspect.FrameInfo] = getattr(
            task, "__pw_stack__", None
        ) or inspect.stack(0)
    
        parsed_st = _extract_stack_trace_information_from_stack(st, is_internal, title)
        self._api_zone.set(parsed_st)
        try:
            return await cb()
        except Exception as error:
>           raise rewrite_error(error, f"{parsed_st['apiName']}: {error}") from None
E           playwright._impl._errors.TimeoutError: Page.fill: Timeout 30000ms exceeded.
E           Call log:
E             - waiting for locator("#createCustomerForm input[name='name']")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_connection.py:559: TimeoutError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:24:49,851 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:24:49,964 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:24:49,966 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=2e[REDACTED_PII]c6894f66baf66d46c75d6e64
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,967 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:49,969 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e0c[REDACTED_PII]a3349e6bc6add6567c83ee9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,971 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:49,972 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:24:49,977 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:49,984 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=b2c5edd[REDACTED_PII]dadab1e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:49,996 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:50,000 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d7d7b[REDACTED_PII]a74af9b1b79c5de[REDACTED_PII]c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,013 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:50,016 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=ee[REDACTED_PII]e[REDACTED_PII]d8502e477a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,027 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:50,028 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=f7c1bc3fe[REDACTED_PII]a1da0da3ed806ba6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,093 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:50,095 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]f2a204e97b9c2a[REDACTED_PII]a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,105 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:50,106 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:50,168 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:24:50,172 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]db0024d[REDACTED_PII]c[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,183 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:50,237 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:50,240 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9fa1d[REDACTED_PII]f1ff[REDACTED_PII]b5946
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,241 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:50,243 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9af3e6b8381f41efb326b2afeecc7f86
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,244 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:50,246 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:50,261 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:50,265 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=298f[REDACTED_PII]a45b69c[REDACTED_PII]d0f36cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,274 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:50,277 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fb284f737fbc4bf[REDACTED_PII]f42c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,287 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:50,289 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ed13c1f9b7d[REDACTED_PII]f58ee99f1a66dab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,299 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:50,301 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6ab11ef0b0ce[REDACTED_PII]a69dd4846d7db4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,310 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:50,312 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=58d95d0c949e49aba[REDACTED_PII]bf32c502
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,322 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:50,324 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:24:50,886 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]fc[REDACTED_PII]d9f2bd1d779cba533
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,896 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:50,944 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:24:50,947 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=563a2aeb1fa04f3daf99d2c28abb6410
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,948 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:24:50,952 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=27a08aa15b5948cfbadfe1e2639d3c2e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,952 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:24:50,955 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:24:50,963 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:24:50,966 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0efd2fdabf8f4c42a26f910bc7e7d1cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,976 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:24:50,979 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e3c3725ad[REDACTED_PII]aaa52e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:50,989 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:24:50,991 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e6b7a[REDACTED_PII]c740e79e62c8bb454be48c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:51,001 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:24:51,003 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=06c01dc0ad[REDACTED_PII]fa[REDACTED_PII]a9df3e89bb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:51,013 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:24:51,015 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=dda1a484b3424bb3bca39e4c388c5dcf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:24:51,024 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:24:51,026 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:25:05,946 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=59e6ac42cd8946f4a2d3ef29cefd94b4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:05,948 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:20,945 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4f4dfdc006c[REDACTED_PII]c86aeb14eb5e266
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:20,948 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=2e282258c6894f66baf66d46c75d6e64
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e0c760412a3349e6bc6add6567c83ee9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=b2c5edd961784dadab1e170901912527
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:49] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d7d7b27470a74af9b1b79c5de68569c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=ee90247e5849463d8502e477a9781729
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=f7c1bc3fe9624165a1da0da3ed806ba6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7649696f2a204e97b9c2a49218a09581
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6603356db0024d50838c47712377749d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9fa1d7537772474188f1ff24444b5946
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9af3e6b8381f41efb326b2afeecc7f86
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=298f017663574a45b69c47493d0f36cc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fb284f737fbc4bf2958468f42c473360
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ed13c1f9b7d746718f58ee99f1a66dab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6ab11ef0b0ce442898a69dd4846d7db4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=58d95d0c949e49aba1826692bf32c502
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=653357fc9710455d9f2bd1d779cba533
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=563a2aeb1fa04f3daf99d2c28abb6410
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=27a08aa15b5948cfbadfe1e2639d3c2e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0efd2fdabf8f4c42a26f910bc7e7d1cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e3c3725ad844494390aaa52e26766870
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:50] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e6b7a05828c740e79e62c8bb454be48c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:51] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=06c01dc0ad60441fa18262a9df3e89bb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:51] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=dda1a484b3424bb3bca39e4c388c5dcf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:51] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:51] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:24:51] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=59e6ac42cd8946f4a2d3ef29cefd94b4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:05] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4f4dfdc006c942738c86aeb14eb5e266
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:20] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
_______________ test_hardening_error_shell_navigation[chromium] ________________

page = <Page url='http://127.0.0.1:49653/does-not-exist-hardening'>
base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_hardening_error_shell_navigation(page, base_url: str) -> None:
        _ensure_artifact_dir()
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        page.goto(f"{base_url}/does-not-exist-hardening")
        page.wait_for_load_state("networkidle")
    
        body = page.locator("body").text_content() or ""
>       assert "Fehler 404" in body
E       assert 'Fehler 404' in "\n\n  \n  \n    \n      \n        ✦\n        \n          KUKANILEA\n          Agent Orchestra\n        \n      \n    ....input) _cw.input.value = btn.dataset.q || '';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n\n\n"

tests/e2e/test_hardening_smoke.py:185: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:21,799 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:25:21,909 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:25:21,910 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=612af356da0744ee950e04f0548bec1c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,911 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:21,912 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]f6d0eda4acc9b919f5f5d219eaf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,914 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:21,916 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:25:21,925 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:21,933 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=b5c084eaf1334b13a9861db752edc64e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,943 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:21,945 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=18cc[REDACTED_PII]cdc4f3c8fb5b[REDACTED_PII]f35a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,960 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:21,961 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=cb86dd807c2645a8938d20a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,971 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:21,972 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=8dd37f[REDACTED_PII]c[REDACTED_PII]a08ba3a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:21,988 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:21,989 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=f992eabeb09f4ffd[REDACTED_PII]c2beec77c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,000 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:22,001 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:25:22,086 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:25:22,089 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8b3b54a[REDACTED_PII]cf390b0349d9cee1c3f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,101 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:22,152 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:25:22,155 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a6d3d366cb7744a78d38d234f71bfd10
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,156 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:22,158 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]a50d5b4c39a[REDACTED_PII]de[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,158 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:22,161 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:22,171 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:25:22,173 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9c76b7d4c[REDACTED_PII]f[REDACTED_PII]fd6ccb035
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,183 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:22,192 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1bf[REDACTED_PII]e[REDACTED_PII]a722ee7c1d6910d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,202 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:22,204 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e6125c141e2d4c5383f25a88bf8958de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,215 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:22,217 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=204a403cd0d9490fa85d74c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,226 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:22,228 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=23c5bc7b3e8c4a51bcce[REDACTED_PII]c0b661
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,238 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:22,240 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:25:22,735 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6d50aeb149ca4c26bea29a0c62b09da2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,757 - kukanilea - INFO - GET /does-not-exist-hardening 500
[REDACTED_PII] 23:25:22,818 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:25:22,820 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1a42faa0be6d4b28b427e73b4e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,821 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:22,823 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d08e288b0dbb490ea990d852f219e9d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,824 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:22,827 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:22,837 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:25:22,839 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]e[REDACTED_PII]c89bfbe57c2cff6abc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,849 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:22,852 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=42c01bc07fa24df5b0401dc0c05cf308
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,862 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:22,864 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=433a9b9caa0741e1ad3d[REDACTED_PII]ade6b59
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,873 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:22,875 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0947a[REDACTED_PII]d4f61a2d883eb387ab9ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,884 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:22,886 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e7506b3866db[REDACTED_PII]a0c[REDACTED_PII]c63
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:22,895 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:22,897 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=612af356da0744ee950e04f0548bec1c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=03778f6d0eda4acc9b919f5f5d219eaf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=b5c084eaf1334b13a9861db752edc64e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=18cc41462cdc4f3c8fb5b2303840f35a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=cb86dd807c2645a8938d20a633225622
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=8dd37f213789446589c560509a08ba3a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:21] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=f992eabeb09f4ffd8007469c2beec77c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8b3b54a285054cf390b0349d9cee1c3f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a6d3d366cb7744a78d38d234f71bfd10
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b28563a50d5b4c39a71617953de32184
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9c76b7d4c46843029f35811fd6ccb035
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1bf4447554e44696a722ee7c1d6910d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e6125c141e2d4c5383f25a88bf8958de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=204a403cd0d9490fa85d74c580030372
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=23c5bc7b3e8c4a51bcce112102c0b661
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6d50aeb149ca4c26bea29a0c62b09da2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /does-not-exist-hardening 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /does-not-exist-hardening HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1a42faa0be6d4b28b427e73b4e494663
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d08e288b0dbb490ea990d852f219e9d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1301669e847648c89bfbe57c2cff6abc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=42c01bc07fa24df5b0401dc0c05cf308
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=433a9b9caa0741e1ad3d20799ade6b59
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0947a346040d4f61a2d883eb387ab9ab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e7506b3866db41478a0c157562680c63
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:22] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
____________________ test_tasks_kanban_page_loads[chromium] ____________________

page = <Page url='http://127.0.0.1:49653/tasks'>
base_url = 'http://127.0.0.1:49653'

    @pytest.mark.e2e
    def test_tasks_kanban_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/tasks")
>       nav.expect_text("Tasks Kanban")

tests/e2e/test_tasks.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10be677d0>
text = 'Tasks Kanban'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:23,478 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:25:23,582 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:25:23,584 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=a7df[REDACTED_PII]e[REDACTED_PII]a[REDACTED_PII]c7f0e8a2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,586 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:23,587 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=f0a2b[REDACTED_PII]d[REDACTED_PII]a9371ea2b[REDACTED_PII]d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,588 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:23,589 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:25:23,601 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:23,607 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=61ff0989ee9c48aeb290d[REDACTED_PII]c2a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,618 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:23,620 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=442b[REDACTED_PII]c4bb796d5e1664f755cbe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,632 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:23,633 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5d3687b0af5744fa9cb71cde1ac[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,643 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:23,644 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d52ed[REDACTED_PII]e[REDACTED_PII]d[REDACTED_PII]e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,655 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:23,656 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=2342dc[REDACTED_PII]b4bae83c081bb6dd01f1c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,664 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:23,666 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:25:23,755 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:25:23,758 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7123a694d[REDACTED_PII]a92ea8e17f4fbb24a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,768 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:23,818 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:25:23,821 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=27dd4f02bfff4fa4bff328c2910c196c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,821 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:23,823 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=02e38b[REDACTED_PII]a[REDACTED_PII]e8cbdc791e90a2e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,824 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:23,827 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:23,837 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:25:23,840 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=328a0dafd9ad4c[REDACTED_PII]e2945e0ac89
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,849 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:23,853 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b18ba8d7bd4d4a0bb[REDACTED_PII]af9a00f6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,862 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:23,865 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]cebae478d8285fbf087a08fee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,875 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:23,877 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c8d4fb878ad343a4b6d1440a0a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,886 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:23,888 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=cee350acb76c452fa080b75ffa297c70
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:23,897 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:23,899 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:25:24,402 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=730b91a29ad5422d88db6c6b30b19b58
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,425 - kukanilea - INFO - GET /tasks 500
[REDACTED_PII] 23:25:24,483 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:25:24,485 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c18cb94e[REDACTED_PII]cacd0f77fa3c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,486 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:25:24,489 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2e18abc8d8f44ab99fd9c44a4bc891c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,489 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:25:24,493 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:25:24,501 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:25:24,504 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=df[REDACTED_PII]b[REDACTED_PII]a08b49db8aef[REDACTED_PII]a6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,513 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:25:24,516 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4c39f822c7874f[REDACTED_PII]cfe25e427c98
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,526 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:25:24,527 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e934ff81aa6247bc[REDACTED_PII]f29e0add
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,538 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:25:24,540 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6dddd181bc674f4c9ea4622cbd518a5c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,553 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:25:24,555 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fd0ec14d02dc43ca88f4d72ad9c537d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:24,565 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:25:24,567 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:106 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=a7df63001e414709a9913232c7f0e8a2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=f0a2b13242d34781a9371ea2b62876d8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=61ff0989ee9c48aeb290d9441825c2a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=442b6119297c4bb796d5e1664f755cbe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5d3687b0af5744fa9cb71cde1ac38020
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d52ed03693994e47996d78994e615547
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=2342dc96756b4bae83c081bb6dd01f1c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7123a694d058462a92ea8e17f4fbb24a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=27dd4f02bfff4fa4bff328c2910c196c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=02e38b40366a40058e8cbdc791e90a2e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=328a0dafd9ad4c3188606e2945e0ac89
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b18ba8d7bd4d4a0bb5908326af9a00f6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6692748cebae478d8285fbf087a08fee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c8d4fb878ad343a4b6d1440a0a350495
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=cee350acb76c452fa080b75ffa297c70
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:23] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=730b91a29ad5422d88db6c6b30b19b58
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /tasks 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /tasks HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:106 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c18cb94e178148299916cacd0f77fa3c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2e18abc8d8f44ab99fd9c44a4bc891c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:106 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=df62931b68524a08b49db8aef84862a6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4c39f822c7874f518493cfe25e427c98
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e934ff81aa6247bc86869977f29e0add
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6dddd181bc674f4c9ea4622cbd518a5c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fd0ec14d02dc43ca88f4d72ad9c537d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:106 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:25:24] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
______________ test_api_tasks_create_records_first_task_milestone ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_api_tasks_create_records_0')

    def test_api_tasks_create_records_first_task_milestone(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        first = client.post(
            "/api/tasks/create",
            json={
                "title": "Activation KPI Task",
                "task_type": "GENERAL",
                "severity": "INFO",
                "details": "a",
            },
        )
>       assert first.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_activation_kpi.py:149: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:26,950 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5cd2c4f38a[REDACTED_PII]caada5a67ab[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:26,951 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5cd2c4f38a35445caada5a67ab76017d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/tasks/create 500
________________ test_api_insights_activation_is_tenant_scoped _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_api_insights_activation_i0')

    def test_api_insights_activation_is_tenant_scoped(tmp_path: Path) -> None:
        client = _client(tmp_path, tenant="TENANT_A")
    
        for milestone in ACTIVATION_MILESTONES:
            record_activation_milestone(
                tenant_id="TENANT_A",
                actor_user_id="dev",
                milestone=milestone,
                source="tests",
            )
    
        for milestone in ACTIVATION_MILESTONES:
            record_activation_milestone(
                tenant_id="TENANT_B",
                actor_user_id="other",
                milestone=milestone,
                source="tests",
            )
    
        resp = client.get("/api/insights/activation")
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_activation_kpi.py:200: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,065 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=85c57cc272cd4995b353b3646c[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,066 - kukanilea - INFO - GET /api/insights/activation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=85c57cc272cd4995b353b3646c250774
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/insights/activation 500
_______________________ test_ai_chat_shortcut_suggestion _______________________

    def test_ai_chat_shortcut_suggestion():
        """Verify that the AI suggests a shortcut form instead of direct mutation."""
        headers = {"X-Tenant-ID": "test-tenant", "X-User-ID": "test-user", "X-Role": "ADMIN"}
        response = client.post(
            "/ai-chat/message",
            data={"message": "Erstelle aufmaß für Müller"},
            headers=headers,
        )
        assert response.status_code == 200
>       assert "KI-Vorschlag:" in response.text
E       assert 'KI-Vorschlag:' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:17: AssertionError
________________________ test_ai_chat_unhandled_message ________________________

    def test_ai_chat_unhandled_message():
        """Verify handling of unknown messages."""
        headers = {"X-Tenant-ID": "test-tenant", "X-User-ID": "test-user", "X-Role": "ADMIN"}
        response = client.post(
            "/ai-chat/message", data={"message": "Hallo wie gehts"}, headers=headers
        )
        assert response.status_code == 200
>       assert "konnte aber keinen eindeutigen Workflow zuordnen" in response.text
E       assert 'konnte aber keinen eindeutigen Workflow zuordnen' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:31: AssertionError
______________________________ test_api_ai_status ______________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1108acaa0>

    def test_api_ai_status(monkeypatch) -> None:
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            OLLAMA_MODEL="llama3.2:3b",
            OLLAMA_MODEL_FALLBACKS="llama3.1:8b,qwen2.5:3b",
        )
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **kwargs: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **kwargs: True)
        monkeypatch.setattr(
            webmod,
            "ai_load_bootstrap_state",
            lambda config: {"status": "done", "ok": True},
        )
        monkeypatch.setattr(webmod, "ai_count_personal_notes", lambda **kwargs: 2)
        monkeypatch.setattr(
            webmod,
            "ollama_list_models",
            lambda **kwargs: ["llama3.1:8b", "mistral:7b"],
        )
        res = client.get("/api/ai/status")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,381 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6f6512f9112c414aa071f9d0884a35ec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,382 - kukanilea - INFO - GET /api/ai/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6f6512f9112c414aa071f9d0884a35ec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/status 500
_________________________ test_api_ai_modelpack_routes _________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11080d100>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_api_ai_modelpack_routes0')

    def test_api_ai_modelpack_routes(monkeypatch, tmp_path: Path) -> None:
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            AI_BOOTSTRAP_MODELPACK_FILE=str(tmp_path / "offline-pack.tar.gz"),
            AI_BOOTSTRAP_MODELPACK_EXPORT_DIR=str(tmp_path / "exports"),
        )
        client = app.test_client()
        _login(client)
        with client.session_transaction() as sess:
            sess["role"] = "DEV"
    
        monkeypatch.setattr(
            webmod,
            "ai_create_model_pack",
            lambda **kwargs: {
                "ok": True,
                "pack_path": str(tmp_path / "exports" / "pack.tar.gz"),
                "file_count": 3,
                "total_bytes": 12,
            },
        )
        monkeypatch.setattr(
            webmod,
            "ai_import_model_pack",
            lambda **kwargs: {
                "ok": True,
                "pack_path": str(kwargs.get("pack_path") or ""),
                "extracted_files": 3,
            },
        )
    
        export_res = client.post("/api/ai/modelpack/export", json={})
>       assert export_res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:103: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,436 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5e1ba04d5f4c4cf6b26d3caa[REDACTED_PII]bdf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,437 - kukanilea - INFO - POST /api/ai/modelpack/export 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5e1ba04d5f4c4cf6b26d3caa50648bdf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/ai/modelpack/export 500
___________________________ test_api_ai_chat_success ___________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110948d40>

    def test_api_ai_chat_success(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **kwargs: {
                "status": "ok",
                "response": "Hallo von KI",
                "conversation_id": "conv-123",
                "tool_used": ["search_contacts"],
            },
        )
        res = client.post("/api/ai/chat", json={"q": "hallo"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:128: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,489 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=57a6077d[REDACTED_PII]fac[REDACTED_PII]b23b804
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,490 - kukanilea - INFO - POST /api/ai/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=57a6077d0489492fac5530758b23b804
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/ai/chat 500
______________________ test_api_ai_personal_memory_routes ______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110c2dd90>

    def test_api_ai_personal_memory_routes(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_list_personal_notes",
            lambda **kwargs: [{"id": "n1", "note": "test"}],
        )
        monkeypatch.setattr(webmod, "ai_add_personal_note", lambda **kwargs: "n2")
    
        get_res = client.get("/api/ai/personal-memory")
>       assert get_res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:149: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,544 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]d4a4614f15acdff1e0644ccbec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,545 - kukanilea - INFO - GET /api/ai/personal-memory 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f32427d4a4614f15acdff1e0644ccbec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/ai/personal-memory 500
_______________________ test_api_ai_confirm_tool_success _______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fd83980>

    def test_api_ai_confirm_tool_success(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_confirm_tool_call",
            lambda **kwargs: {
                "status": "ok",
                "response": "Bestaetigte Aktion ausgefuehrt.",
                "conversation_id": "conv-confirm-1",
                "tool_used": ["create_task"],
                "result": {"task_id": 12},
            },
        )
        res = client.post("/api/ai/confirm_tool", json={"token": "signed-token"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:177: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,609 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5fa7ba7740aa4c2f9547a401d82a9926
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,609 - kukanilea - INFO - POST /api/ai/confirm_tool 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5fa7ba7740aa4c2f9547a401d82a9926
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/ai/confirm_tool 500
__________________________ test_api_ai_feedback_route __________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_api_ai_feedback_route0')

    def test_api_ai_feedback_route(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path, app=app)
        client = app.test_client()
        _login(client)
    
        conv_id = save_conversation(
            tenant_id="KUKANILEA",
            user_id="dev",
            user_message="Hallo",
            assistant_response="Hi",
            tools_used=[],
        )
        assert conv_id
    
        res = client.post(
            "/api/ai/feedback",
            json={"conversation_id": conv_id, "rating": "positive"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:205: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:27,663 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2871f01d[REDACTED_PII]a1bcd79dc109a17efe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:27,664 - kukanilea - INFO - POST /api/ai/feedback 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2871f01d443841a1bcd79dc109a17efe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/ai/feedback 500
____________________ test_confirm_with_valid_token_succeeds ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_confirm_with_valid_token_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11039d7f0>

    def test_confirm_with_valid_token_succeeds(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:77: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,290 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ff[REDACTED_PII]d911cde04a7fde528
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,299 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ff8188738984429d911cde04a7fde528
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
_________________ test_confirm_replay_with_same_token_blocked __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_confirm_replay_with_same_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1102614c0>

    def test_confirm_replay_with_same_token_blocked(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:101: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,380 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fbcf88ddd35e48cd91dd521e984e5674
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,390 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fbcf88ddd35e48cd91dd521e984e5674
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
_____________________ test_confirm_with_wrong_token_fails ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_confirm_with_wrong_token_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1100707a0>

    def test_confirm_with_wrong_token_fails(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:126: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,470 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b9b37b5d3a7646bab5fcdfa0964d4251
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,478 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b9b37b5d3a7646bab5fcdfa0964d4251
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
_______________________ test_confirm_without_token_fails _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_confirm_without_token_fai0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f81bbf0>

    def test_confirm_without_token_fails(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:145: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,559 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c474fa9e235e[REDACTED_PII]f03bb56c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,568 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c474fa9e235e439393653740f03bb56c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
_______________ test_pending_confirm_requires_admin_or_dev_role ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_pending_confirm_requires_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fd452b0>

    def test_pending_confirm_requires_admin_or_dev_role(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Role gate rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        monkeypatch.setattr(core, "task_create", lambda **_kwargs: 900)
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "restricted",
                "requires_confirm": True,
            },
            context={"event_id": "1"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
        assert token
    
        client = app.test_client()
        _login(client, role="OPERATOR")
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_role_gate.py:71: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,646 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]a0bfeb4ed1ad3e706bec6ea4d7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,655 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b81113a0bfeb4ed1ad3e706bec6ea4d7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
________________ test_automation_post_without_csrf_is_forbidden ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_post_without_c0')

    def test_automation_post_without_csrf_is_forbidden(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
    
        response = client.post(
            f"/automation/{rule_id}/toggle",
            data={"enabled": "0"},
            follow_redirects=False,
        )
>       assert response.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:52: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,734 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=adb180c48e[REDACTED_PII]dae493b83bac9b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,743 - kukanilea - INFO - POST /automation/0ddf[REDACTED_PII]bef-4b4b-8260-c7c30aa05bd8/toggle 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=adb180c48e39478282dae493b83bac9b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /automation/0ddf7681-4bef-4b4b-8260-c7c30aa05bd8/toggle 500
_____________ test_automation_post_with_invalid_csrf_is_forbidden ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_post_with_inva0')

    def test_automation_post_with_invalid_csrf_is_forbidden(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:70: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,820 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5445a4972cee4ac[REDACTED_PII]c[REDACTED_PII]e093
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,829 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5445a4972cee4ac785963c477815e093
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
_______________ test_automation_post_with_valid_csrf_is_allowed ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_post_with_vali0')

    def test_automation_post_with_valid_csrf_is_allowed(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:95: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:28,949 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=36f72ad9e3c[REDACTED_PII]ca4d8e1e357
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:28,959 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=36f72ad9e3c1484985610ca4d8e1e357
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
___________ test_rule_simulation_creates_log_without_pending_actions ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_simulation_creates_l0')

    def test_rule_simulation_creates_log_without_pending_actions(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Dry run rule",
            triggers=[
                {
                    "trigger_type": "eventlog",
                    "config": {"allowed_event_types": ["email.received"]},
                }
            ],
            conditions=[],
            actions=[
                {
                    "action_type": "create_task",
                    "config": {"title": "dry run", "requires_confirm": False},
                }
            ],
            db_path=db_path,
        )
        con = sqlite3.connect(str(db_path), timeout=30)
        try:
            con.execute(
                """
                CREATE TABLE IF NOT EXISTS events(
                  id INTEGER PRIMARY KEY,
                  ts TEXT NOT NULL,
                  event_type TEXT NOT NULL,
                  entity_type TEXT NOT NULL,
                  entity_id INTEGER NOT NULL,
                  payload_json TEXT NOT NULL
                )
                """
            )
            con.execute(
                """
                INSERT INTO events(id, ts, event_type, entity_type, entity_id, payload_json)
                VALUES (1,'2026-02-18T10:00:00Z','email.received','mailbox_thread',1,'{\"tenant_id\":\"KUKANILEA\",\"ref_id\":\"dry-1\"}')
                """
            )
            con.commit()
        finally:
            con.close()
        event_id = 1
    
        client = app.test_client()
        _login(client)
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_dry_run.py:83: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,035 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3ce278a1e[REDACTED_PII]aa59a207b5ebad0e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,044 - kukanilea - INFO - GET /automation/fd1f8e0b-f18f-4500-afa2-6a306a9ff[REDACTED_PII]
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3ce278a1e401426aa59a207b5ebad0e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/fd1f8e0b-f18f-4500-afa2-6a306a9ff978 500
_______________________ test_rule_export_and_safe_import _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_export_and_safe_impo0')

    def test_rule_export_and_safe_import(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        source_rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Export Source",
            description="safe export",
            max_executions_per_minute=7,
            triggers=[
                {
                    "trigger_type": "eventlog",
                    "config": {"allowed_event_types": ["lead.created"]},
                }
            ],
            conditions=[],
            actions=[{"action_type": "create_task", "config": {"requires_confirm": False}}],
            db_path=db_path,
        )
    
        client = app.test_client()
        _login(client)
    
        exported = client.get(f"/automation/{source_rule_id}/export")
>       assert exported.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,121 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4d7a92eb[REDACTED_PII]bfae0cb4fb911e54be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,130 - kukanilea - INFO - GET /automation/4413d[REDACTED_PII]d-480a-a66d-9fb0463b4929/export 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4d7a92eb937346bfae0cb4fb911e54be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/4413d165-853d-480a-a66d-9fb0463b4929/export 500
____________ test_rule_import_supports_cron_email_send_and_webhook _____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_import_supports_cron0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110c59400>

    def test_rule_import_supports_cron_email_send_and_webhook(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(
            webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["hooks.example.com"]
        )
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:109: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,203 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f8ee6cd5d8f94ed0bf4d49f264e1cb34
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,212 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f8ee6cd5d8f94ed0bf4d49f264e1cb34
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
_______________ test_rule_import_rejects_invalid_cron_expression _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_import_rejects_inval0')

    def test_rule_import_rejects_invalid_cron_expression(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:161: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,284 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3ef[REDACTED_PII]c774b31a2fd4912fd26a521
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,293 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3ef406548c774b31a2fd4912fd26a521
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
________________ test_rule_import_rejects_cron_with_six_fields _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_import_rejects_cron_0')

    def test_rule_import_rejects_cron_with_six_fields(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:186: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,366 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fa05aa0dcf914df68c7dfc360c1af351
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,375 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fa05aa0dcf914df68c7dfc360c1af351
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
___________ test_rule_import_rejects_email_draft_unknown_placeholder ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_import_rejects_email0')

    def test_rule_import_rejects_email_draft_unknown_placeholder(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:211: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,446 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7468d9b2c9df46cfb77b0ad94a8b964a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,455 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7468d9b2c9df46cfb77b0ad94a8b964a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
______________ test_rule_import_rejects_webhook_outside_allowlist ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rule_import_rejects_webho0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110291c10>

    def test_rule_import_rejects_webhook_outside_allowlist(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["good.example"])
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:248: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,566 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1ccf[REDACTED_PII]fbc4e81aba314ad11ea674b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,576 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1ccf79701fbc4e81aba314ad11ea674b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
______________________ test_run_now_blocked_in_read_only _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_run_now_blocked_in_read_o0')

    def test_run_now_blocked_in_read_only(tmp_path: Path) -> None:
        _init_core(tmp_path)
        automation_rule_create(
            "TENANT_A",
            "r1",
            "leads",
            "lead_screening_stale",
            '{"hours_in_screening":1}',
            '[{"kind":"lead_pin","value":true}]',
            "dev",
        )
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_A"
    
        r = client.post("/api/automation/run-now", json={"max_actions": 5})
>       assert r.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_read_only.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:29,913 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=178b0f3eacea41e291e4397b9f76cf41
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:29,914 - kukanilea - INFO - POST /api/automation/run-now 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=178b0f3eacea41e291e4397b9f76cf41
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/automation/run-now 500
_____________ test_pending_token_not_exposed_in_query_or_eventlog ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_pending_token_not_exposed0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fe1af30>

    def test_pending_token_not_exposed_in_query_or_eventlog(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Token leak rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        monkeypatch.setattr(core, "task_create", lambda **_kwargs: 901)
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "secure confirm",
                "requires_confirm": True,
            },
            context={"event_id": "9"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
        assert token
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_token_leak.py:72: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,080 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=309b[REDACTED_PII]ec[REDACTED_PII]b1bc2b7f788
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,089 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=309b447530724ec598122b1bc2b7f788
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
____________________ test_automation_builder_requires_login ____________________

    def test_automation_builder_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.get("/automation", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,224 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e[REDACTED_PII]cffa741e4899e22db1c8a2c03
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,233 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e869758cffa741e4899e22db1c8a2c03
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
_____________________ test_automation_builder_toggle_rule ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_builder_toggle0')

    def test_automation_builder_toggle_rule(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
    
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:61: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,290 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d9baa[REDACTED_PII]cb4973bae[REDACTED_PII]d[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,299 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d9baa23526cb4973bae779658d69496d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
__________ test_automation_pending_confirm_requires_ack_and_confirms ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_pending_confir0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fee8fb0>

    def test_automation_pending_confirm_requires_ack_and_confirms(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "From pending",
                "requires_confirm": True,
            },
            context={"event_id": "42"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        assert pending_id
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:107: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,377 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a90b[REDACTED_PII]ad9bab41f5c912d5c3c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,386 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a90b270296334ad9bab41f5c912d5c3c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/pending 500
__________ test_automation_rule_detail_supports_cron_and_mail_actions __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_rule_detail_su0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10bee7140>

    def test_automation_rule_detail_supports_cron_and_mail_actions(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(
            webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["hooks.example.com"]
        )
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:161: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,461 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e4e010d[REDACTED_PII]be978c127c331
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,470 - kukanilea - INFO - GET /automation/[REDACTED_PII]c-a[REDACTED_PII]a2-a[REDACTED_PII]e94d099b0a 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e4e010d270874648875be978c127c331
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/8387848c-a906-44a2-a225-60e94d099b0a 500
_________ test_automation_rule_detail_rejects_invalid_email_templates __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_automation_rule_detail_re0')

    def test_automation_rule_detail_rejects_invalid_email_templates(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:235: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:30,544 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]c7aa0420dabeda535d15c9cdb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:30,553 - kukanilea - INFO - GET /automation/4ed8d7a4-cbd2-4ad5-a73f-[REDACTED_PII]adc3f0f 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4075817c7aa0420dabeda535d15c9cdb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation/4ed8d7a4-cbd2-4ad5-a73f-44844adc3f0f 500
_____________ test_scan_history_is_recorded_and_visible_in_health ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_scan_history_is_recorded_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110408920>

    def test_scan_history_is_recorded_and_visible_in_health(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        monkeypatch.setenv("KUKANILEA_ANONYMIZATION_KEY", "scan-test-key")
        knowledge_policy_update(
            "TENANT_A",
            actor_user_id="dev",
            allow_customer_pii=True,
            allow_documents=True,
        )
    
        docs = tmp_path / "docs"
        docs.mkdir(parents=True, exist_ok=True)
        (docs / "doc.txt").write_text("content", encoding="utf-8")
        source_watch_config_update("TENANT_A", documents_inbox_dir=str(docs), enabled=True)
    
        result = scan_sources_once("TENANT_A", actor_user_id="dev")
        assert int(result["ingested_ok"]) == 1
    
>       overview = get_health_overview("TENANT_A", history_limit=10)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: get_health_overview() got an unexpected keyword argument 'history_limit'

tests/test_autonomy_health_record.py:40: TypeError
________________________ test_smoke_test_updates_status ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_smoke_test_updates_status0')

    def test_smoke_test_updates_status(tmp_path: Path) -> None:
        _init_core(tmp_path)
>       result = run_smoke_test("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_smoke_test() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_health_record.py:49: TypeError
______________ test_rotate_logs_compresses_and_deletes_old_files _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_rotate_logs_compresses_an0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1104097f0>

    def test_rotate_logs_compresses_and_deletes_old_files(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        log_dir = tmp_path / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_dir))
    
        old_log = log_dir / "old.log"
        old_log.write_text("old", encoding="utf-8")
        old_gz = log_dir / "old.log.gz"
        old_gz.write_bytes(b"oldgz")
        fresh_log = log_dir / "fresh.log"
        fresh_log.write_text("fresh", encoding="utf-8")
    
        old_ts = time.time() - (40 * 24 * 3600)
        os.utime(old_log, (old_ts, old_ts))
        os.utime(old_gz, (old_ts, old_ts))
    
>       result = rotate_logs("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: rotate_logs() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_log_rotation.py:39: TypeError
________________ test_run_backup_once_creates_backup_and_event _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_run_backup_once_creates_b0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11040bc80>

    def test_run_backup_once_creates_backup_and_event(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
>       result = run_backup_once(tenant_id="TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup_once() got an unexpected keyword argument 'tenant_id'

tests/test_autonomy_maintenance.py:24: TypeError
_____________________ test_backup_create_rotate_and_verify _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_backup_create_rotate_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11040b6e0>

    def test_backup_create_rotate_and_verify(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        tenant_dir = backup_root / "TENANT_A"
        tenant_dir.mkdir(parents=True, exist_ok=True)
        old_file = tenant_dir / "backup-old.sqlite"
        old_file.write_bytes(b"old")
        old_ts = time.time() - (10 * 24 * 3600)
        os.utime(old_file, (old_ts, old_ts))
    
>       result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:36: TypeError
____________________ test_backup_read_only_blocks_file_ops _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_backup_read_only_blocks_f0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1108e6f60>

    def test_backup_read_only_blocks_file_ops(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        app = Flask(__name__)
        app.config["READ_ONLY"] = True
        with app.app_context():
>           result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:73: TypeError
____________________ test_autonomy_health_page_and_actions _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_autonomy_health_page_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110cb9a00>

    def test_autonomy_health_page_and_actions(tmp_path: Path, monkeypatch) -> None:
        backup_root = tmp_path / "backups"
        log_root = tmp_path / "logs"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_root))
    
        client = _client(tmp_path, read_only=False)
        page = client.get("/autonomy/health")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autonomy_ui_health.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:31,279 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=36aa0b3946ac4080a77d[REDACTED_PII]a5391
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:31,288 - kukanilea - INFO - GET /autonomy/health 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=36aa0b3946ac4080a77d7816655a5391
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /autonomy/health 500
______________ test_autonomy_health_actions_blocked_in_read_only _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_autonomy_health_actions_b0')

    def test_autonomy_health_actions_blocked_in_read_only(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
>       assert client.post("/autonomy/health/backup").status_code == 403
E       AssertionError: assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E        +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = post('/autonomy/health/backup')
E        +      where post = <FlaskClient <Flask 'app'>>.post

tests/test_autonomy_ui_health.py:52: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:31,361 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]edb24ba4b62a308ca[REDACTED_PII]c2a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:31,370 - kukanilea - INFO - POST /autonomy/health/backup 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=33262edb24ba4b62a308ca368021c2a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /autonomy/health/backup 500
__________________________ test_autotag_pages_render ___________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_autotag_pages_render0')

    def test_autotag_pages_render(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       assert client.get("/autonomy/autotag/rules").status_code == 200
E       AssertionError: assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E        +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = get('/autonomy/autotag/rules')
E        +      where get = <FlaskClient <Flask 'app'>>.get

tests/test_autotag_web.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:31,726 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]f48beb48eb9a6b778e[REDACTED_PII]a84
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:31,735 - kukanilea - INFO - GET /autonomy/autotag/rules 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=234722f48beb48eb9a6b778e30952a84
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /autonomy/autotag/rules 500
____________________ test_autotag_create_read_only_blocked _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_autotag_create_read_only_0')

    def test_autotag_create_read_only_blocked(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
        resp = client.post(
            "/autonomy/autotag/rules/create",
            data={
                "name": "Blocked",
                "priority": "0",
                "filename_glob": "*x*",
                "set_doctype_token": "invoice",
            },
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autotag_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:31,810 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=e9b08ca718da476abf362d4358ea257a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:31,819 - kukanilea - INFO - POST /autonomy/autotag/rules/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=e9b08ca718da476abf362d4358ea257a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /autonomy/autotag/rules/create 500
_______________________________ test_chat_api_ok _______________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11013c170>

    def test_chat_api_ok(monkeypatch):
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
    
        monkeypatch.setattr(
            web,
            "agent_answer",
            lambda msg: {
                "text": "ok",
                "facts": [{"text": "f1", "meta": {"kind": "task", "pk": 1}, "score": 0.1}],
                "action": None,
            },
        )
    
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "KUKANILEA"
    
        res = client.post("/api/chat", json={"q": "rechnung"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_api.py:27: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:31,946 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c0bda[REDACTED_PII]ff894ea[REDACTED_PII]e37d1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:31,947 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c0bda549317447ff894ea640103e37d1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/chat 500
_________________________ test_api_chat_requires_auth __________________________

    def test_api_chat_requires_auth():
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.post("/api/chat", json={"q": "rechnung"})
>       assert res.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_api.py:47: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,048 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=6c5f6e[REDACTED_PII]ec28e839eefdf[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,049 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=6c5f6e7929184ec28e839eefdf106828
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/chat 500
_______________ test_chat_widget_present_for_authenticated_user ________________

    def test_chat_widget_present_for_authenticated_user() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_widget.py:19: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,151 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=669a[REDACTED_PII]dd492e8a8bfee119f[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,160 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=669a250439dd492e8a8bfee119f80510
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
________________ test_chat_api_hx_request_returns_html_fragment ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ff3c9b0>

    def test_chat_api_hx_request_returns_html_fragment(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(web, "agent_answer", lambda msg: {"text": "Antwort"})
    
        res = client.post(
            "/api/chat",
            data={"msg": "Hallo"},
            headers={"HX-Request": "true"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_widget.py:36: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,211 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=02cbab993bf74b54ac1fb9bce9a6e456
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,211 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=02cbab993bf74b54ac1fb9bce9a6e456
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/chat 500
______________ test_collision_event_emitted_on_claim_guard_block _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_collision_event_emitted_o0')

    def test_collision_event_emitted_on_claim_guard_block(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            ANONYMIZATION_KEY="collision-key",
            READ_ONLY=False,
        )
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice")
        _set_session(c2, user="bob")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_collision_event_emitted.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_collision_event_emitted.py:48: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,285 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=711ae[REDACTED_PII]ab1b676b40a0d8ac
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,286 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=711ae19342334368ab1b676b40a0d8ac
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
___________________ test_read_only_blocks_crm_mutation_route ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_read_only_blocks_crm_muta0')

    def test_read_only_blocks_crm_mutation_route(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
    
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        resp = client.post("/api/customers", json={"name": "Blocked"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_customers.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,542 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b39df43daec8452ca7d86a9a85d57fe7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,543 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b39df43daec8452ca7d86a9a85d57fe7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/customers 500
_____________________ test_api_tenant_isolation_customers ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_api_tenant_isolation_cust0')

    def test_api_tenant_isolation_customers(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "alice"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
        res_create = client.post("/api/customers", json={"name": "A-Customer"})
>       assert res_create.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_tenant_isolation.py:29: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:32,924 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=f8c64ac8b[REDACTED_PII]d68bcfad6447
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:32,925 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=f8c64ac8b44741358645d68bcfad6447
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/customers 500
___________ test_crm_ui_shows_read_only_banner_and_disabled_controls ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_crm_ui_shows_read_only_ba0')

    def test_crm_ui_shows_read_only_banner_and_disabled_controls(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        res = client.get("/crm/customers")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_read_only.py:30: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:33,006 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5680c1c12ac84ff082b[REDACTED_PII]b4a6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:33,019 - kukanilea - INFO - GET /crm/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5680c1c12ac84ff082b928485993b4a6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
____________________ test_crm_pages_and_partials_return_200 ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_crm_pages_and_partials_re0')

    def test_crm_pages_and_partials_return_200(tmp_path: Path) -> None:
        _init_core(tmp_path)
        customer_id = core.customers_create("TENANT_A", "UI Kunde")
        core.contacts_create(
            "TENANT_A", customer_id, "Max Mustermann", email="max@example.com"
        )
        deal_id = core.deals_create("TENANT_A", customer_id, "UI Deal", stage="lead")
        quote = core.quotes_create_from_deal("TENANT_A", deal_id)
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _auth(client)
    
        for path in [
            "/crm/customers",
            f"/crm/customers/{customer_id}",
            "/crm/deals",
            "/crm/quotes",
            "/crm/emails/import",
            "/crm/_customers_table",
            f"/crm/_customer_contacts/{customer_id}",
            f"/crm/_customer_deals/{customer_id}",
            f"/crm/_customer_quotes/{customer_id}",
            f"/crm/_customer_emails/{customer_id}",
            "/crm/_deals_pipeline",
            "/crm/_quotes_table",
            f"/crm/quotes/{quote['id']}",
        ]:
            res = client.get(path)
>           assert res.status_code == 200, path
E           AssertionError: /crm/customers
E           assert 500 == 200
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_routes.py:56: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:33,121 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=a217acf8083c4dcf87bf[REDACTED_PII]d08
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:33,134 - kukanilea - INFO - GET /crm/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=a217acf8083c4dcf87bf365389505d08
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /crm/customers 500
____________________ test_crm_email_import_page_upload_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_crm_email_import_page_upl0')

    def test_crm_email_import_page_upload_flow(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _auth(client)
    
        eml = b"From: sender@example.com\nTo: receiver@example.com\nSubject: UI\n\nBody"
        resp = client.post(
            "/api/emails/import",
            data={"file": (io.BytesIO(eml), "sample.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_routes.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:33,271 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]f5bb92f[REDACTED_PII]dedc5eecacbe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:33,272 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=95061f5bb92f47959252dedc5eecacbe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/emails/import 500
____________________ test_run_native_desktop_bootstrap_flow ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f69d670>

    def test_run_native_desktop_bootstrap_flow(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5123,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:43: TypeError
________________ test_run_native_desktop_raises_when_not_ready _________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ff2bb90>

    def test_run_native_desktop_raises_when_not_ready(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5124,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:81: TypeError
________________________ test_oversize_eml_returns_413 _________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_oversize_eml_returns_4130')

    def test_oversize_eml_returns_413(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", MAX_EML_BYTES=1024)
        client = app.test_client()
        _auth(client, "TENANT_A")
    
        payload = b"From: a@a\nTo: b@b\nSubject: S\n\n" + (b"x" * 2000)
        data = {"file": (io.BytesIO(payload), "mail.eml")}
        resp = client.post(
            "/api/emails/import", data=data, content_type="multipart/form-data"
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_email_import_limits.py:39: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,046 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]d28d4e60a648f9e50e522eab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,049 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=20200379d28d4e60a648f9e50e522eab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/emails/import 500
______________ test_malformed_email_does_not_crash_and_truncates _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_malformed_email_does_not_0')

    def test_malformed_email_does_not_crash_and_truncates(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", MAX_EML_BYTES=1024 * 1024)
        client = app.test_client()
        _auth(client, "TENANT_A")
    
        huge = (
            b"From: a@a\nTo: b@b\nSubject: S\nContent-Type: text/plain\n\n" + b"A" * 25000
        )
        data = {"file": (io.BytesIO(huge), "mail.eml")}
        resp = client.post(
            "/api/emails/import", data=data, content_type="multipart/form-data"
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_email_import_limits.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,137 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6fe[REDACTED_PII]db84d1fa426a51d7e6c2e47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,138 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6fe254504db84d1fa426a51d7e6c2e47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/emails/import 500
_______________ test_entity_links_panel_renders_sanitized_titles _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_entity_links_panel_render0')

    def test_entity_links_panel_renders_sanitized_titles(tmp_path: Path) -> None:
        client, lead_id = _client(tmp_path)
        resp = client.get(f"/entity-links/lead/{lead_id}")
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_panel_render.py:62: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,389 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=a9b69f593c[REDACTED_PII]eb[REDACTED_PII]aabd91de4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,400 - kukanilea - INFO - GET /entity-links/lead/150f90d424b74d7380fc62bee4c[REDACTED_PII]
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=a9b69f593c35492eb259419aabd91de4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /entity-links/lead/150f90d424b74d7380fc62bee4c14186 500
_________________ test_entity_links_routes_create_list_delete __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_entity_links_routes_creat0')

    def test_entity_links_routes_create_list_delete(tmp_path: Path) -> None:
        client, lead_id, note_id = _client(tmp_path)
    
        partial = client.get(f"/entity-links/lead/{lead_id}")
>       assert partial.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,521 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=dd[REDACTED_PII]f687d4030bf9d257bf[REDACTED_PII]e0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,534 - kukanilea - INFO - GET /entity-links/lead/cadfc5c4f0c54c6b8ff243fe4ff5ce5c 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=dd12757f687d4030bf9d257bf23858e0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /entity-links/lead/cadfc5c4f0c54c6b8ff243fe4ff5ce5c 500
___________________ test_entity_links_read_only_returns_403 ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_entity_links_read_only_re0')

    def test_entity_links_read_only_returns_403(tmp_path: Path) -> None:
        client, lead_id, note_id = _client(tmp_path, read_only=True)
        resp = client.post(
            "/entity-links/create",
            data={
                "left_type": "lead",
                "left_id": lead_id,
                "right_type": "knowledge_note",
                "right_id": note_id,
                "link_type": "related",
            },
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_web.py:89: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,622 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=dd437fc0f72d4c7d9fef87f4b6b696b2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,631 - kukanilea - INFO - POST /entity-links/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=dd437fc0f72d4c7d9fef87f4b6b696b2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /entity-links/create 500
________________ test_global_http_exception_honors_accept_json _________________

    def test_global_http_exception_honors_accept_json() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="OPERATOR")
    
        res = client.get("/route-does-not-exist", headers={"Accept": "application/json"})
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_content_negotiation.py:60: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,895 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6d7df54f85bc4179a2021b[REDACTED_PII]c517e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,897 - kukanilea - INFO - GET /route-does-not-exist 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6d7df54f85bc4179a2021b60948c517e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /route-does-not-exist 500
______________ test_web_404_uses_shell_with_back_reload_controls _______________

    def test_web_404_uses_shell_with_back_reload_controls() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/route-does-not-exist")
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:20: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:34,949 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c9e[REDACTED_PII]a954da5bb6b32ff7ce1547c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:34,959 - kukanilea - INFO - GET /route-does-not-exist 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c9e033219a954da5bb6b32ff7ce1547c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /route-does-not-exist 500
____________ test_navigation_is_persistent_and_minimizable_in_shell ____________

    def test_navigation_is_persistent_and_minimizable_in_shell() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:34: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,012 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=281f7041c1f[REDACTED_PII]b284cd3bdd629e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,022 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=281f7041c1f742889b284cd3bdd629e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings 500
____________________ test_api_404_returns_json_error_shape _____________________

    def test_api_404_returns_json_error_shape() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/api/not-found")
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:53: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,072 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=90b2bced5d0b4b13b45def64da1dcbbb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,073 - kukanilea - INFO - GET /api/not-found 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=90b2bced5d0b4b13b45def64da1dcbbb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/not-found 500
_______________________ test_evidence_pack_requires_auth _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_evidence_pack_requires_au0')

    def test_evidence_pack_requires_auth(tmp_path: Path) -> None:
        _init_core(tmp_path)
        Config.CORE_DB = core.DB_PATH
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", CORE_DB=core.DB_PATH)
        client = app.test_client()
        resp = client.get("/api/reports/evidence-pack/abc?entity_type=lead")
>       assert resp.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,335 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=bceff3e454c9417bab6b1e7b5b[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,335 - kukanilea - INFO - GET /api/reports/evidence-pack/abc 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=bceff3e454c9417bab6b1e7b5b779188
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/reports/evidence-pack/abc 500
_________ test_evidence_pack_lead_includes_request_ids_and_attachments _________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_evidence_pack_lead_includ0')

    def test_evidence_pack_lead_includes_request_ids_and_attachments(
        tmp_path: Path,
    ) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_evidence_pack.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,459 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=7cb7407c[REDACTED_PII]de981bf840f[REDACTED_PII]c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,460 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=7cb7407c78374de981bf840f6447128c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_____________________ test_evidence_pack_tenant_isolation ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_evidence_pack_tenant_isol0')

    def test_evidence_pack_tenant_isolation(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_evidence_pack.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,538 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]ad5c8474d4292b9bb8ffa8d4a7d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,539 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=59182ad5c8474d4292b9bb8ffa8d4a7d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_____________________ test_evidence_pack_validation_error ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_evidence_pack_validation_0')

    def test_evidence_pack_validation_error(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.get("/api/reports/evidence-pack/abc?entity_type=invalid")
>       assert resp.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:123: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,615 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]dd[REDACTED_PII]e89c54f4c5cf7fa9f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,616 - kukanilea - INFO - GET /api/reports/evidence-pack/abc 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6534158dd330406e89c54f4c5cf7fa9f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/reports/evidence-pack/abc 500
____________ test_run_latency_suite_mock_mode_collects_percentiles _____________

    def test_run_latency_suite_mock_mode_collects_percentiles() -> None:
>       report = run_latency_suite(requests_count=2, use_real_ai=False)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_hardening_latency_bench.py:7: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

requests_count = 2, use_real_ai = False

    def run_latency_suite(
        requests_count: int = 30, use_real_ai: bool = False
    ) -> dict[str, Any]:
        req_count = max(1, int(requests_count))
        with _isolated_env():
            app = create_app()
            app.config.update(TESTING=True, READ_ONLY=False)
            with app.app_context():
                auth_db: AuthDB = app.extensions["auth_db"]
                _seed_auth(auth_db)
    
            client = app.test_client()
            with client.session_transaction() as sess:
                sess["user"] = "bench"
                sess["role"] = "DEV"
                sess["tenant_id"] = "KUKANILEA"
    
            # Seed one searchable knowledge note.
            seed = client.post(
                "/api/knowledge/notes",
                json={"title": "Latency Seed Note", "body": "Hardening benchmark seed"},
            )
            if seed.status_code != 200:
>               raise RuntimeError(f"knowledge seed failed: HTTP {seed.status_code}")
E               RuntimeError: knowledge seed failed: HTTP 500

app/bench/hardening_latency.py:112: RuntimeError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,703 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5f0e8ff[REDACTED_PII]b[REDACTED_PII]eff5ed6ca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,704 - kukanilea - INFO - POST /api/knowledge/notes 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5f0e8ff1472848509b89630eff5ed6ca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/knowledge/notes 500
_____________ test_unauthenticated_requests_are_denied_by_default ______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110c5b7d0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_unauthenticated_requests_0')

    def test_unauthenticated_requests_are_denied_by_default(
        monkeypatch, tmp_path: Path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
    
        for path in ("/api/tasks", "/api/customers", "/api/audit"):
            res = client.get(path)
>           assert res.status_code == 401, path
E           AssertionError: /api/tasks
E           assert 500 == 401
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:65: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:35,891 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=71a[REDACTED_PII]a15b496da77b20b2629c7562
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:35,892 - kukanilea - INFO - GET /api/tasks 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=71a85982a15b496da77b20b2629c7562
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/tasks 500
__________________ test_low_role_is_denied_on_admin_endpoint ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1101d82f0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_low_role_is_denied_on_adm0')

    def test_low_role_is_denied_on_admin_endpoint(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="op", role="OPERATOR")
        client = app.test_client()
        _login(client, username="op", role="OPERATOR")
    
        res = client.get("/api/audit")
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:79: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,008 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8d89c0e08b8a481cb75e889d6ce2e787
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,009 - kukanilea - INFO - GET /api/audit 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8d89c0e08b8a481cb75e889d6ce2e787
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/audit 500
_________________ test_cross_tenant_access_does_not_leak_data __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10feaf2c0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_cross_tenant_access_does_0')

    def test_cross_tenant_access_does_not_leak_data(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path, fixed_tenant_enforce=False)
        _seed_user(app, username="alice", role="OPERATOR")
        _seed_user(app, username="bob", role="OPERATOR")
        client = app.test_client()
    
        core.DB_PATH = app.config["CORE_DB"]
        task_id = int(
            core.task_create(
                tenant="KUKANILEA",
                severity="INFO",
                task_type="GENERAL",
                title="Tenant A Secret Task",
                details="Do not leak",
                created_by="alice",
            )
        )
    
        _login(client, username="bob", role="OPERATOR", tenant="OTHER_TENANT")
        denied = client.post(f"/api/tasks/{task_id}/move", json={"column": "done"})
>       assert denied.status_code in (403, 404)
E       assert 500 in (403, 404)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:111: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,152 - kukanilea - ERROR - unhandled_exception tenant_id=OTHER_TENANT request_id=[REDACTED_PII]be44e668e4059feb31e2acb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,153 - kukanilea - INFO - POST /api/tasks/1/move 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=OTHER_TENANT request_id=929570055be44e668e4059feb31e2acb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/tasks/1/move 500
_______________________ test_logout_invalidates_session ________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ff5b560>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_logout_invalidates_sessio0')

    def test_logout_invalidates_session(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="dev", role="OPERATOR")
        client = app.test_client()
        _login(client, username="dev", role="OPERATOR")
    
        before = client.get("/api/tasks")
>       assert before.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:125: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,306 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=38d[REDACTED_PII]c244ef8a19c1a31de0fbd00
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,307 - kukanilea - INFO - GET /api/tasks 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=38d076230c244ef8a19c1a31de0fbd00
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/tasks 500
_____________________ test_idle_timeout_default_60_logout ______________________

    def test_idle_timeout_default_60_logout() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        now = datetime.now(UTC)
        with client.session_transaction() as sess:
            sess["session_created_at"] = _iso_utc(now - timedelta(minutes=10))
            sess["last_activity"] = _iso_utc(now - timedelta(minutes=61))
            sess["idle_timeout_minutes"] = 60
    
        res = client.get("/settings", follow_redirects=False)
>       assert res.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,453 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]e6aa204bda[REDACTED_PII]ac4ae897c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,463 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=215865e6aa204bda821658ac4ae897c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings 500
______________________ test_idle_timeout_bounds_enforced _______________________

    def test_idle_timeout_bounds_enforced() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        with client.session_transaction() as sess:
            sess["csrf_token"] = "csrf-test"
    
        low = client.post(
            "/settings/idle-timeout",
            data={"idle_timeout": "5", "csrf_token": "csrf-test"},
            follow_redirects=False,
        )
>       assert low.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:50: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,515 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ce[REDACTED_PII]ab[REDACTED_PII]e7f1c9b0e6cf2f7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,525 - kukanilea - INFO - POST /settings/idle-timeout 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ce21138794ab42888e7f1c9b0e6cf2f7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /settings/idle-timeout 500
_______________________ test_absolute_timeout_8h_logout ________________________

    def test_absolute_timeout_8h_logout() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        now = datetime.now(UTC)
        with client.session_transaction() as sess:
            sess["session_created_at"] = _iso_utc(now - timedelta(hours=9))
            sess["last_activity"] = _iso_utc(now - timedelta(minutes=1))
            sess["idle_timeout_minutes"] = 480
    
        res = client.get("/settings", follow_redirects=False)
>       assert res.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:77: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,577 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7027f34fa03a4a4f8bb2447abeb8bbf0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,586 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7027f34fa03a4a4f8bb2447abeb8bbf0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings 500
_______________________ test_intake_triage_invoice_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_invoice_lab0')

    def test_intake_triage_invoice_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post(
            "/api/intake/triage",
            json={
                "text": "Bitte Rechnung 2026-44 senden, Zahlung und Mahnung unklar.",
                "metadata": {"channel": "email"},
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:42: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,818 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]fe01d7a401e9873a057b7e1a874
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,819 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=22376fe01d7a401e9873a057b7e1a874
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
_______________________ test_intake_triage_support_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_support_lab0')

    def test_intake_triage_support_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post(
            "/api/intake/triage",
            json={"text": "Störung in der Anlage, bitte dringend Hilfe."},
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:56: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:36,928 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]d8203c740ac8700a0187d4e6ac6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:36,929 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=82910d8203c740ac8700a0187d4e6ac6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
_______________________ test_intake_triage_unknown_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_unknown_lab0')

    def test_intake_triage_unknown_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "Hallo zusammen"})
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:65: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,067 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=53b5ac6c2b[REDACTED_PII]ccbebd1a20a15d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,068 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=53b5ac6c2b95475086ccbebd1a20a15d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
________________________ test_intake_triage_validation _________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_validation0')

    def test_intake_triage_validation(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "   "})
>       assert resp.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:74: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,153 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6b7fa9251fa84c039ccd3821f40a493e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,154 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6b7fa9251fa84c039ccd3821f40a493e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
_______________________ test_intake_triage_requires_auth _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_requires_au0')

    def test_intake_triage_requires_auth(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        resp = client.post("/api/intake/triage", json={"text": "anfrage angebot"})
>       assert resp.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:85: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,236 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=2c[REDACTED_PII]a[REDACTED_PII]df7b5aea68efdce6c34
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,237 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=2c07246a61354df7b5aea68efdce6c34
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
___________________ test_intake_triage_event_contains_tenant ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_intake_triage_event_conta0')

    def test_intake_triage_event_contains_tenant(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "Neukunde Anfrage"})
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:91: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,320 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]b[REDACTED_PII]af8f377b833ef4b1a3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,321 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=281278b8378743af8f377b833ef4b1a3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/intake/triage 500
_________ test_email_upload_denied_when_policy_off_and_no_rows_written _________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_email_upload_denied_when_0')

    def test_email_upload_denied_when_policy_off_and_no_rows_written(
        tmp_path: Path,
    ) -> None:
        client = _client(tmp_path)
        eml = b"From: a@example.com\nTo: b@example.com\nSubject: Test\n\nHallo"
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (eml, "sample.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_policy_default_deny.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,481 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5cb7070b17c849c997b9a2f8a7443ada
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,493 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5cb7070b17c849c997b9a2f8a7443ada
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /knowledge/email/upload 500
_______________________ test_oversize_upload_is_rejected _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_oversize_upload_is_reject0')

    def test_oversize_upload_is_rejected(tmp_path: Path) -> None:
        client = _client(tmp_path)
        eml = b"From:a@x.tld\nTo:b@y.tld\nSubject:x\n\n" + (b"x" * 4096)
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (io.BytesIO(eml), "big.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_security_limits.py:53: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,588 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=01b90f0fe[REDACTED_PII]afb5a7a7a7b7eab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,598 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=01b90f0fe02441558afb5a7a7a7b7eab
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /knowledge/email/upload 500
________________________ test_subject_newline_sanitized ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_subject_newline_sanitized0')

    def test_subject_newline_sanitized(tmp_path: Path) -> None:
        client = _client(tmp_path)
        eml = (
            b"From:a@x.tld\nTo:b@y.tld\n"
            b"Subject: Hello\r\nBcc: injected@evil.tld\n\n"
            b"Body with enough text to pass minimal threshold Body with enough text to pass."
        )
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (io.BytesIO(eml), "ok.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_security_limits.py:68: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:37,692 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6059e417fd3140a5bebb3884f[REDACTED_PII]b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:37,704 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6059e417fd3140a5bebb3884f493173b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /knowledge/email/upload 500
_____________________ test_ics_oversize_upload_is_rejected _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_ics_oversize_upload_is_re0')

    def test_ics_oversize_upload_is_rejected(tmp_path: Path) -> None:
        client = _client(tmp_path)
        data = b"BEGIN:VCALENDAR\nBEGIN:VEVENT\nSUMMARY:X\nEND:VEVENT\nEND:VCALENDAR\n" + (
            b"x" * 4096
        )
        resp = client.post(
            "/knowledge/ics/upload",
            data={"file": (io.BytesIO(data), "big.ics")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_ics_limits.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,037 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=d91cc3134fc04d3a985c4c636d49d229
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,049 - kukanilea - INFO - POST /knowledge/ics/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=d91cc3134fc04d3a985c4c636d49d229
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /knowledge/ics/upload 500
__________ test_ics_upload_denied_when_policy_off_and_no_rows_written __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_ics_upload_denied_when_po0')

    def test_ics_upload_denied_when_policy_off_and_no_rows_written(tmp_path: Path) -> None:
        client = _client(tmp_path)
        data = b"BEGIN:VCALENDAR\nBEGIN:VEVENT\nSUMMARY:X\nEND:VEVENT\nEND:VCALENDAR\n"
        resp = client.post(
            "/knowledge/ics/upload",
            data={"file": (io.BytesIO(data), "sample.ics")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_ics_policy_default_deny.py:40: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,140 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=f95c63e376f04a[REDACTED_PII]b72da1c8ebf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,155 - kukanilea - INFO - POST /knowledge/ics/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=f95c63e376f04a4096180b72da1c8ebf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /knowledge/ics/upload 500
__________________ test_read_only_blocks_note_mutations_route __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_read_only_blocks_note_mut0')

    def test_read_only_blocks_note_mutations_route(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        resp = client.post(
            "/api/knowledge/notes",
            json={"title": "x", "body": "y", "tags": "z"},
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_notes_crud.py:76: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,283 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=26c5bb4b66ef46f2bb[REDACTED_PII]ec8820dc9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,284 - kukanilea - INFO - POST /api/knowledge/notes 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=26c5bb4b66ef46f2bb07468ec8820dc9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/knowledge/notes 500
____________________ test_claim_panel_escapes_user_content _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_claim_panel_escapes_user_0')

    def test_claim_panel_escapes_user_content(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "<script>alert(1)</script>"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_A"
    
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "A",
                "subject": "Lead",
                "message": "M",
            },
        )
        lead_id = (created.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_claims_template_safety.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,696 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=e6df10af8ffd4163bef6db0f6aaf4cf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,697 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=e6df10af8ffd4163bef6db0f6aaf4cf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
____________________ test_claim_and_collision_guard_routes _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_claim_and_collision_guard0')

    def test_claim_and_collision_guard_routes(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice")
        _set_session(c2, user="bob")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_claims_web.py:51: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_claims_web.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,781 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=d694faf[REDACTED_PII]c24bf22a96eca002b14
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,782 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=d694faf692864c24bf22a96eca002b14
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
____________________ test_claim_endpoints_read_only_blocked ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_claim_endpoints_read_only0')

    def test_claim_endpoints_read_only_blocked(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_claims_web.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_claims_web.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,866 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=731a7d12bb844df9af[REDACTED_PII]fd21af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,868 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=731a7d12bb844df9af92258308fd21af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
______________ test_lead_conversion_creates_deal_quote_and_links _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_conversion_creates_d0')

    def test_lead_conversion_creates_deal_quote_and_links(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice", tenant="TENANT_A")
    
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_conversion.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:38,955 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b0a559aff33e4d19a7e6adb[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:38,956 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b0a559aff33e4d19a7e6adb534346359
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
___________ test_lead_conversion_blocked_when_claimed_by_other_user ____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_conversion_blocked_w0')

    def test_lead_conversion_blocked_when_claimed_by_other_user(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice", tenant="TENANT_A")
        _set_session(c2, user="bob", tenant="TENANT_A")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_conversion.py:180: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,089 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=00b2fb31eaf4433ba0ec[REDACTED_PII]cc[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,090 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=00b2fb31eaf4433ba0ec64291cc44596
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
___________________ test_lead_conversion_is_tenant_isolated ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_conversion_is_tenant0')

    def test_lead_conversion_is_tenant_isolated(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice", tenant="TENANT_A")
        _set_session(c2, user="bob", tenant="TENANT_B")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_conversion.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,267 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b8b1b3f20c4f4e25be5e3c87e54b5af8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,268 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b8b1b3f20c4f4e25be5e3c87e54b5af8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
____________________ test_lead_conversion_read_only_blocked ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_conversion_read_only0')

    def test_lead_conversion_read_only_blocked(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice", tenant="TENANT_A")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_conversion.py:216: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,356 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=99e[REDACTED_PII]ddd425a984b173c1dacf407
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,357 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=99e551803ddd425a984b173c1dacf407
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_______________________ test_guard_allows_owner_mutation _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_guard_allows_owner_mutati0')

    def test_guard_allows_owner_mutation(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_allows_owner.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_allows_owner.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,442 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=d5cf0f326f3e4817bad[REDACTED_PII]a[REDACTED_PII]b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,443 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=d5cf0f326f3e4817bad294328a70201b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
________________ test_guard_blocks_non_owner_and_logs_collision ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_guard_blocks_non_owner_an0')

    def test_guard_blocks_non_owner_and_logs_collision(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", ANONYMIZATION_KEY="guard-key")
    
        owner = app.test_client()
        other = app.test_client()
        _set_session(owner, user="alice")
        _set_session(other, user="bob")
    
>       lead_id = _new_lead(owner)
                  ^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_blocks_claimed.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_blocks_claimed.py:36: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,523 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=befe9b0d[REDACTED_PII]f87e20f4e41d7d0a9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,524 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=befe9b0d5368409f87e20f4e41d7d0a9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
________________ test_guard_blocks_mutations_in_read_only_mode _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_guard_blocks_mutations_in0')

    def test_guard_blocks_mutations_in_read_only_mode(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_read_only.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_read_only.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,659 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=543fa476f75f[REDACTED_PII]be6c1189b0c0a66
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,660 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=543fa476f75f42658be6c1189b0c0a66
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_________________ test_lead_api_read_only_blocks_all_new_posts _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_api_read_only_blocks0')

    def test_lead_api_read_only_blocks_all_new_posts(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        lead_id = "abc123"
        routes = [
            ("POST", "/api/leads", {"source": "manual", "subject": "X"}),
            ("POST", f"/api/leads/{lead_id}/screen/accept", {}),
            ("POST", f"/api/leads/{lead_id}/screen/ignore", {}),
            ("PUT", f"/api/leads/{lead_id}/priority", {"priority": "high", "pinned": 1}),
            ("PUT", f"/api/leads/{lead_id}/assign", {"assigned_to": "dev"}),
            ("POST", "/api/leads/blocklist", {"kind": "email", "value": "a@example.com"}),
        ]
    
        for method, url, body in routes:
            resp = client.open(url, method=method, json=body)
>           assert resp.status_code == 403
E           assert 500 == 403
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:62: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,740 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5aa900f[REDACTED_PII]aa2a5b1bb[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,741 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5aa900f76403451688aa2a5b1bb05885
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
________________ test_lead_api_validation_and_tenant_isolation _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_lead_api_validation_and_t0')

    def test_lead_api_validation_and_tenant_isolation(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        bad = client.post("/api/leads", json={"source": "invalid", "subject": "X"})
>       assert bad.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:73: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,872 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5e74e85f[REDACTED_PII]d85a2ef[REDACTED_PII]c3e32
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,873 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5e74e85f89114d85a2ef3511371c3e32
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_________________ test_actor_user_id_written_to_event_payload __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_actor_user_id_written_to_0')

    def test_actor_user_id_written_to_event_payload(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_lead_intake_api.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:39,952 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=ed[REDACTED_PII]d0af[REDACTED_PII]bdd61b7b5abd586e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:39,953 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=ed63199d0af54613bdd61b7b5abd586e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
______________________ test_xss_payload_is_escaped_in_ui _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_xss_payload_is_escaped_in0')

    def test_xss_payload_is_escaped_in_ui(tmp_path: Path) -> None:
        client = _client(tmp_path)
        bad_subject = "<script>alert(1)</script>"
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "X",
                "subject": bad_subject,
                "message": "m",
            },
        )
        lead_id = (resp.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_intake_api.py:117: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:40,030 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=a0a03f[REDACTED_PII]ac99d7273b12c[REDACTED_PII]b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:40,031 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=a0a03f8451084ac99d7273b12c59048b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
_____________________ test_ics_crlf_injection_is_sanitized _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_ics_crlf_injection_is_san0')

    def test_ics_crlf_injection_is_sanitized(tmp_path: Path) -> None:
        client = _client(tmp_path)
        subject = "Bad\\r\\nBEGIN:VEVENT"
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "X",
                "subject": subject,
                "message": "m",
            },
        )
        lead_id = (resp.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_intake_api.py:142: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:40,106 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b3114de1885b4933aa3df07eb37d57ca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:40,107 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b3114de1885b4933aa3df07eb37d57ca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/leads 500
___________________ test_read_only_blocks_mutating_requests ____________________

    def test_read_only_blocks_mutating_requests() -> None:
        app = create_app()
        app.config["READ_ONLY"] = True
        app.config["LICENSE_REASON"] = "trial_expired"
        client = app.test_client()
    
        resp = client.post("/api/chat", json={"q": "hallo"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_license_read_only.py:18: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:41,446 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=4f19d4a6785d48e3bd43bd674f[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:41,447 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=4f19d4a6785d48e3bd43bd674f449844
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/chat 500
_______________________ test_conversations_pages_render ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_conversations_pages_rende0')

    def test_conversations_pages_render(tmp_path: Path) -> None:
        client, event_id = _client(tmp_path)
        list_resp = client.get("/conversations")
>       assert list_resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_omni_web.py:44: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:42,638 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=fc850e423c[REDACTED_PII]d01bd836c28cd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:42,647 - kukanilea - INFO - GET /conversations 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=fc850e423c024107815d01bd836c28cd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /conversations 500
_____________________ test_conversations_tenant_isolation ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_conversations_tenant_isol0')

    def test_conversations_tenant_isolation(tmp_path: Path) -> None:
        client, event_id = _client(tmp_path)
        with client.session_transaction() as sess:
            sess["tenant_id"] = "TENANT_B"
        resp = client.get(f"/conversations/{event_id}")
>       assert resp.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_omni_web.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:42,726 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_B request_id=8042b28fd1fd4cd9af[REDACTED_PII]c0078e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:42,735 - kukanilea - INFO - GET /conversations/b3d79b[REDACTED_PII]d5be95eb698e1cf60a 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_B request_id=8042b28fd1fd4cd9af57803871c0078e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /conversations/b3d79b98436948d5be95eb698e1cf60a 500
___________________________ test_onboarding_seeding ____________________________

    def test_onboarding_seeding():
        """Verify that vertical kit selection seeds the database correctly."""
        init_db()
    
        # Select SHK kit
        headers = {"X-Tenant-ID": "test-tenant", "X-User-ID": "test-user", "X-Role": "ADMIN"}
        response = client.post(
            "/ui/onboarding/setup", data={"vertical": "shk"}, headers=headers
        )
        assert response.status_code == 204
        assert response.headers["HX-Redirect"] == "/crm/"
    
        # Check DB content
        conn = get_db_connection()
        rows = conn.execute("SELECT name FROM templates WHERE vertical = 'shk'").fetchall()
        names = [row["name"] for row in rows]
    
>       assert "Protokoll: Wartung Gastherme" in names
E       AssertionError: assert 'Protokoll: Wartung Gastherme' in []

tests/test_onboarding.py:26: AssertionError
----------------------------- Captured stdout call -----------------------------
Database initialized at instance/kukanilea.db with FTS5.
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:42,739 - kukanilea.onboarding - INFO - User test-user applying Vertical Kit: shk
[REDACTED_PII] 23:25:42,740 - kukanilea.seeder - INFO - Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
[REDACTED_PII] 23:25:42,740 - kukanilea.onboarding - INFO - Successfully seeded vertical 'shk'.
------------------------------ Captured log call -------------------------------
INFO     kukanilea.onboarding:onboarding.py:37 User test-user applying Vertical Kit: shk
INFO     kukanilea.seeder:seeder.py:35 Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
INFO     kukanilea.onboarding:onboarding.py:45 Successfully seeded vertical 'shk'.
__________________________ test_postfach_page_renders __________________________

    def test_postfach_page_renders() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/postfach")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,205 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=34fa6d[REDACTED_PII]b[REDACTED_PII]af050dea908
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,214 - kukanilea - INFO - GET /postfach 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=34fa6d315187492b81361af050dea908
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /postfach 500
______________ test_postfach_page_shows_key_warning_when_missing _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110367a10>

    def test_postfach_page_shows_key_warning_when_missing(monkeypatch) -> None:
        monkeypatch.delenv("EMAIL_ENCRYPTION_KEY", raising=False)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/postfach")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:69: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,266 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a9ff48e[REDACTED_PII]f3be[REDACTED_PII]cc6e1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,276 - kukanilea - INFO - GET /postfach 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a9ff48e1074040f3be938115476cc6e1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /postfach 500
____________________ test_mail_route_redirects_to_postfach _____________________

    def test_mail_route_redirects_to_postfach() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/mail", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:81: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,327 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=42f81a[REDACTED_PII]c5f9432b[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,337 - kukanilea - INFO - GET /mail 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=42f81a0677734c5f9432b0295191966d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /mail 500
______________ test_postfach_account_add_fails_closed_without_key ______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1102b1df0>

    def test_postfach_account_add_fails_closed_without_key(monkeypatch) -> None:
        monkeypatch.delenv("EMAIL_ENCRYPTION_KEY", raising=False)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.post(
            "/postfach/accounts/add",
            data={
                "label": "Demo",
                "imap_host": "imap.example.com",
                "imap_port": "993",
                "imap_username": "user@example.com",
                "secret": "pass",
            },
            follow_redirects=True,
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:103: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,390 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3e9b4b31b5a[REDACTED_PII]b5645e9505f5a804
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,399 - kukanilea - INFO - POST /postfach/accounts/add 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3e9b4b31b5a84075b5645e9505f5a804
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /postfach/accounts/add 500
_____________ test_postfach_oauth_start_sets_session_and_redirects _____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_postfach_oauth_start_sets0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110c592e0>

    def test_postfach_oauth_start_sets_session_and_redirects(
        tmp_path: Path, monkeypatch
    ) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            GOOGLE_CLIENT_ID="google-client-id",
            GOOGLE_CLIENT_SECRET="google-client-secret",
            OAUTH_REDIRECT_BASE="http://127.0.0.1:5051",
        )
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="OAuth Google",
            imap_host="imap.gmail.com",
            imap_port=993,
            imap_username="user@example.com",
            smtp_host="smtp.gmail.com",
            smtp_port=465,
            smtp_username="user@example.com",
            smtp_use_ssl=True,
            secret_plain="",
            auth_mode="oauth_google",
            oauth_provider="google",
        )
        monkeypatch.setattr(
            "app.web.postfach_build_authorization_url",
            lambda **kwargs: "https://accounts.google.com/o/oauth2/v2/auth?state=test",
        )
        client = app.test_client()
        _login(client)
        res = client.post(
            "/postfach/accounts/oauth/start",
            data={"account_id": account_id},
            follow_redirects=False,
        )
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:146: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,514 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=77f6accd02c[REDACTED_PII]e[REDACTED_PII]a62a65fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,524 - kukanilea - INFO - POST /postfach/accounts/oauth/start 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=77f6accd02c548529e439022a62a65fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /postfach/accounts/oauth/start 500
___________________ test_postfach_oauth_callback_saves_token ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_postfach_oauth_callback_s0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ffd55e0>

    def test_postfach_oauth_callback_saves_token(tmp_path: Path, monkeypatch) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            GOOGLE_CLIENT_ID="google-client-id",
            GOOGLE_CLIENT_SECRET="google-client-secret",
            OAUTH_REDIRECT_BASE="http://127.0.0.1:5051",
        )
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="OAuth Google",
            imap_host="imap.gmail.com",
            imap_port=993,
            imap_username="user@example.com",
            smtp_host="smtp.gmail.com",
            smtp_port=465,
            smtp_username="user@example.com",
            smtp_use_ssl=True,
            secret_plain="",
            auth_mode="oauth_google",
            oauth_provider="google",
        )
        monkeypatch.setattr(
            "app.web.postfach_exchange_code_for_tokens",
            lambda **kwargs: {
                "access_token": "access-token",
                "refresh_token": "refresh-token",
                "expires_at": "2099-01-01T00:00:00+00:00",
                "scopes": ["https://mail.google.com/"],
                "token_type": "Bearer",
            },
        )
        client = app.test_client()
        _login(client)
        with client.session_transaction() as sess:
            sess["postfach_oauth_state"] = "state-123"
            sess["postfach_oauth_verifier"] = "verifier-123"
            sess["postfach_oauth_account_id"] = account_id
            sess["postfach_oauth_provider"] = "google"
    
        res = client.get(
            "/postfach/accounts/oauth/callback?state=state-123&code=auth-code-123",
            follow_redirects=False,
        )
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:203: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,610 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9bd10b24d57a[REDACTED_PII]c3d21e687dbdf38
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,619 - kukanilea - INFO - GET /postfach/accounts/oauth/callback 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9bd10b24d57a40279c3d21e687dbdf38
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /postfach/accounts/oauth/callback 500
__________ test_postfach_send_requires_safety_ack_when_warnings_exist __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_postfach_send_requires_sa0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fb42c00>

    def test_postfach_send_requires_safety_ack_when_warnings_exist(
        tmp_path: Path, monkeypatch
    ) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="SMTP",
            imap_host="imap.example.com",
            imap_port=993,
            imap_username="sender@example.com",
            smtp_host="smtp.example.com",
            smtp_port=465,
            smtp_username="sender@example.com",
            smtp_use_ssl=True,
            secret_plain="secret",
        )
        draft_id = create_draft(
            db_path,
            tenant_id="KUKANILEA",
            account_id=account_id,
            thread_id=None,
            to_value="recipient@other-domain.com",
            subject_value="Angebot",
            body_value="Link: https://bit.ly/test und IBAN DE89370400440532013000",
        )
        client = app.test_client()
        _login(client)
        blocked = client.post(
            "/postfach/drafts/send",
            data={
                "draft_id": draft_id,
                "account_id": account_id,
                "thread_id": "",
                "user_confirmed": "1",
            },
            follow_redirects=True,
        )
>       assert blocked.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:255: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,712 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]a6505f48c[REDACTED_PII]ce16ff[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,721 - kukanilea - INFO - POST /postfach/drafts/send 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=209603a6505f48c28072ce16ff829028
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /postfach/drafts/send 500
____________________ test_permissions_manager_denies_office ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fe57650>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_permissions_manager_denie0')

    def test_permissions_manager_denies_office(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        _seed_user(app, username="office", role="OFFICE")
        client = app.test_client()
        _login(client, "office", "OPERATOR")
        res = client.get("/settings/permissions")
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:43,965 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b2ca[REDACTED_PII]f45a197eeb6ba6aa[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:43,975 - kukanilea - INFO - GET /settings/permissions 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b2ca3618923f45a197eeb6ba6aa28736
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings/permissions 500
_________________ test_permissions_manager_allows_owner_admin __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ff5bd70>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_permissions_manager_allow0')

    def test_permissions_manager_allows_owner_admin(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        client = app.test_client()
        _login(client, "owner", "ADMIN")
        res = client.get("/settings/permissions")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:63: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:44,063 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]f9922ac[REDACTED_PII]d972bb60e3126
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:44,072 - kukanilea - INFO - GET /settings/permissions 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=30394f9922ac4044847d972bb60e3126
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings/permissions 500
_________________________ test_dev_update_is_dev_only __________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110031d30>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_update_is_dev_only0')

    def test_dev_update_is_dev_only(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        _seed_user(app, username="dev", role="DEV")
        client = app.test_client()
    
        _login(client, "owner", "ADMIN")
        denied = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert denied.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:44,234 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=91f3f483b93a4aabbe52f32f5c9d206e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:44,243 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=91f3f483b93a4aabbe52f32f5c9d206e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
__________________ test_read_only_crm_endpoints_do_not_write ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_read_only_crm_endpoints_d0')

    def test_read_only_crm_endpoints_do_not_write(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        resp = client.post("/api/customers", json={"name": "Blocked"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_read_only_crm_api.py:31: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:44,544 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=f3a9a[REDACTED_PII]db42c[REDACTED_PII]cb[REDACTED_PII]d2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:44,545 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=f3a9a93880db42c38689cb82293676d2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/customers 500
_____________________ test_settings_available_for_operator _____________________

    def test_settings_available_for_operator():
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, "OPERATOR")
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_settings_and_open.py:19: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:45,890 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2a5b9fb4c[REDACTED_PII]fc8a40ae9171f7fa1f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:45,900 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2a5b9fb4c68844fc8a40ae9171f7fa1f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings 500
______________________ test_open_by_token_creates_pending ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_open_by_token_creates_pen0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ff3e180>

    def test_open_by_token_creates_pending(tmp_path, monkeypatch):
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, "ADMIN")
    
        sample = tmp_path / "doc.pdf"
        sample.write_text("sample")
        monkeypatch.setattr(
            web, "db_latest_path_for_doc", lambda doc_id, tenant_id="": str(sample)
        )
        monkeypatch.setattr(web, "analyze_to_pending", lambda path: "newtoken123")
    
        res = client.post("/api/open", json={"token": "abc123"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_settings_and_open.py:37: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:45,952 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b4c197d7584a4f4a85df32dc[REDACTED_PII]ea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:45,953 - kukanilea - INFO - POST /api/open 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b4c197d7584a4f4a85df32dc991746ea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/open 500
________________________ test_api_status_requires_login ________________________

    def test_api_status_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
    
        res = client.get("/api/status")
>       assert res.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:26: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:46,874 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=7c[REDACTED_PII]bb2db43d383a9e3f81de[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:46,875 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7c85472bb2db43d383a9e3f81de26841
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
__________________ test_api_status_reports_queue_and_running ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11030bd70>

    def test_api_status_reports_queue_and_running(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="DEV", username="status_dev")
        _reset_job_trackers()
    
        monkeypatch.setattr(
            webmod,
            "list_pending",
            lambda: [
                {"_token": "a", "status": "ANALYZING"},
                {"_token": "b", "status": "ERROR"},
                {"_token": "c", "status": "READY"},
            ],
        )
        monkeypatch.setattr(
            webmod,
            "_ocr_status_snapshot",
            lambda tenant_id: {
                "available": True,
                "pending": 2,
                "processing": 1,
                "failed_24h": 0,
                "last_event_at": "",
            },
        )
        webmod._job_tracker_start("index")
    
        res = client.get("/api/status")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:64: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:46,927 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a33cce[REDACTED_PII]d95a4480f87e60fcc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:46,928 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a33cce946042477d95a4480f87e60fcc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /api/status 500
______________________ test_dev_test_llm_updates_tracker _______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110a6e7b0>

    def test_dev_test_llm_updates_tracker(monkeypatch) -> None:
        class _FakeLLM:
            name = "fake-llm"
    
            def rewrite_query(self, q: str):
                return {"intent": "search", "query": q}
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="DEV", username="llm_dev")
        _reset_job_trackers()
    
        monkeypatch.setattr(webmod.ORCHESTRATOR, "llm", _FakeLLM(), raising=False)
    
        res = client.post("/api/dev/test-llm", json={"q": "rechnung 123"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:92: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,030 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=08c907d6b9dc[REDACTED_PII]ac5a9ffdf5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,031 - kukanilea - INFO - POST /api/dev/test-llm 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=08c907d6b9dc4046936116ac5a9ffdf5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/dev/test-llm 500
___________________ test_tags_page_and_assign_unassign_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tags_page_and_assign_unas0')

    def test_tags_page_and_assign_unassign_flow(tmp_path: Path) -> None:
        client = _client(tmp_path)
        note = knowledge_note_create("TENANT_A", "dev", "N1", "Body", "a")
        tag = tag_create("TENANT_A", "Alpha", actor_user_id="dev")
    
        page = client.get("/tags")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tags_web.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,592 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=17c43c1a6d8d[REDACTED_PII]c1331ceaee77df
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,602 - kukanilea - INFO - GET /tags 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=17c43c1a6d8d459388c1331ceaee77df
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /tags 500
_________________________ test_tags_read_only_blocked __________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tags_read_only_blocked0')

    def test_tags_read_only_blocked(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        resp = client.post(
            "/tags/create",
            data={"name": "Blocked", "color": "#112233"},
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tags_web.py:69: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,678 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]d[REDACTED_PII]bbb9b9bb[REDACTED_PII]d43
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,688 - kukanilea - INFO - POST /tags/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=595227d301124bbb9b9bb98241646d43
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /tags/create 500
____________________ test_tasks_kanban_create_and_move_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tasks_kanban_create_and_m0')

    def test_tasks_kanban_create_and_move_flow(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        create = client.post(
            "/api/tasks/create",
            json={
                "title": "Kanban Test Task",
                "task_type": "GENERAL",
                "severity": "INFO",
                "details": "sample",
            },
        )
>       assert create.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:42: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,762 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]aa25cd54bdb89ffc6a1aefeb110
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,763 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=48628aa25cd54bdb89ffc6a1aefeb110
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/tasks/create 500
____________________ test_tasks_read_only_blocks_mutations _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tasks_read_only_blocks_mu0')

    def test_tasks_read_only_blocks_mutations(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
        create = client.post("/api/tasks/create", json={"title": "Blocked Task"})
>       assert create.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:72: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,837 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=c5758a19e01a40a0b596ffddf062d7c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,838 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=c5758a19e01a40a0b596ffddf062d7c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/tasks/create 500
_____________________ test_tasks_tenant_isolation_on_move ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tasks_tenant_isolation_on0')

    def test_tasks_tenant_isolation_on_move(tmp_path: Path) -> None:
        _init_core(tmp_path)
        task_id = core.task_create(
            tenant="TENANT_A",
            severity="INFO",
            task_type="GENERAL",
            title="Tenant Task",
            details="x",
            created_by="seed",
        )
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_B"
    
        move = client.post(
            f"/api/tasks/{int(task_id)}/move",
            json={"column": "done"},
        )
>       assert move.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:99: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:47,918 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_B request_id=4e[REDACTED_PII]c2e4013a14de[REDACTED_PII]f695
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:47,918 - kukanilea - INFO - POST /api/tasks/1/move 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_B request_id=4e7591264c2e4013a14de3804065f695
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /api/tasks/1/move 500
___________ test_tenant_context_is_set_and_overrides_session_tenant ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110565ca0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_tenant_context_is_set_and0')

    def test_tenant_context_is_set_and_overrides_session_tenant(
        monkeypatch, tmp_path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="ADMIN", tenant_id="TENANT_EVASION")
    
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,099 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]ed226b4967abb1409e64ac7091
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,108 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d23172ed226b4967abb1409e64ac7091
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /settings 500
_________________ test_dev_can_edit_tenant_name_localhost_only _________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1100acf80>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_can_edit_tenant_name_0')

    def test_dev_can_edit_tenant_name_localhost_only(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
    
        res = client.post(
            "/dev/tenant",
            data={"tenant_name": "ACME Handwerk"},
            environ_overrides={"REMOTE_ADDR": "127.0.0.1"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:81: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,168 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=bc596c[REDACTED_PII]a030da684e20a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,178 - kukanilea - INFO - POST /dev/tenant 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=bc596c9803044272875a030da684e20a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /dev/tenant 500
___________ test_dev_tenant_override_forbidden_for_remote_or_non_dev ___________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110072810>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_tenant_override_forbi0')

    def test_dev_tenant_override_forbidden_for_remote_or_non_dev(
        monkeypatch, tmp_path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
    
        remote = client.get("/dev/tenant", environ_overrides={"REMOTE_ADDR": "10.0.0.9"})
>       assert remote.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:99: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,240 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=74a4e57b21ed4080ac47abdd9bcf7614
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,250 - kukanilea - INFO - GET /dev/tenant 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=74a4e57b21ed4080ac47abdd9bcf7614
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/tenant 500
______________________ test_shell_default_theme_is_light _______________________

    def test_shell_default_theme_is_light() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        auth_db = app.extensions["auth_db"]
        auth_db.set_user_preference("dev", "ui.theme", "light")
        client = app.test_client()
        _login(client)
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_theme_default.py:21: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,302 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]dd3e9a[REDACTED_PII]d948eabc009d9ea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,311 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b38557dd3e9a49069d948eabc009d9ea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
________________ test_default_theme_is_light_when_no_preference ________________

    def test_default_theme_is_light_when_no_preference() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_default_user")
    
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:20: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,643 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ef3ec9a4e4034e5f9c[REDACTED_PII]acaf6bf16
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,653 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ef3ec9a4e4034e5f9c30855acaf6bf16
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
__________________ test_theme_preference_loaded_from_auth_db ___________________

    def test_theme_preference_loaded_from_auth_db() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        auth_db = app.extensions["auth_db"]
        auth_db.set_user_preference("theme_dark_user", "ui.theme", "dark")
        client = app.test_client()
        _login(client, username="theme_dark_user")
    
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:33: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,705 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]b8548b[REDACTED_PII]cfb0d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,715 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f77220684b8548b381682cfb0d630533
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET / 500
_________________ test_theme_preference_route_persists_setting _________________

    def test_theme_preference_route_persists_setting() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_route_user")
    
        res = client.post("/settings/ui/theme", json={"theme": "dark"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:44: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,765 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=be7ec526c0dd49b6847d42db0b77ce7a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,775 - kukanilea - INFO - POST /settings/ui/theme 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=be7ec526c0dd49b6847d42db0b77ce7a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /settings/ui/theme 500
_______________ test_sidebar_preference_route_and_shell_default ________________

    def test_sidebar_preference_route_and_shell_default() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="sidebar_route_user")
    
        save = client.post("/settings/ui/sidebar", json={"collapsed": True})
>       assert save.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,887 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1d606edb2afd4c6f9aadc8f81de7dd29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,896 - kukanilea - INFO - POST /settings/ui/sidebar 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1d606edb2afd4c6f9aadc8f81de7dd29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /settings/ui/sidebar 500
____________________ test_theme_route_rejects_invalid_value ____________________

    def test_theme_route_rejects_invalid_value() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_invalid_user")
    
        res = client.post("/settings/ui/theme", json={"theme": "sepia"})
>       assert res.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:48,946 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=31b2db60f2974c368f9d25eba432ee15
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:48,956 - kukanilea - INFO - POST /settings/ui/theme 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=31b2db60f2974c368f9d25eba432ee15
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 POST /settings/ui/theme 500
___________________ test_dev_update_route_requires_dev_role ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11056bc80>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_update_route_requires0')

    def test_dev_update_route_requires_dev_role(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="ADMIN")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,027 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=793d1d1f9e1a40b8b6994cb78e5aafcc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,037 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=793d1d1f9e1a40b8b6994cb78e5aafcc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
___________________ test_dev_update_route_requires_localhost ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fef9a90>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_update_route_requires1')

    def test_dev_update_route_requires_localhost(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "10.0.0.8"})
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,096 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2319ea[REDACTED_PII]f[REDACTED_PII]ea55baa87f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,105 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2319ea92738740f0835229ea55baa87f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
_______________ test_dev_update_route_renders_for_dev_localhost ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110320830>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_dev_update_route_renders_0')

    def test_dev_update_route_renders_for_dev_localhost(
        monkeypatch, tmp_path: Path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,167 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ce00cf31c64f435caad8d869caa222b5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,176 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ce00cf31c64f435caad8d869caa222b5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
__________________ test_install_action_blocked_when_disabled ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fe1a0c0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_install_action_blocked_wh0')

    def test_install_action_blocked_when_disabled(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        page = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       csrf = _csrf_from_html(page.data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_update_routes.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

payload = b'<!doctype html>\n<html lang="de" data-theme="light">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content=... btn.dataset.q || \'\';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n</script>\n</body>\n</html>'

    def _csrf_from_html(payload: bytes) -> str:
        match = re.search(rb'name="csrf_token"\s+value="([^"]+)"', payload)
>       assert match is not None
E       assert None is not None

tests/test_update_routes.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,238 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2445eae1f82a4ea58eb[REDACTED_PII]c0eabaed
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,248 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2445eae1f82a4ea58eb23949c0eabaed
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
__________________ test_install_action_calls_update_pipeline ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fe9fbf0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_install_action_calls_upda0')

    def test_install_action_calls_update_pipeline(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        app.config["UPDATE_INSTALL_ENABLED"] = True
        app.config["UPDATE_INSTALL_TIMEOUT_SECONDS"] = 5
        client = app.test_client()
        _login(client, role="DEV")
    
        calls: list[str] = []
    
        def _fake_check(*args, **kwargs):
            calls.append("check")
            return {
                "checked": True,
                "update_available": True,
                "latest_version": "1.0.0-beta.2",
                "release_url": "https://example/release",
                "asset_name": "KUKANILEA.zip",
                "asset_url": "https://example/KUKANILEA.zip",
                "sha256": "a" * 64,
                "error": "",
            }
    
        def _fake_download(*args, **kwargs):
            calls.append("download")
            archive = tmp_path / "download.zip"
            archive.write_bytes(b"ZIP")
            return archive
    
        def _fake_install(*args, **kwargs):
            calls.append("install")
            return {
                "app_dir": str(tmp_path / "KUKANILEA.app"),
                "backup_dir": str(tmp_path / "KUKANILEA.app.backup"),
                "data_dir": str(tmp_path / "data"),
                "sha256": "a" * 64,
            }
    
        import app.web as webmod
    
        monkeypatch.setattr(webmod, "check_for_installable_update", _fake_check)
        monkeypatch.setattr(webmod, "download_update_asset", _fake_download)
        monkeypatch.setattr(webmod, "install_update_from_archive", _fake_install)
    
        page = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       csrf = _csrf_from_html(page.data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_update_routes.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

payload = b'<!doctype html>\n<html lang="de" data-theme="light">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content=... btn.dataset.q || \'\';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n</script>\n</body>\n</html>'

    def _csrf_from_html(payload: bytes) -> str:
        match = re.search(rb'name="csrf_token"\s+value="([^"]+)"', payload)
>       assert match is not None
E       assert None is not None

tests/test_update_routes.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,309 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=35a[REDACTED_PII]ef994d78b[REDACTED_PII]cd7d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,318 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=35a57557ef994d78b94756551875cd7d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /dev/update 500
________________ test_upgrade_smoke_automation_schema_and_page _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_upgrade_smoke_automation_0')

    def test_upgrade_smoke_automation_schema_and_page(tmp_path: Path) -> None:
        db_path = tmp_path / "legacy.sqlite3"
        _bootstrap_legacy_automation_schema(db_path)
    
        ensure_automation_schema(db_path)
    
        rule_columns = _table_columns(db_path, RULE_TABLE)
        assert "max_executions_per_minute" in rule_columns
    
        pending_columns = _table_columns(db_path, PENDING_ACTION_TABLE)
        assert "status" in pending_columns
        assert "confirm_token" in pending_columns
    
        con = sqlite3.connect(str(db_path), timeout=30)
        con.row_factory = sqlite3.Row
        try:
            index_rows = con.execute(
                "SELECT name FROM sqlite_master WHERE type='index' AND tbl_name=?",
                (PENDING_ACTION_TABLE,),
            ).fetchall()
            index_names = {str(row["name"]) for row in index_rows}
            assert (
                "idx_automation_builder_pending_actions_tenant_confirm_token" in index_names
            )
        finally:
            con.close()
    
        webmod.core.DB_PATH = db_path
        core.DB_PATH = db_path
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_upgrade.py:104: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,409 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9630d6464e6046b1b7b23fe7b6114f6c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,419 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9630d6464e6046b1b7b23fe7b6114f6c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /automation 500
________________________ test_workflows_requires_login _________________________

    def test_workflows_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.get("/workflows", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:37: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,520 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=9d95fff3996e4b69b108fa94a3d044fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,529 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=9d95fff3996e4b69b108fa94a3d044fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /workflows 500
_________________ test_workflow_template_install_is_idempotent _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_workflow_template_install0')

    def test_workflow_template_install_is_idempotent(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
    
        page = client.get("/workflows")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,580 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d66bb1b9d4341fe8164
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,590 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8422289596454d66bb1b9d4341fe8164
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /workflows 500
_______________ test_workflow_toggle_route_updates_enabled_flag ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-129/test_workflow_toggle_route_upd0')

    def test_workflow_toggle_route_updates_enabled_flag(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
    
        page = client.get("/workflows")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:83: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:25:49,663 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]cfb64cefa284b1a2ec3f9b20
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:25:49,673 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=35100730cfb64cefa284b1a2ec3f9b20
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:106 GET /workflows 500
=============================== warnings summary ===============================
kukanilea_app.py:40
  /Users/gensuminguyen/Tophandwerk/kukanilea-git/kukanilea_app.py:40: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/test_offline_proof.py::test_csp_header_enforces_offline_policy
tests/test_offline_proof.py::test_no_rogue_external_urls_in_rendered_html
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/starlette/templating.py:162: DeprecationWarning: The `name` is not the first parameter anymore. The first parameter should be the `Request` instance.
  Replace `TemplateResponse(name, {"request": request})` by `TemplateResponse(request, name)`.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/e2e/test_ai_chat.py::test_ai_chat_widget_with_mocked_orchestrator[chromium]
FAILED tests/e2e/test_ai_smoke.py::test_ai_status_and_chat_smoke_with_mock[chromium]
FAILED tests/e2e/test_crm.py::test_crm_customers_page_loads[chromium] - Asser...
FAILED tests/e2e/test_docs.py::test_knowledge_settings_page_loads[chromium]
FAILED tests/e2e/test_hardening_smoke.py::test_hardening_top_flows_smoke[chromium]
FAILED tests/e2e/test_hardening_smoke.py::test_hardening_error_shell_navigation[chromium]
FAILED tests/e2e/test_tasks.py::test_tasks_kanban_page_loads[chromium] - Asse...
FAILED tests/test_activation_kpi.py::test_api_tasks_create_records_first_task_milestone
FAILED tests/test_activation_kpi.py::test_api_insights_activation_is_tenant_scoped
FAILED tests/test_ai_chat.py::test_ai_chat_shortcut_suggestion - assert 'KI-V...
FAILED tests/test_ai_chat.py::test_ai_chat_unhandled_message - assert 'konnte...
FAILED tests/test_ai_routes.py::test_api_ai_status - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_modelpack_routes - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_chat_success - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_personal_memory_routes - assert 5...
FAILED tests/test_ai_routes.py::test_api_ai_confirm_tool_success - assert 500...
FAILED tests/test_ai_routes.py::test_api_ai_feedback_route - assert 500 == 200
FAILED tests/test_automation_confirm_replay.py::test_confirm_with_valid_token_succeeds
FAILED tests/test_automation_confirm_replay.py::test_confirm_replay_with_same_token_blocked
FAILED tests/test_automation_confirm_replay.py::test_confirm_with_wrong_token_fails
FAILED tests/test_automation_confirm_replay.py::test_confirm_without_token_fails
FAILED tests/test_automation_confirm_role_gate.py::test_pending_confirm_requires_admin_or_dev_role
FAILED tests/test_automation_csrf.py::test_automation_post_without_csrf_is_forbidden
FAILED tests/test_automation_csrf.py::test_automation_post_with_invalid_csrf_is_forbidden
FAILED tests/test_automation_csrf.py::test_automation_post_with_valid_csrf_is_allowed
FAILED tests/test_automation_dry_run.py::test_rule_simulation_creates_log_without_pending_actions
FAILED tests/test_automation_import_export.py::test_rule_export_and_safe_import
FAILED tests/test_automation_import_export.py::test_rule_import_supports_cron_email_send_and_webhook
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_invalid_cron_expression
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_cron_with_six_fields
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_email_draft_unknown_placeholder
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_webhook_outside_allowlist
FAILED tests/test_automation_read_only.py::test_run_now_blocked_in_read_only
FAILED tests/test_automation_token_leak.py::test_pending_token_not_exposed_in_query_or_eventlog
FAILED tests/test_automation_web.py::test_automation_builder_requires_login
FAILED tests/test_automation_web.py::test_automation_builder_toggle_rule - as...
FAILED tests/test_automation_web.py::test_automation_pending_confirm_requires_ack_and_confirms
FAILED tests/test_automation_web.py::test_automation_rule_detail_supports_cron_and_mail_actions
FAILED tests/test_automation_web.py::test_automation_rule_detail_rejects_invalid_email_templates
FAILED tests/test_autonomy_health_record.py::test_scan_history_is_recorded_and_visible_in_health
FAILED tests/test_autonomy_health_record.py::test_smoke_test_updates_status
FAILED tests/test_autonomy_log_rotation.py::test_rotate_logs_compresses_and_deletes_old_files
FAILED tests/test_autonomy_maintenance.py::test_run_backup_once_creates_backup_and_event
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_create_rotate_and_verify
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_read_only_blocks_file_ops
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_page_and_actions
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_actions_blocked_in_read_only
FAILED tests/test_autotag_web.py::test_autotag_pages_render - AssertionError:...
FAILED tests/test_autotag_web.py::test_autotag_create_read_only_blocked - ass...
FAILED tests/test_chat_api.py::test_chat_api_ok - assert 500 == 200
FAILED tests/test_chat_api.py::test_api_chat_requires_auth - assert 500 == 401
FAILED tests/test_chat_widget.py::test_chat_widget_present_for_authenticated_user
FAILED tests/test_chat_widget.py::test_chat_api_hx_request_returns_html_fragment
FAILED tests/test_collision_event_emitted.py::test_collision_event_emitted_on_claim_guard_block
FAILED tests/test_crm_customers.py::test_read_only_blocks_crm_mutation_route
FAILED tests/test_crm_tenant_isolation.py::test_api_tenant_isolation_customers
FAILED tests/test_crm_ui_read_only.py::test_crm_ui_shows_read_only_banner_and_disabled_controls
FAILED tests/test_crm_ui_routes.py::test_crm_pages_and_partials_return_200 - ...
FAILED tests/test_crm_ui_routes.py::test_crm_email_import_page_upload_flow - ...
FAILED tests/test_desktop_mode.py::test_run_native_desktop_bootstrap_flow - T...
FAILED tests/test_desktop_mode.py::test_run_native_desktop_raises_when_not_ready
FAILED tests/test_email_import_limits.py::test_oversize_eml_returns_413 - ass...
FAILED tests/test_email_import_limits.py::test_malformed_email_does_not_crash_and_truncates
FAILED tests/test_entity_links_panel_render.py::test_entity_links_panel_renders_sanitized_titles
FAILED tests/test_entity_links_web.py::test_entity_links_routes_create_list_delete
FAILED tests/test_entity_links_web.py::test_entity_links_read_only_returns_403
FAILED tests/test_error_content_negotiation.py::test_global_http_exception_honors_accept_json
FAILED tests/test_error_shell_navigation.py::test_web_404_uses_shell_with_back_reload_controls
FAILED tests/test_error_shell_navigation.py::test_navigation_is_persistent_and_minimizable_in_shell
FAILED tests/test_error_shell_navigation.py::test_api_404_returns_json_error_shape
FAILED tests/test_evidence_pack.py::test_evidence_pack_requires_auth - assert...
FAILED tests/test_evidence_pack.py::test_evidence_pack_lead_includes_request_ids_and_attachments
FAILED tests/test_evidence_pack.py::test_evidence_pack_tenant_isolation - ass...
FAILED tests/test_evidence_pack.py::test_evidence_pack_validation_error - ass...
FAILED tests/test_hardening_latency_bench.py::test_run_latency_suite_mock_mode_collects_percentiles
FAILED tests/test_hardening_security.py::test_unauthenticated_requests_are_denied_by_default
FAILED tests/test_hardening_security.py::test_low_role_is_denied_on_admin_endpoint
FAILED tests/test_hardening_security.py::test_cross_tenant_access_does_not_leak_data
FAILED tests/test_hardening_security.py::test_logout_invalidates_session - as...
FAILED tests/test_idle_timeout.py::test_idle_timeout_default_60_logout - asse...
FAILED tests/test_idle_timeout.py::test_idle_timeout_bounds_enforced - assert...
FAILED tests/test_idle_timeout.py::test_absolute_timeout_8h_logout - assert 5...
FAILED tests/test_intake_triage.py::test_intake_triage_invoice_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_support_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_unknown_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_validation - assert 50...
FAILED tests/test_intake_triage.py::test_intake_triage_requires_auth - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_event_contains_tenant
FAILED tests/test_knowledge_email_policy_default_deny.py::test_email_upload_denied_when_policy_off_and_no_rows_written
FAILED tests/test_knowledge_email_security_limits.py::test_oversize_upload_is_rejected
FAILED tests/test_knowledge_email_security_limits.py::test_subject_newline_sanitized
FAILED tests/test_knowledge_ics_limits.py::test_ics_oversize_upload_is_rejected
FAILED tests/test_knowledge_ics_policy_default_deny.py::test_ics_upload_denied_when_policy_off_and_no_rows_written
FAILED tests/test_knowledge_notes_crud.py::test_read_only_blocks_note_mutations_route
FAILED tests/test_lead_claims_template_safety.py::test_claim_panel_escapes_user_content
FAILED tests/test_lead_claims_web.py::test_claim_and_collision_guard_routes
FAILED tests/test_lead_claims_web.py::test_claim_endpoints_read_only_blocked
FAILED tests/test_lead_conversion.py::test_lead_conversion_creates_deal_quote_and_links
FAILED tests/test_lead_conversion.py::test_lead_conversion_blocked_when_claimed_by_other_user
FAILED tests/test_lead_conversion.py::test_lead_conversion_is_tenant_isolated
FAILED tests/test_lead_conversion.py::test_lead_conversion_read_only_blocked
FAILED tests/test_lead_guard_decorator_allows_owner.py::test_guard_allows_owner_mutation
FAILED tests/test_lead_guard_decorator_blocks_claimed.py::test_guard_blocks_non_owner_and_logs_collision
FAILED tests/test_lead_guard_decorator_read_only.py::test_guard_blocks_mutations_in_read_only_mode
FAILED tests/test_lead_intake_api.py::test_lead_api_read_only_blocks_all_new_posts
FAILED tests/test_lead_intake_api.py::test_lead_api_validation_and_tenant_isolation
FAILED tests/test_lead_intake_api.py::test_actor_user_id_written_to_event_payload
FAILED tests/test_lead_intake_api.py::test_xss_payload_is_escaped_in_ui - ass...
FAILED tests/test_lead_intake_api.py::test_ics_crlf_injection_is_sanitized - ...
FAILED tests/test_license_read_only.py::test_read_only_blocks_mutating_requests
FAILED tests/test_omni_web.py::test_conversations_pages_render - assert 500 =...
FAILED tests/test_omni_web.py::test_conversations_tenant_isolation - assert 5...
FAILED tests/test_onboarding.py::test_onboarding_seeding - AssertionError: as...
FAILED tests/test_postfach_web.py::test_postfach_page_renders - assert 500 ==...
FAILED tests/test_postfach_web.py::test_postfach_page_shows_key_warning_when_missing
FAILED tests/test_postfach_web.py::test_mail_route_redirects_to_postfach - as...
FAILED tests/test_postfach_web.py::test_postfach_account_add_fails_closed_without_key
FAILED tests/test_postfach_web.py::test_postfach_oauth_start_sets_session_and_redirects
FAILED tests/test_postfach_web.py::test_postfach_oauth_callback_saves_token
FAILED tests/test_postfach_web.py::test_postfach_send_requires_safety_ack_when_warnings_exist
FAILED tests/test_rbac_permissions.py::test_permissions_manager_denies_office
FAILED tests/test_rbac_permissions.py::test_permissions_manager_allows_owner_admin
FAILED tests/test_rbac_permissions.py::test_dev_update_is_dev_only - assert 5...
FAILED tests/test_read_only_crm_api.py::test_read_only_crm_endpoints_do_not_write
FAILED tests/test_settings_and_open.py::test_settings_available_for_operator
FAILED tests/test_settings_and_open.py::test_open_by_token_creates_pending - ...
FAILED tests/test_status_endpoint.py::test_api_status_requires_login - assert...
FAILED tests/test_status_endpoint.py::test_api_status_reports_queue_and_running
FAILED tests/test_status_endpoint.py::test_dev_test_llm_updates_tracker - ass...
FAILED tests/test_tags_web.py::test_tags_page_and_assign_unassign_flow - asse...
FAILED tests/test_tags_web.py::test_tags_read_only_blocked - assert 500 == 403
FAILED tests/test_tasks_kanban_web.py::test_tasks_kanban_create_and_move_flow
FAILED tests/test_tasks_kanban_web.py::test_tasks_read_only_blocks_mutations
FAILED tests/test_tasks_kanban_web.py::test_tasks_tenant_isolation_on_move - ...
FAILED tests/test_tenant_isolation.py::test_tenant_context_is_set_and_overrides_session_tenant
FAILED tests/test_tenant_isolation.py::test_dev_can_edit_tenant_name_localhost_only
FAILED tests/test_tenant_isolation.py::test_dev_tenant_override_forbidden_for_remote_or_non_dev
FAILED tests/test_theme_default.py::test_shell_default_theme_is_light - asser...
FAILED tests/test_ui_preferences.py::test_default_theme_is_light_when_no_preference
FAILED tests/test_ui_preferences.py::test_theme_preference_loaded_from_auth_db
FAILED tests/test_ui_preferences.py::test_theme_preference_route_persists_setting
FAILED tests/test_ui_preferences.py::test_sidebar_preference_route_and_shell_default
FAILED tests/test_ui_preferences.py::test_theme_route_rejects_invalid_value
FAILED tests/test_update_routes.py::test_dev_update_route_requires_dev_role
FAILED tests/test_update_routes.py::test_dev_update_route_requires_localhost
FAILED tests/test_update_routes.py::test_dev_update_route_renders_for_dev_localhost
FAILED tests/test_update_routes.py::test_install_action_blocked_when_disabled
FAILED tests/test_update_routes.py::test_install_action_calls_update_pipeline
FAILED tests/test_upgrade.py::test_upgrade_smoke_automation_schema_and_page
FAILED tests/test_workflows_web.py::test_workflows_requires_login - assert 50...
FAILED tests/test_workflows_web.py::test_workflow_template_install_is_idempotent
FAILED tests/test_workflows_web.py::test_workflow_toggle_route_updates_enabled_flag
152 failed, 453 passed, 1 skipped, 4 warnings in 83.64s (0:01:23)


STDERR:
