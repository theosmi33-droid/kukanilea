STDOUT:
........s............................................................... [ 11%]
........................................................................ [ 23%]
FFFFFF.......F.......................................................... [ 35%]
........................................................................ [ 47%]
........................................................................ [ 59%]
........................................................................ [ 71%]
........................................................................ [ 83%]
........................................................................ [ 95%]
..............................                                           [100%]
=================================== FAILURES ===================================
_____________ test_scan_history_is_recorded_and_visible_in_health ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_scan_history_is_recorded_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1102a3c50>

    def test_scan_history_is_recorded_and_visible_in_health(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        monkeypatch.setenv("KUKANILEA_ANONYMIZATION_KEY", "scan-test-key")
        knowledge_policy_update(
            "TENANT_A",
            actor_user_id="dev",
            allow_customer_pii=True,
            allow_documents=True,
        )
    
        docs = tmp_path / "docs"
        docs.mkdir(parents=True, exist_ok=True)
        (docs / "doc.txt").write_text("content", encoding="utf-8")
        source_watch_config_update("TENANT_A", documents_inbox_dir=str(docs), enabled=True)
    
        result = scan_sources_once("TENANT_A", actor_user_id="dev")
        assert int(result["ingested_ok"]) == 1
    
        overview = get_health_overview("TENANT_A", history_limit=10)
>       assert overview["scan_history"]
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'scan_history'

tests/test_autonomy_health_record.py:41: KeyError
________________________ test_smoke_test_updates_status ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_smoke_test_updates_status0')

    def test_smoke_test_updates_status(tmp_path: Path) -> None:
        _init_core(tmp_path)
        result = run_smoke_test("TENANT_A", actor_user_id="dev")
>       assert result["result"] in {"ok", "warn", "error"}
               ^^^^^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/test_autonomy_health_record.py:50: TypeError
______________ test_rotate_logs_compresses_and_deletes_old_files _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_rotate_logs_compresses_an0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1101d2e40>

    def test_rotate_logs_compresses_and_deletes_old_files(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        log_dir = tmp_path / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_dir))
    
        old_log = log_dir / "old.log"
        old_log.write_text("old", encoding="utf-8")
        old_gz = log_dir / "old.log.gz"
        old_gz.write_bytes(b"oldgz")
        fresh_log = log_dir / "fresh.log"
        fresh_log.write_text("fresh", encoding="utf-8")
    
        old_ts = time.time() - (40 * 24 * 3600)
        os.utime(old_log, (old_ts, old_ts))
        os.utime(old_gz, (old_ts, old_ts))
    
        result = rotate_logs("TENANT_A", actor_user_id="dev")
>       assert result["ok"] is True
               ^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/test_autonomy_log_rotation.py:40: TypeError
________________ test_run_backup_once_creates_backup_and_event _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_run_backup_once_creates_b0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11006d520>

    def test_run_backup_once_creates_backup_and_event(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        result = run_backup_once(tenant_id="TENANT_A", actor_user_id="dev")
>       assert result["ok"] is True
               ^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/test_autonomy_maintenance.py:25: TypeError
_____________________ test_backup_create_rotate_and_verify _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_backup_create_rotate_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1101d1a00>

    def test_backup_create_rotate_and_verify(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        tenant_dir = backup_root / "TENANT_A"
        tenant_dir.mkdir(parents=True, exist_ok=True)
        old_file = tenant_dir / "backup-old.sqlite"
        old_file.write_bytes(b"old")
        old_ts = time.time() - (10 * 24 * 3600)
        os.utime(old_file, (old_ts, old_ts))
    
        result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
>       assert result["ok"] is True
               ^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/test_autonomy_maintenance_backup.py:37: TypeError
____________________ test_backup_read_only_blocks_file_ops _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_backup_read_only_blocks_f0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1101d0590>

    def test_backup_read_only_blocks_file_ops(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        app = Flask(__name__)
        app.config["READ_ONLY"] = True
        with app.app_context():
            result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
>       assert result["ok"] is False
               ^^^^^^^^^^^^
E       TypeError: 'NoneType' object is not subscriptable

tests/test_autonomy_maintenance_backup.py:74: TypeError
____________________ test_autonomy_health_page_and_actions _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-142/test_autonomy_health_page_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1101d0110>

    def test_autonomy_health_page_and_actions(tmp_path: Path, monkeypatch) -> None:
        backup_root = tmp_path / "backups"
        log_root = tmp_path / "logs"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_root))
    
        client = _client(tmp_path, read_only=False)
        page = client.get("/autonomy/health")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autonomy_ui_health.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:35:05,028 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=f0f4b47a6d8245cca33b[REDACTED_PII]d28bf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 143, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 165, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/web.py", line 7504, in autonomy_health_page
    content = render_template(
              ^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/templating.py", line 150, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/templating.py", line 131, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 1295, in render
    self.environment.handle_exception()
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/templates/autonomy/health.html", line 23, in top-level template code
    {% include "autonomy/partials/_health_status.html" %}
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/templates/autonomy/partials/_health_status.html", line 17, in top-level template code
    <div class="text-xs muted mt-1">log_keep_days: {{ data.config.log_keep_days }}</div>
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 490, in getattr
    return getattr(obj, attribute)
           ^^^^^^^^^^^^^^^^^^^^^^^
jinja2.exceptions.UndefinedError: 'dict object' has no attribute 'config'
[REDACTED_PII] 23:35:05,041 - kukanilea - INFO - GET /autonomy/health 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:409 unhandled_exception tenant_id=TENANT_A request_id=f0f4b47a6d8245cca33b580216d28bf1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 917, in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 902, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 143, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/auth.py", line 165, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/web.py", line 7504, in autonomy_health_page
    content = render_template(
              ^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/templating.py", line 150, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/templating.py", line 131, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 1295, in render
    self.environment.handle_exception()
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/templates/autonomy/health.html", line 23, in top-level template code
    {% include "autonomy/partials/_health_status.html" %}
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/templates/autonomy/partials/_health_status.html", line 17, in top-level template code
    <div class="text-xs muted mt-1">log_keep_days: {{ data.config.log_keep_days }}</div>
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/jinja2/environment.py", line 490, in getattr
    return getattr(obj, attribute)
           ^^^^^^^^^^^^^^^^^^^^^^^
jinja2.exceptions.UndefinedError: 'dict object' has no attribute 'config'
INFO     kukanilea:__init__.py:116 GET /autonomy/health 500
=============================== warnings summary ===============================
kukanilea_app.py:40
  /Users/gensuminguyen/Tophandwerk/kukanilea-git/kukanilea_app.py:40: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/test_offline_proof.py::test_csp_header_enforces_offline_policy
tests/test_offline_proof.py::test_no_rogue_external_urls_in_rendered_html
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/starlette/templating.py:162: DeprecationWarning: The `name` is not the first parameter anymore. The first parameter should be the `Request` instance.
  Replace `TemplateResponse(name, {"request": request})` by `TemplateResponse(request, name)`.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_autonomy_health_record.py::test_scan_history_is_recorded_and_visible_in_health
FAILED tests/test_autonomy_health_record.py::test_smoke_test_updates_status
FAILED tests/test_autonomy_log_rotation.py::test_rotate_logs_compresses_and_deletes_old_files
FAILED tests/test_autonomy_maintenance.py::test_run_backup_once_creates_backup_and_event
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_create_rotate_and_verify
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_read_only_blocks_file_ops
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_page_and_actions
7 failed, 598 passed, 1 skipped, 4 warnings in 43.98s


STDERR:
