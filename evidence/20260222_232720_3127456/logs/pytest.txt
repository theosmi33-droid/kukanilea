STDOUT:
FFFFFFF.s..FF........FF........................................FFFFFF... [ 11%]
.........................FFFFFFFFFFFFFFF....F.........F..........FFFFF.. [ 23%]
FFFFFF.......FF.......FF....F.F.FFF......F....FFFF.........FF........... [ 35%]
.....................................................FF....F....FF...FFF [ 47%]
F........FFFF...F.FFFF.....FFF...FFFFFF.........F.FF....FF..F..........F [ 59%]
FFFFFFFF.FFFFFF..............F.......................................... [ 71%]
........................FFF.................................FFFFFFF..... [ 83%]
....FFF..F..................FF.........FFF.....FFFFF.FFFF............... [ 95%]
.....FFFFF.......FFFFF....FFFF                                           [100%]
=================================== FAILURES ===================================
____________ test_ai_chat_widget_with_mocked_orchestrator[chromium] ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10e8d6f00>
page = <Page url='http://127.0.0.1:50136/'>, base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_ai_chat_widget_with_mocked_orchestrator(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **_: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(webmod, "ollama_list_models", lambda **_: ["llama3.1:8b"])
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **_: {
                "status": "ok",
                "response": "Ich habe 1 Kontakt gefunden.",
                "conversation_id": "conv-e2e-1",
                "tool_used": ["search_contacts"],
            },
        )
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        page.goto(f"{base_url}/")
        _open_chat(page)
        page.wait_for_selector("#chatWidgetInput", state="visible")
>       assert page.locator("#chatWidgetSend").is_enabled()
E       AssertionError: assert False
E        +  where False = is_enabled()
E        +    where is_enabled = <Locator frame=<Frame name= url='http://127.0.0.1:50136/'> selector='#chatWidgetSend'>.is_enabled
E        +      where <Locator frame=<Frame name= url='http://127.0.0.1:50136/'> selector='#chatWidgetSend'> = locator('#chatWidgetSend')
E        +        where locator = <Page url='http://127.0.0.1:50136/'>.locator

tests/e2e/test_ai_chat.py:50: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:27:33,102 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:27:33,263 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:27:33,266 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=cefe1019e1fe4ee9a4a1acc2194af8b0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,269 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:33,270 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=08f[REDACTED_PII]b4f[REDACTED_PII]cfe7fc2ece56
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,271 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:33,272 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:27:33,287 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:33,308 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=ac7977c6a[REDACTED_PII]d993ed33cca8961d3e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,320 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:33,321 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=4eb1c5e64fce48f285c[REDACTED_PII]f[REDACTED_PII]b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,332 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:33,333 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e47e9b[REDACTED_PII]e[REDACTED_PII]d58f3b09d057c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,343 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:33,344 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=ba[REDACTED_PII]de6ad40ba[REDACTED_PII]d1a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,353 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:33,354 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d[REDACTED_PII]e35f7415e8a9e36a8732c84d4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,364 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:33,365 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:33,454 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:27:33,457 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=852f3f7a8fbd4f11a9e50b456adc28a4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,467 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:33,518 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:33,521 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]cf14ffb9d8df2050fab3c95
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,522 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:33,525 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f44f2aaf495f427c96a712b28e3c9689
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,526 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:33,528 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:33,539 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:33,541 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ac97e93ca[REDACTED_PII]d84d3da6588ff1f48
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,551 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:33,554 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8b5f5ef65e384c60a0e0aa5940f9f648
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,563 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:33,565 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5823da636ad[REDACTED_PII]b98b5b41f8639b76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,574 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:33,576 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=41d116acd5d54c78b49f89fb9d0df4c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,585 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:33,587 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=27ffb121b[REDACTED_PII]f89e685fdfe533f2be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:33,597 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:33,599 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:34,102 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0767eee[REDACTED_PII]b2a80bde[REDACTED_PII]eca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,125 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:34,179 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:34,183 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=92e53cfa71fb[REDACTED_PII]ee33c91dcf94a77
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,184 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:34,186 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=cd6cd52b17bd[REDACTED_PII]f48b48d6abdbae8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,187 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:34,189 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:34,197 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:34,200 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ab[REDACTED_PII]ece4702b9aad454b7a7b01f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,209 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:34,213 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]cfc6f[REDACTED_PII]b371a7071f78be11
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,224 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:34,227 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2d9379bb92f[REDACTED_PII]b07af68e728e97fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,240 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:34,243 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2d[REDACTED_PII]c649eb9744b26a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,254 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:34,257 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c983b[REDACTED_PII]e047ebbfb16a812fa[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,267 - kukanilea - INFO - GET /crm/emails/import 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=cefe1019e1fe4ee9a4a1acc2194af8b0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=08f40290526b4f078438cfe7fc2ece56
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=ac7977c6a60042d993ed33cca8961d3e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=4eb1c5e64fce48f285c52055f684261b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e47e9b37641e478886d58f3b09d057c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=ba91997de6ad40ba89931d1a15800890
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d716422e35f7415e8a9e36a8732c84d4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=852f3f7a8fbd4f11a9e50b456adc28a4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d63047309cf14ffb9d8df2050fab3c95
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f44f2aaf495f427c96a712b28e3c9689
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ac97e93ca768488d84d3da6588ff1f48
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8b5f5ef65e384c60a0e0aa5940f9f648
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5823da636ad34142b98b5b41f8639b76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=41d116acd5d54c78b49f89fb9d0df4c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=27ffb121b61346f89e685fdfe533f2be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:33] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0767eee181834911b2a80bde92233eca
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=92e53cfa71fb49248ee33c91dcf94a77
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=cd6cd52b17bd48748f48b48d6abdbae8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ab6479871ece4702b9aad454b7a7b01f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=95494cfc6f864411b371a7071f78be11
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2d9379bb92f74012b07af68e728e97fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2d71875340c649eb9744b26a65807652
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c983b49461e047ebbfb16a812fa71479
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
--------------------------- Captured stderr teardown ---------------------------
[REDACTED_PII] 23:27:34,271 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:34,278 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8501d0ad5e9e44b8bc5dfae902e90f0c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,279 - kukanilea - INFO - GET /api/ai/status 500
______________ test_ai_status_and_chat_smoke_with_mock[chromium] _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ebe0c50>
page = <Page url='http://127.0.0.1:50136/'>, base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_ai_status_and_chat_smoke_with_mock(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **_: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(webmod, "ollama_list_models", lambda **_: ["llama3.1:8b"])
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **kwargs: {
                "status": "ok",
                "response": f"Mock-Antwort fuer: {kwargs.get('user_message', '')}",
                "conversation_id": "conv-smoke-1",
                "tool_used": [],
            },
        )
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        status = page.request.get(f"{base_url}/api/ai/status")
>       assert status.ok
E       AssertionError: assert False
E        +  where False = <APIResponse url='http://127.0.0.1:50136/api/ai/status' status=500 status_text='INTERNAL SERVER ERROR'>.ok

tests/e2e/test_ai_smoke.py:55: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:27:34,370 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:27:34,470 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:27:34,472 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=c6d52a[REDACTED_PII]b2a4d88c10a7c2f5c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,473 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:34,474 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=df5228bab78e4c[REDACTED_PII]c9a1f44b7e947
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,475 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:34,477 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:27:34,489 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:34,497 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=b[REDACTED_PII]e430d3493e888a64ab[REDACTED_PII]dae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,507 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:34,509 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=ff9cc0fed[REDACTED_PII]a97c[REDACTED_PII]f[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,521 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:34,521 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=f6ce8c1f55cd46b8ab409ea575c9984a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,531 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:34,532 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=feb[REDACTED_PII]f6f74b95a777a04ae078ad73
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,541 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:34,542 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=28bf[REDACTED_PII]a484e9f2902e3ac[REDACTED_PII]e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,551 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:34,552 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:34,633 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:27:34,636 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ccfe5f7fb32d49e9a[REDACTED_PII]c7802b8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,646 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:34,694 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:34,697 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]bcc[REDACTED_PII]eea0f96c251c7b7fe7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,698 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:34,700 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9d12ff[REDACTED_PII]f4268adcbc3c4e4a94a76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,701 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:34,703 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:34,711 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:34,713 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2ff4b392fcd449ccabbde1ebe4bd6f95
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,723 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:34,726 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=383e9d[REDACTED_PII]e381dd6db9dc3220a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,735 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:34,737 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=207da7aec7824b3f91d770e5cf7a9b1a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,747 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:34,748 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=cdf[REDACTED_PII]eae9d17ccb1c53d6379
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,758 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:34,759 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=cdadb3b1c32e4be3a585a8b7865aa18e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:34,768 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:34,770 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:49,700 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=003f[REDACTED_PII]f457f98f4e[REDACTED_PII]c13f8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,703 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:49,708 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=094ca[REDACTED_PII]d7c916cd7d621ccd892
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,710 - kukanilea - INFO - GET /api/ai/status 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=c6d52a89463142b2a4d88c10a7c2f5c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=df5228bab78e4c40931c9a1f44b7e947
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=b29336e430d3493e888a64ab93931dae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=ff9cc0fed411446a97c9610796f41010
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=f6ce8c1f55cd46b8ab409ea575c9984a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=feb60641f6f74b95a777a04ae078ad73
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=28bf2107868a484e9f2902e3ac39467e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ccfe5f7fb32d49e9a76109301c7802b8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d56656bcc73249eea0f96c251c7b7fe7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9d12ff61594f4268adcbc3c4e4a94a76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2ff4b392fcd449ccabbde1ebe4bd6f95
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=383e9d35228148e381dd6db9dc3220a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=207da7aec7824b3f91d770e5cf7a9b1a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=cdf4282033104eae9d17ccb1c53d6379
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=cdadb3b1c32e4be3a585a8b7865aa18e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:34] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=003f2773118f457f98f4e411916c13f8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=094ca93988004d7c916cd7d621ccd892
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
___________________ test_crm_customers_page_loads[chromium] ____________________

page = <Page url='http://127.0.0.1:50136/crm/customers'>
base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_crm_customers_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/crm/customers")
>       nav.expect_text("CRM · Kunden")

tests/e2e/test_crm.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10ecc0980>
text = 'CRM · Kunden'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:27:49,799 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:27:49,902 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:27:49,903 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=9739fd41c6ad414ab9e30fe6b105b697
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,904 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:49,906 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=55aa3a6f722e4fcbac8def5fe[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,907 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:49,909 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:27:49,919 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:49,925 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=39de25ff7ffe40e9896e26f24f38ecea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,934 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:49,936 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=3ce7868a8daf4c9f9b8dc154a48b3b66
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,948 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:49,949 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=570cf14a7dc84f67b218dd70e2dbe262
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,959 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:49,959 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=6617ef0fd6324b[REDACTED_PII]b09e4901f3bc4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,968 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:49,970 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=d347ff04cb8d4048ba[REDACTED_PII]c33f6cbbd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:49,978 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:49,980 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:50,071 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:27:50,074 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b4ec47f5ea7947da80c3dab22ce[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,084 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:50,133 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:50,136 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c[REDACTED_PII]c[REDACTED_PII]da91ab[REDACTED_PII]c0be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,136 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:50,138 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fa[REDACTED_PII]b3b49da[REDACTED_PII]d985b8803
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,139 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:50,141 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:50,151 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:50,154 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c7e[REDACTED_PII]d84d7bb[REDACTED_PII]ee572c558b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,163 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:50,166 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]c806e84e[REDACTED_PII]ccad4d776c640
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,175 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:50,177 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=77b3e2259db14dcf9f2028a7974e3947
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,186 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:50,187 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=77a337b39ab347a392c[REDACTED_PII]df85f3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,197 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:50,199 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]dc[REDACTED_PII]a[REDACTED_PII]a0995
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,208 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:50,209 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:50,719 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=985ab1624bd547d693b7d4e56e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,742 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:50,801 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:50,803 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a62a16e9a7ef4239ac7c687b9c0105d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,804 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:50,806 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f3ea[REDACTED_PII]f472ba63b8bc68d7b39dc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,807 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:50,809 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:50,817 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:50,819 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=960a09cd2e[REDACTED_PII]bff390a3378f79dc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,828 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:50,832 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=661ada728c2949f2b[REDACTED_PII]d67a[REDACTED_PII]e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,842 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:50,844 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=cb[REDACTED_PII]ce1b741d[REDACTED_PII]aa47f59f4e4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,852 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:50,854 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ec864f349c2d[REDACTED_PII]d2404f27e6edb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,863 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:50,865 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=eac9eabb7d5a49cc817e1fac2b36aa07
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:50,874 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:50,876 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=9739fd41c6ad414ab9e30fe6b105b697
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=55aa3a6f722e4fcbac8def5fe2177368
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=39de25ff7ffe40e9896e26f24f38ecea
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=3ce7868a8daf4c9f9b8dc154a48b3b66
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=570cf14a7dc84f67b218dd70e2dbe262
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=6617ef0fd6324b04826b09e4901f3bc4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=d347ff04cb8d4048ba71898c33f6cbbd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:49] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b4ec47f5ea7947da80c3dab22ce16711
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c565604c2158449da91ab3687634c0be
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fa2671781b3b49da8473049d985b8803
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c7e5146317d84d7bb01938ee572c558b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=406591c806e84e69840ccad4d776c640
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=77b3e2259db14dcf9f2028a7974e3947
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=77a337b39ab347a392c9296835df85f3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=14883100dc09490698a49013859a0995
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=985ab1624bd547d693b7d4e56e489634
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a62a16e9a7ef4239ac7c687b9c0105d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f3ea1564717f472ba63b8bc68d7b39dc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=960a09cd2e964064bff390a3378f79dc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=661ada728c2949f2b42913d67a34747e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=cb58925ce1b741d787166aa47f59f4e4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ec864f349c2d4254823d2404f27e6edb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=eac9eabb7d5a49cc817e1fac2b36aa07
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:50] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
_________________ test_knowledge_settings_page_loads[chromium] _________________

page = <Page url='http://127.0.0.1:50136/knowledge/settings'>
base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_knowledge_settings_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/knowledge/settings")
>       nav.expect_text("Knowledge · Einstellungen")

tests/e2e/test_docs.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10ed62b70>
text = 'Knowledge · Einstellungen'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:27:51,455 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:27:51,556 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:27:51,557 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5855c973caa24f21a50ec9bf187bcd47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,558 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:51,559 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=71d8e9470e9d4c5b84a2c074ce580c81
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,560 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:51,562 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:27:51,598 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:51,604 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]b7c[REDACTED_PII]fb9dc[REDACTED_PII]ec1c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,614 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:51,616 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]a9cfad4e70be88e[REDACTED_PII]d1e4c4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,625 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:51,626 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]a9af04b05b72ff[REDACTED_PII]a197fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,635 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:51,636 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5d35a0d2c68d4a34a67d8eb9584a555e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,645 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:51,647 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=068de6098c294ff5aec20ef[REDACTED_PII]ff
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,657 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:51,657 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:51,732 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:27:51,735 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=ffa461f97e[REDACTED_PII]e9568d8efd[REDACTED_PII]e8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,745 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:51,793 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:51,795 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3a884f6f5d1d4e09abbeba2e74c73d88
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,797 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:51,799 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b1ba62db[REDACTED_PII]b57b2dfdfe59fb7a39e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,800 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:51,802 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:51,810 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:51,812 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c152e09cd[REDACTED_PII]b2878e186ff53b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,822 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:51,824 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=718ff9c[REDACTED_PII]d40baf2e9e052fb17e1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,834 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:51,836 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a949cae[REDACTED_PII]a[REDACTED_PII]e4066f7f8f3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,845 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:51,847 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e[REDACTED_PII]e355b54bbca48f[REDACTED_PII]d479
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,856 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:51,857 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=39f1fc601eaf4d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:51,867 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:51,868 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:52,377 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6ea8c55a[REDACTED_PII]a3b[REDACTED_PII]fd6f182
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,400 - kukanilea - INFO - GET /knowledge/settings 500
[REDACTED_PII] 23:27:52,461 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:52,464 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=86a859da0bdb[REDACTED_PII]cae[REDACTED_PII]cd1c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,465 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:52,467 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=07f8ab523f864ba[REDACTED_PII]eb[REDACTED_PII]e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,468 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:52,470 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:52,477 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:52,479 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fe59eadae06b4f[REDACTED_PII]a95d7839d209
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,489 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:52,492 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1b8a662dbde548e28b[REDACTED_PII]b76fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,501 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:52,503 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=5d0d553b8c4b4075beba4b8c270e5c65
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,512 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:52,513 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8ae7f3c[REDACTED_PII]cb132fd[REDACTED_PII]ed281
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,523 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:52,525 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d6490f555ba[REDACTED_PII]c8017c1294ff56
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:52,534 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:52,535 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5855c973caa24f21a50ec9bf187bcd47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=71d8e9470e9d4c5b84a2c074ce580c81
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=4473862b7c80452fb9dc9555830ec1c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=048168a9cfad4e70be88e02106d1e4c4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7430981a9af04b05b72ff02638a197fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5d35a0d2c68d4a34a67d8eb9584a555e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=068de6098c294ff5aec20ef4868897ff
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=ffa461f97e63423e9568d8efd03653e8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3a884f6f5d1d4e09abbeba2e74c73d88
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b1ba62db42704b57b2dfdfe59fb7a39e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c152e09cd270478196b2878e186ff53b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=718ff9c784574d40baf2e9e052fb17e1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a949cae905644a7788276e4066f7f8f3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e87945e355b54bbca48f95884228d479
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=39f1fc601eaf4d368950478595296099
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:51] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6ea8c55a75994974a3b584325fd6f182
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /knowledge/settings 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /knowledge/settings HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=86a859da0bdb44838cae5690677cd1c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=07f8ab523f864ba287639987eb88320e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fe59eadae06b4f058179a95d7839d209
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1b8a662dbde548e28b133005514b76fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5d0d553b8c4b4075beba4b8c270e5c65
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8ae7f3c97813470cb132fd72075ed281
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d6490f555ba9478684c8017c1294ff56
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:52] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
___________________ test_hardening_top_flows_smoke[chromium] ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ed61d00>
page = <Page url='http://127.0.0.1:50136/crm/customers'>
base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_hardening_top_flows_smoke(
        monkeypatch: pytest.MonkeyPatch,
        page,
        base_url: str,
    ) -> None:
        _ensure_artifact_dir()
        request_ids = _attach_request_id_collector(page)
    
        # Keep AI deterministic and verify graceful handling on provider-down behavior.
        # The widget disables input when status endpoint reports unavailable, so keep
        # availability true and force an error response from chat processing instead.
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **_: True)
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **_: {
                "status": "error",
                "response": "Provider unavailable, fallback pending.",
                "conversation_id": "conv-hardening-e2e-1",
                "tool_used": [],
            },
        )
    
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        # 1) Login
        login.goto()
        login.login("e2e_admin", "e2e_admin")
        page.screenshot(path=str(ARTIFACT_DIR / "flow-login.png"), full_page=True)
    
        # 2) CRM: create/search/open
        nav.open("/crm/customers")
        customer_name = "Smoke Customer 2026"
>       page.fill("#createCustomerForm input[name='name']", customer_name)

tests/e2e/test_hardening_smoke.py:90: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/sync_api/_generated.py:10177: in fill
    self._sync(
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_page.py:893: in fill
    return await self._main_frame.fill(**locals_to_params(locals()))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_frame.py:607: in fill
    await self._fill(**locals_to_params(locals()))
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_frame.py:619: in _fill
    await self._channel.send("fill", self._timeout, locals_to_params(locals()))
../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_connection.py:69: in send
    return await self._connection.wrap_api_call(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <playwright._impl._connection.Connection object at 0x10e8d6ae0>
cb = <function Channel.send.<locals>.<lambda> at 0x10ee2fe20>
is_internal = False, title = None

    async def wrap_api_call(
        self, cb: Callable[[], Any], is_internal: bool = False, title: str = None
    ) -> Any:
        if self._api_zone.get():
            return await cb()
        task = asyncio.current_task(self._loop)
        st: List[inspect.FrameInfo] = getattr(
            task, "__pw_stack__", None
        ) or inspect.stack(0)
    
        parsed_st = _extract_stack_trace_information_from_stack(st, is_internal, title)
        self._api_zone.set(parsed_st)
        try:
            return await cb()
        except Exception as error:
>           raise rewrite_error(error, f"{parsed_st['apiName']}: {error}") from None
E           playwright._impl._errors.TimeoutError: Page.fill: Timeout 30000ms exceeded.
E           Call log:
E             - waiting for locator("#createCustomerForm input[name='name']")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/playwright/_impl/_connection.py:559: TimeoutError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:27:53,153 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:27:53,254 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:27:53,256 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=b0d[REDACTED_PII]a4b[REDACTED_PII]b6b96baa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,257 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:53,258 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=064e48f1ac8d49c0a071a417c76be1d3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,259 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:53,261 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:27:53,264 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:53,271 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=03e[REDACTED_PII]c5934e108c28b1b7f3e5c958
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,281 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:53,283 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=be29fc2d[REDACTED_PII]c8801cd2e6b23d1ae5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,294 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:53,296 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=fa08deecc7bd41d4badf56fdd9bbc6a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,306 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:53,307 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=4a[REDACTED_PII]a8fe[REDACTED_PII]c70cd14ce153d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,316 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:53,317 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=2c6c[REDACTED_PII]f1c[REDACTED_PII]a2f[REDACTED_PII]d7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,327 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:53,327 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:53,416 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:27:53,418 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=bbc64f2df72d43dbacdf70c27f[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,428 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:53,477 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:53,481 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0ab98a7ee19a4286b1098ee1d[REDACTED_PII]e7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,482 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:53,484 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]ecbf[REDACTED_PII]c562ac9c4714a1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,485 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:53,487 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:53,494 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:53,497 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]b4ad76c4a7c89f3f7641f25d2c9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,506 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:53,509 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e354f7440d4b439d9b022d[REDACTED_PII]d880
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,518 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:53,520 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3b31c85ed3954eccbacc8b[REDACTED_PII]d3497
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,529 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:53,531 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]aa[REDACTED_PII]a0d0de61abd822
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,540 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:53,542 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=83d[REDACTED_PII]b6ba49c4bcd[REDACTED_PII]a13c6f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:53,551 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:53,553 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:27:54,138 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b2896df645c3436b903dec44bc0e3848
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,149 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:54,194 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:27:54,197 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=94cb76a3846e4556ab3600f33f13a28b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,198 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:27:54,200 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=03b979fcc3ff4f94b404bcd5f4ea0a14
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,201 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:27:54,203 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:27:54,210 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:27:54,212 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9f07b233da[REDACTED_PII]b9ecd[REDACTED_PII]d1adf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,222 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:27:54,225 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3ac2affb243f466fa5bdc2b2a8a73fbf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,235 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:27:54,237 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=97aeaaf22bb846a0979baeaed[REDACTED_PII]e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,246 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:27:54,247 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d0cb947c6f[REDACTED_PII]ea67d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,257 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:27:54,258 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=877dedf[REDACTED_PII]f9f1d06ef6e3359de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:27:54,267 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:27:54,269 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:28:09,196 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d97ef5a[REDACTED_PII]e3952c5584c105e031
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:09,199 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:24,199 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2acd13a739bd409ab181d05f6d929d0b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:24,202 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=b0d23352a4b2488996106286b6b96baa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=064e48f1ac8d49c0a071a417c76be1d3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=03e17220c5934e108c28b1b7f3e5c958
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=be29fc2d858843c8801cd2e6b23d1ae5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=fa08deecc7bd41d4badf56fdd9bbc6a0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=4a271152a8fe4577831c70cd14ce153d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=2c6c90095f1c422290a2f047230530d7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=bbc64f2df72d43dbacdf70c27f67394d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0ab98a7ee19a4286b1098ee1d95693e7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f2620020ecbf416399c562ac9c4714a1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=80347b4ad76c4a7c89f3f7641f25d2c9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e354f7440d4b439d9b022d030672d880
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3b31c85ed3954eccbacc8b85012d3497
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b96394053aa6406989a0d0de61abd822
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=83d30834b6ba49c4bcd8166049a13c6f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:53] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b2896df645c3436b903dec44bc0e3848
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=94cb76a3846e4556ab3600f33f13a28b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=03b979fcc3ff4f94b404bcd5f4ea0a14
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9f07b233da02418b9ecd0405627d1adf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3ac2affb243f466fa5bdc2b2a8a73fbf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=97aeaaf22bb846a0979baeaed610440e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d0cb947c6f83430481ea67d636826937
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=877dedf52831412f9f1d06ef6e3359de
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:27:54] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d97ef5a9001943e3952c5584c105e031
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:09] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2acd13a739bd409ab181d05f6d929d0b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:24] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
_______________ test_hardening_error_shell_navigation[chromium] ________________

page = <Page url='http://127.0.0.1:50136/does-not-exist-hardening'>
base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_hardening_error_shell_navigation(page, base_url: str) -> None:
        _ensure_artifact_dir()
    
        login = LoginPage(page, base_url)
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        page.goto(f"{base_url}/does-not-exist-hardening")
        page.wait_for_load_state("networkidle")
    
        body = page.locator("body").text_content() or ""
>       assert "Fehler 404" in body
E       assert 'Fehler 404' in "\n\n  \n  \n    \n      \n        ✦\n        \n          KUKANILEA\n          Agent Orchestra\n        \n      \n    ....input) _cw.input.value = btn.dataset.q || '';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n\n\n"

tests/e2e/test_hardening_smoke.py:185: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:24,954 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:28:25,059 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:28:25,060 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=64b1e9d7b2394f6ca50ecdd[REDACTED_PII]df
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,062 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:25,063 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=[REDACTED_PII]a9201cd4cc592c3ac664ab93bdd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,064 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:25,065 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:28:25,074 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:25,081 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e6eac2bfb2bc[REDACTED_PII]d2d71caf4d73ee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,090 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:25,092 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=7677d5c1d8de44abadaae8dfaee0963b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,104 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:25,105 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=7a8b445ffa2e4568a9c92be[REDACTED_PII]e506
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,115 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:25,116 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=39e36bf95feb4321ac3cd44b[REDACTED_PII]a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,126 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:25,127 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=c2cebe4cfcc343f[REDACTED_PII]e6c3bf77d64d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,137 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:25,138 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:28:25,222 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:28:25,225 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b1d2c[REDACTED_PII]f4655b18f253e399da147
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,235 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:25,284 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:28:25,287 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e673fc3e9c4b4299bf68e33d98cca7ae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,288 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:25,290 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=15fbca2e8a[REDACTED_PII]e6503b836f575e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,290 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:25,293 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:25,303 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:28:25,305 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6c84b8be4f594d67ac[REDACTED_PII]d9d875ec5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,315 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:25,318 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=df87f6ccbe8a46cda675f7b4f8a0de57
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,327 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:25,329 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]a64e9ba[REDACTED_PII]e[REDACTED_PII]fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,338 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:25,340 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=33ca8c01debf4bdb82c46be435ff8a9e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,349 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:25,350 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c[REDACTED_PII]e617c47c2a9edc[REDACTED_PII]bb30c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,359 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:25,361 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:28:25,868 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f3ab3380aaab[REDACTED_PII]b9f[REDACTED_PII]d3cdf0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,889 - kukanilea - INFO - GET /does-not-exist-hardening 500
[REDACTED_PII] 23:28:25,948 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:28:25,950 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]cefa24cc9885d38fa9fd1144f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,951 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:25,953 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b36b567f4a3f4381b195b2c0be0cf3af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,954 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:25,956 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:25,964 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:28:25,967 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=44ba86ee913d418fbb2c71d08f36d0e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,976 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:25,979 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6c9e[REDACTED_PII]db4c779a65e5b65afc8c20
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,988 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:25,990 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]af385e4f8f[REDACTED_PII]ccef7f7515e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:25,998 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:26,000 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=83de5b6b75f94c94b51cd98dda8a8f5d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,010 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:26,011 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]fb[REDACTED_PII]aa9b475a[REDACTED_PII]eee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,020 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:26,022 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:24] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:24] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:24] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=64b1e9d7b2394f6ca50ecdd7017522df
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=52129a9201cd4cc592c3ac664ab93bdd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e6eac2bfb2bc480688d2d71caf4d73ee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7677d5c1d8de44abadaae8dfaee0963b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=7a8b445ffa2e4568a9c92be01089e506
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=39e36bf95feb4321ac3cd44b1718697a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=c2cebe4cfcc343f68473e6c3bf77d64d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b1d2c851962f4655b18f253e399da147
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e673fc3e9c4b4299bf68e33d98cca7ae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=15fbca2e8a9240228e6503b836f575e3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6c84b8be4f594d67ac30645d9d875ec5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=df87f6ccbe8a46cda675f7b4f8a0de57
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b349648973a64e9ba21831e0228787fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=33ca8c01debf4bdb82c46be435ff8a9e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c015973e617c47c2a9edc75299bb30c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f3ab3380aaab46648b9f890563d3cdf0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /does-not-exist-hardening 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /does-not-exist-hardening HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b302471cefa24cc9885d38fa9fd1144f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b36b567f4a3f4381b195b2c0be0cf3af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=44ba86ee913d418fbb2c71d08f36d0e2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6c9e600160db4c779a65e5b65afc8c20
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=677581af385e4f8f98066ccef7f7515e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:25] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=83de5b6b75f94c94b51cd98dda8a8f5d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=12838fb727824928aa9b475a32219eee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
____________________ test_tasks_kanban_page_loads[chromium] ____________________

page = <Page url='http://127.0.0.1:50136/tasks'>
base_url = 'http://127.0.0.1:50136'

    @pytest.mark.e2e
    def test_tasks_kanban_page_loads(page, base_url: str) -> None:
        login = LoginPage(page, base_url)
        nav = NavigationPage(page, base_url)
    
        login.goto()
        login.login("e2e_admin", "e2e_admin")
    
        nav.open("/tasks")
>       nav.expect_text("Tasks Kanban")

tests/e2e/test_tasks.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <e2e.pages.navigation_page.NavigationPage object at 0x10afb10a0>
text = 'Tasks Kanban'

    def expect_text(self, text: str) -> None:
>       assert self.page.locator("body").text_content() and text in str(
            self.page.locator("body").text_content()
        )
E       AssertionError

tests/e2e/pages/navigation_page.py:16: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:26,615 - kukanilea - INFO - GET /login 200
[REDACTED_PII] 23:28:26,715 - kukanilea - INFO - GET /api/health/live 401
[REDACTED_PII] 23:28:26,716 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e12aff[REDACTED_PII]fb8c[REDACTED_PII]a49a4f62
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,718 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:26,718 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=08c4cad61d544d3b9f9acb02a700b5cf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,719 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:26,721 - kukanilea - INFO - GET /api/health/ready 401
[REDACTED_PII] 23:28:26,730 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:26,736 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=9b0e46d0b[REDACTED_PII]bab[REDACTED_PII]c8635e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,746 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:26,749 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=df570b4a39c9421e8190c8ceb[REDACTED_PII]f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,761 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:26,762 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=17cbd9b8e65a45c0aa[REDACTED_PII]c29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,772 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:26,773 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=0d7f5d[REDACTED_PII]d40bfbcce[REDACTED_PII]d72b17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,783 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:26,783 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=c0a[REDACTED_PII]f264f9680e1482e34dcdf11
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,792 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:26,793 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:28:26,866 - kukanilea - INFO - POST /login 302
[REDACTED_PII] 23:28:26,869 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]ddefb4acaa7e2ea4afe671ff6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,879 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:26,928 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:28:26,930 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7c8a0d8724e64e[REDACTED_PII]d[REDACTED_PII]c0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,931 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:26,933 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=9410fd18c[REDACTED_PII]cc938c344e7bb4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,934 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:26,936 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:26,944 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:28:26,946 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=65ba1f286aea47af97d6bcdee7b311ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,955 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:26,959 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1d0aab[REDACTED_PII]a8f2e114b4a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,968 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:26,970 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3f4d[REDACTED_PII]b0f4c2aa[REDACTED_PII]e3173b5918
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,979 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:26,981 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=66fd9aec1cb14c098a7d[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:26,990 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:26,992 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]a6dc9e46b7983be[REDACTED_PII]da1a58
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,000 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:27,002 - kukanilea - INFO - GET /app.webmanifest 200
[REDACTED_PII] 23:28:27,507 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1f[REDACTED_PII]d93e740a8877afeb07e3e09b1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,530 - kukanilea - INFO - GET /tasks 500
[REDACTED_PII] 23:28:27,586 - kukanilea - INFO - GET /api/health/live 200
[REDACTED_PII] 23:28:27,588 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3424a25fadef[REDACTED_PII]e53c3b1867
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,589 - kukanilea - INFO - GET /api/status 500
[REDACTED_PII] 23:28:27,591 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6a4e900f228d494e8c3b1ad[REDACTED_PII]c7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,592 - kukanilea - INFO - GET /api/ai/status 500
[REDACTED_PII] 23:28:27,594 - kukanilea - INFO - GET /sw.js 200
[REDACTED_PII] 23:28:27,602 - kukanilea - INFO - GET /api/health/ready 503
[REDACTED_PII] 23:28:27,605 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1b8c137c97af42f89e589c43eb3fc431
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,614 - kukanilea - INFO - GET / 500
[REDACTED_PII] 23:28:27,617 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]ff334eab8dc1953a32c83a47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,626 - kukanilea - INFO - GET /crm/deals 500
[REDACTED_PII] 23:28:27,628 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d885a[REDACTED_PII]f51a253e3816a19df15
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,637 - kukanilea - INFO - GET /crm/customers 500
[REDACTED_PII] 23:28:27,638 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=798d859c8d134c[REDACTED_PII]e413bc5f6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,648 - kukanilea - INFO - GET /crm/quotes 500
[REDACTED_PII] 23:28:27,650 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=db[REDACTED_PII]ce896d5c05aa26e2158
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:27,659 - kukanilea - INFO - GET /crm/emails/import 500
[REDACTED_PII] 23:28:27,660 - kukanilea - INFO - GET /app.webmanifest 200
------------------------------ Captured log call -------------------------------
INFO     kukanilea:__init__.py:116 GET /login 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /login HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /static/css/fonts.css HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /static/vendor/tailwindcss.min.js HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /static/fonts/inter/InterVariable.woff2 HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[31m[1mGET /api/health/live HTTP/1.1[0m" 401 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e12aff072174446fb8c22353a49a4f62
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=08c4cad61d544d3b9f9acb02a700b5cf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 401
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[31m[1mGET /api/health/ready HTTP/1.1[0m" 401 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /sw.js HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=9b0e46d0b0854655bab597373c8635e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=df570b4a39c9421e8190c8ceb857666f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=17cbd9b8e65a45c0aa83603340368c29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=0d7f5d84754d40bfbcce854827d72b17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=c0a993208f264f9680e1482e34dcdf11
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 POST /login 302
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[32mPOST /login HTTP/1.1[0m" 302 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=5707173ddefb4acaa7e2ea4afe671ff6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET / HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7c8a0d8724e64e4897967956d30466c0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=9410fd18c631423996cc938c344e7bb4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=65ba1f286aea47af97d6bcdee7b311ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1d0aab925083406a8f2e114b4a430440
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3f4d51542b0f4c2aa33719e3173b5918
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=66fd9aec1cb14c098a7d140307315321
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:26] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=247388a6dc9e46b7983be85612da1a58
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1f41149d93e740a8877afeb07e3e09b1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /tasks 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /tasks HTTP/1.1[0m" 500 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[36mGET /static/css/fonts.css HTTP/1.1[0m" 304 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[36mGET /static/vendor/tailwindcss.min.js HTTP/1.1[0m" 304 -
INFO     kukanilea:__init__.py:116 GET /api/health/live 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /api/health/live HTTP/1.1" 200 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3424a25fadef4563830866e53c3b1867
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /api/status HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6a4e900f228d494e8c3b1ad6873313c7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /api/ai/status HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /sw.js 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /sw.js HTTP/1.1" 200 -
INFO     kukanilea:__init__.py:116 GET /api/health/ready 503
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /api/health/ready HTTP/1.1[0m" 503 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1b8c137c97af42f89e589c43eb3fc431
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET / HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b5341157ff334eab8dc1953a32c83a47
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/deals 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /crm/deals HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d885a48687424f51a253e3816a19df15
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /crm/customers HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=798d859c8d134c159449425e413bc5f6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/quotes 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /crm/quotes HTTP/1.1[0m" 500 -
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=db38546277184ce896d5c05aa26e2158
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/emails/import 500
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "[35m[1mGET /crm/emails/import HTTP/1.1[0m" 500 -
INFO     kukanilea:__init__.py:116 GET /app.webmanifest 200
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /app.webmanifest HTTP/1.1" 200 -
INFO     werkzeug:_internal.py:97 127.0.0.1 - - [22/Feb/2026 23:28:27] "GET /static/icons/pwa-icon.svg HTTP/1.1" 200 -
______________ test_api_tasks_create_records_first_task_milestone ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_api_tasks_create_records_0')

    def test_api_tasks_create_records_first_task_milestone(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        first = client.post(
            "/api/tasks/create",
            json={
                "title": "Activation KPI Task",
                "task_type": "GENERAL",
                "severity": "INFO",
                "details": "a",
            },
        )
>       assert first.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_activation_kpi.py:149: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,024 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=aa609a40aa0d4503b3d5be553e22d68f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,025 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=aa609a40aa0d4503b3d5be553e22d68f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/tasks/create 500
________________ test_api_insights_activation_is_tenant_scoped _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_api_insights_activation_i0')

    def test_api_insights_activation_is_tenant_scoped(tmp_path: Path) -> None:
        client = _client(tmp_path, tenant="TENANT_A")
    
        for milestone in ACTIVATION_MILESTONES:
            record_activation_milestone(
                tenant_id="TENANT_A",
                actor_user_id="dev",
                milestone=milestone,
                source="tests",
            )
    
        for milestone in ACTIVATION_MILESTONES:
            record_activation_milestone(
                tenant_id="TENANT_B",
                actor_user_id="other",
                milestone=milestone,
                source="tests",
            )
    
        resp = client.get("/api/insights/activation")
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_activation_kpi.py:200: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,150 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b3f6441a69c342e19ae2286abeb4a3b9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,151 - kukanilea - INFO - GET /api/insights/activation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b3f6441a69c342e19ae2286abeb4a3b9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/insights/activation 500
_______________________ test_ai_chat_shortcut_suggestion _______________________

    def test_ai_chat_shortcut_suggestion():
        """Verify that the AI suggests a shortcut form instead of direct mutation."""
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ai-chat/message",
            data={"message": "Erstelle aufmaß für Müller"},
            headers=headers,
        )
        assert response.status_code == 200
>       assert "KI-Vorschlag:" in response.text
E       assert 'KI-Vorschlag:' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:21: AssertionError
________________________ test_ai_chat_unhandled_message ________________________

    def test_ai_chat_unhandled_message():
        """Verify handling of unknown messages."""
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ai-chat/message", data={"message": "Hallo wie gehts"}, headers=headers
        )
        assert response.status_code == 200
>       assert "konnte aber keinen eindeutigen Workflow zuordnen" in response.text
E       assert 'konnte aber keinen eindeutigen Workflow zuordnen' in '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>'
E        +  where '<div class="alert alert-info">Ich habe das nicht verstanden. Versuche es mit \'Aufgabe: [Titel]\'</div>' = <Response [200 OK]>.text

tests/test_ai_chat.py:39: AssertionError
______________________________ test_api_ai_status ______________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10e056b10>

    def test_api_ai_status(monkeypatch) -> None:
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            OLLAMA_MODEL="llama3.2:3b",
            OLLAMA_MODEL_FALLBACKS="llama3.1:8b,qwen2.5:3b",
        )
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(webmod, "ollama_is_available", lambda **kwargs: True)
        monkeypatch.setattr(webmod, "is_any_provider_available", lambda **kwargs: True)
        monkeypatch.setattr(
            webmod,
            "ai_load_bootstrap_state",
            lambda config: {"status": "done", "ok": True},
        )
        monkeypatch.setattr(webmod, "ai_count_personal_notes", lambda **kwargs: 2)
        monkeypatch.setattr(
            webmod,
            "ollama_list_models",
            lambda **kwargs: ["llama3.1:8b", "mistral:7b"],
        )
        res = client.get("/api/ai/status")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,444 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=353d4e[REDACTED_PII]e57a3d[REDACTED_PII]ba2d08
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,445 - kukanilea - INFO - GET /api/ai/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=353d4e0658414e57a3d5430817ba2d08
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/status 500
_________________________ test_api_ai_modelpack_routes _________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f871160>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_api_ai_modelpack_routes0')

    def test_api_ai_modelpack_routes(monkeypatch, tmp_path: Path) -> None:
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            AI_BOOTSTRAP_MODELPACK_FILE=str(tmp_path / "offline-pack.tar.gz"),
            AI_BOOTSTRAP_MODELPACK_EXPORT_DIR=str(tmp_path / "exports"),
        )
        client = app.test_client()
        _login(client)
        with client.session_transaction() as sess:
            sess["role"] = "DEV"
    
        monkeypatch.setattr(
            webmod,
            "ai_create_model_pack",
            lambda **kwargs: {
                "ok": True,
                "pack_path": str(tmp_path / "exports" / "pack.tar.gz"),
                "file_count": 3,
                "total_bytes": 12,
            },
        )
        monkeypatch.setattr(
            webmod,
            "ai_import_model_pack",
            lambda **kwargs: {
                "ok": True,
                "pack_path": str(kwargs.get("pack_path") or ""),
                "extracted_files": 3,
            },
        )
    
        export_res = client.post("/api/ai/modelpack/export", json={})
>       assert export_res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:103: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,497 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0f[REDACTED_PII]d[REDACTED_PII]da3a75b[REDACTED_PII]b3b6cda
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,498 - kukanilea - INFO - POST /api/ai/modelpack/export 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0f33404d21454da3a75b02139b3b6cda
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/ai/modelpack/export 500
___________________________ test_api_ai_chat_success ___________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fdba780>

    def test_api_ai_chat_success(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_process_message",
            lambda **kwargs: {
                "status": "ok",
                "response": "Hallo von KI",
                "conversation_id": "conv-123",
                "tool_used": ["search_contacts"],
            },
        )
        res = client.post("/api/ai/chat", json={"q": "hallo"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:128: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,549 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0e4446bbad5246e1b0eceda2b9766d0b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,550 - kukanilea - INFO - POST /api/ai/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0e4446bbad5246e1b0eceda2b9766d0b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/ai/chat 500
______________________ test_api_ai_personal_memory_routes ______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fccf950>

    def test_api_ai_personal_memory_routes(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_list_personal_notes",
            lambda **kwargs: [{"id": "n1", "note": "test"}],
        )
        monkeypatch.setattr(webmod, "ai_add_personal_note", lambda **kwargs: "n2")
    
        get_res = client.get("/api/ai/personal-memory")
>       assert get_res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:149: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,601 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c2c46c2a25cf44adb91ab3cc1ac0567a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,602 - kukanilea - INFO - GET /api/ai/personal-memory 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c2c46c2a25cf44adb91ab3cc1ac0567a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/ai/personal-memory 500
_______________________ test_api_ai_confirm_tool_success _______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10af94bf0>

    def test_api_ai_confirm_tool_success(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(
            webmod,
            "ai_confirm_tool_call",
            lambda **kwargs: {
                "status": "ok",
                "response": "Bestaetigte Aktion ausgefuehrt.",
                "conversation_id": "conv-confirm-1",
                "tool_used": ["create_task"],
                "result": {"task_id": 12},
            },
        )
        res = client.post("/api/ai/confirm_tool", json={"token": "signed-token"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:177: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,652 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6dd2a1c9f08d4d[REDACTED_PII]acea626
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,653 - kukanilea - INFO - POST /api/ai/confirm_tool 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6dd2a1c9f08d4d74979277014acea626
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/ai/confirm_tool 500
__________________________ test_api_ai_feedback_route __________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_api_ai_feedback_route0')

    def test_api_ai_feedback_route(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path, app=app)
        client = app.test_client()
        _login(client)
    
        conv_id = save_conversation(
            tenant_id="KUKANILEA",
            user_id="dev",
            user_message="Hallo",
            assistant_response="Hi",
            tools_used=[],
        )
        assert conv_id
    
        res = client.post(
            "/api/ai/feedback",
            json={"conversation_id": conv_id, "rating": "positive"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ai_routes.py:205: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:30,706 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0b58de[REDACTED_PII]b4f[REDACTED_PII]b[REDACTED_PII]c360f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:30,707 - kukanilea - INFO - POST /api/ai/feedback 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0b58de08877b4f479931b922542c360f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/ai/feedback 500
____________________ test_confirm_with_valid_token_succeeds ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_confirm_with_valid_token_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f3ce240>

    def test_confirm_with_valid_token_succeeds(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:77: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,321 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3efaeaa25d544e0890e33b20d3fa43a5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,330 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3efaeaa25d544e0890e33b20d3fa43a5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
_________________ test_confirm_replay_with_same_token_blocked __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_confirm_replay_with_same_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f07fc20>

    def test_confirm_replay_with_same_token_blocked(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:101: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,412 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d92c3d064abe4cc686ab8d862e0ab631
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,422 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d92c3d064abe4cc686ab8d862e0ab631
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
_____________________ test_confirm_with_wrong_token_fails ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_confirm_with_wrong_token_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ee27890>

    def test_confirm_with_wrong_token_fails(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:126: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,499 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=aa09dfa1b3744e38b0960df4a7c8a476
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,508 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=aa09dfa1b3744e38b0960df4a7c8a476
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
_______________________ test_confirm_without_token_fails _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_confirm_without_token_fai0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fc70ce0>

    def test_confirm_without_token_fails(tmp_path: Path, monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        pending_id = _create_pending(db_path, monkeypatch)
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_replay.py:145: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,586 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=182aa[REDACTED_PII]e[REDACTED_PII]e[REDACTED_PII]a40a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,595 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=182aa028424442e381766e93314a40a7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
_______________ test_pending_confirm_requires_admin_or_dev_role ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_pending_confirm_requires_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ecfaf60>

    def test_pending_confirm_requires_admin_or_dev_role(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Role gate rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        monkeypatch.setattr(core, "task_create", lambda **_kwargs: 900)
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "restricted",
                "requires_confirm": True,
            },
            context={"event_id": "1"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
        assert token
    
        client = app.test_client()
        _login(client, role="OPERATOR")
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_confirm_role_gate.py:71: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,672 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=76d395e7f[REDACTED_PII]a9daf9ddcb3ae2fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,681 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=76d395e7f2144026a9daf9ddcb3ae2fe
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
________________ test_automation_post_without_csrf_is_forbidden ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_post_without_c0')

    def test_automation_post_without_csrf_is_forbidden(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
    
        response = client.post(
            f"/automation/{rule_id}/toggle",
            data={"enabled": "0"},
            follow_redirects=False,
        )
>       assert response.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:52: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,757 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]c1baec4b0ab[REDACTED_PII]ee0369e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,766 - kukanilea - INFO - POST /automation/a7fe[REDACTED_PII]f17-44e7-92f4-990ac5624fed/toggle 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d09269c1baec4b0ab42730848ee0369e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /automation/a7fe7765-5f17-44e7-92f4-990ac5624fed/toggle 500
_____________ test_automation_post_with_invalid_csrf_is_forbidden ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_post_with_inva0')

    def test_automation_post_with_invalid_csrf_is_forbidden(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:70: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,841 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]bc3722b4a0c8639e[REDACTED_PII]b468
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,851 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=08606bc3722b4a0c8639e3959365b468
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
_______________ test_automation_post_with_valid_csrf_is_allowed ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_post_with_vali0')

    def test_automation_post_with_valid_csrf_is_allowed(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="CSRF Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_csrf.py:95: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:31,963 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d1bab16e[REDACTED_PII]b1b87c90b073cbcd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:31,973 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d1bab16e39024841b1b87c90b073cbcd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
___________ test_rule_simulation_creates_log_without_pending_actions ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_simulation_creates_l0')

    def test_rule_simulation_creates_log_without_pending_actions(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Dry run rule",
            triggers=[
                {
                    "trigger_type": "eventlog",
                    "config": {"allowed_event_types": ["email.received"]},
                }
            ],
            conditions=[],
            actions=[
                {
                    "action_type": "create_task",
                    "config": {"title": "dry run", "requires_confirm": False},
                }
            ],
            db_path=db_path,
        )
        con = sqlite3.connect(str(db_path), timeout=30)
        try:
            con.execute(
                """
                CREATE TABLE IF NOT EXISTS events(
                  id INTEGER PRIMARY KEY,
                  ts TEXT NOT NULL,
                  event_type TEXT NOT NULL,
                  entity_type TEXT NOT NULL,
                  entity_id INTEGER NOT NULL,
                  payload_json TEXT NOT NULL
                )
                """
            )
            con.execute(
                """
                INSERT INTO events(id, ts, event_type, entity_type, entity_id, payload_json)
                VALUES (1,'2026-02-18T10:00:00Z','email.received','mailbox_thread',1,'{\"tenant_id\":\"KUKANILEA\",\"ref_id\":\"dry-1\"}')
                """
            )
            con.commit()
        finally:
            con.close()
        event_id = 1
    
        client = app.test_client()
        _login(client)
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_dry_run.py:83: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,049 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=52f65d8dfa634bec9213b99f7ede7967
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,058 - kukanilea - INFO - GET /automation/34a890a6-904c-49ae-9671-ea683f18c6ad 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=52f65d8dfa634bec9213b99f7ede7967
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/34a890a6-904c-49ae-9671-ea683f18c6ad 500
_______________________ test_rule_export_and_safe_import _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_export_and_safe_impo0')

    def test_rule_export_and_safe_import(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        source_rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Export Source",
            description="safe export",
            max_executions_per_minute=7,
            triggers=[
                {
                    "trigger_type": "eventlog",
                    "config": {"allowed_event_types": ["lead.created"]},
                }
            ],
            conditions=[],
            actions=[{"action_type": "create_task", "config": {"requires_confirm": False}}],
            db_path=db_path,
        )
    
        client = app.test_client()
        _login(client)
    
        exported = client.get(f"/automation/{source_rule_id}/export")
>       assert exported.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,134 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0f[REDACTED_PII]f733c4c[REDACTED_PII]f6d[REDACTED_PII]db6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,143 - kukanilea - INFO - GET /automation/566d52e5-a[REDACTED_PII]-a8b1-babad8e65d61/export 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0f78491f733c4c78847f6d9329135db6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/566d52e5-a235-4473-a8b1-babad8e65d61/export 500
____________ test_rule_import_supports_cron_email_send_and_webhook _____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_import_supports_cron0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fd68080>

    def test_rule_import_supports_cron_email_send_and_webhook(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(
            webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["hooks.example.com"]
        )
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:109: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,215 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=abe1d[REDACTED_PII]a44b0788a[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,225 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=abe1d94617a44b0788a6343720054732
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
_______________ test_rule_import_rejects_invalid_cron_expression _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_import_rejects_inval0')

    def test_rule_import_rejects_invalid_cron_expression(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:161: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,295 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fc[REDACTED_PII]e0dfc47d49f4bcd72e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,304 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fc62799e0dfc47d49f4bcd72e8156718
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
________________ test_rule_import_rejects_cron_with_six_fields _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_import_rejects_cron_0')

    def test_rule_import_rejects_cron_with_six_fields(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:186: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,374 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b22eef47b[REDACTED_PII]df[REDACTED_PII]e031c84cb8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,383 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b22eef47b34341df823730e031c84cb8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
___________ test_rule_import_rejects_email_draft_unknown_placeholder ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_import_rejects_email0')

    def test_rule_import_rejects_email_draft_unknown_placeholder(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:211: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,453 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=07f[REDACTED_PII]b2ad[REDACTED_PII]bc71b40d449dbe8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,462 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=07f80187b2ad42679bc71b40d449dbe8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
______________ test_rule_import_rejects_webhook_outside_allowlist ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rule_import_rejects_webho0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f3cd070>

    def test_rule_import_rejects_webhook_outside_allowlist(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["good.example"])
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_import_export.py:248: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,570 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]bcd086ca51ab3581
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,579 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f908788516324842bcd086ca51ab3581
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
______________________ test_run_now_blocked_in_read_only _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_run_now_blocked_in_read_o0')

    def test_run_now_blocked_in_read_only(tmp_path: Path) -> None:
        _init_core(tmp_path)
        automation_rule_create(
            "TENANT_A",
            "r1",
            "leads",
            "lead_screening_stale",
            '{"hours_in_screening":1}',
            '[{"kind":"lead_pin","value":true}]',
            "dev",
        )
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_A"
    
        r = client.post("/api/automation/run-now", json={"max_actions": 5})
>       assert r.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_read_only.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:32,952 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=1a5a1f1921b54c2782b1a11effd1fbce
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:32,953 - kukanilea - INFO - POST /api/automation/run-now 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=1a5a1f1921b54c2782b1a11effd1fbce
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/automation/run-now 500
_____________ test_pending_token_not_exposed_in_query_or_eventlog ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_pending_token_not_exposed0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ee88e00>

    def test_pending_token_not_exposed_in_query_or_eventlog(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Token leak rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        monkeypatch.setattr(core, "task_create", lambda **_kwargs: 901)
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "secure confirm",
                "requires_confirm": True,
            },
            context={"event_id": "9"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        row = get_pending_action(
            tenant_id="KUKANILEA", pending_id=pending_id, db_path=db_path
        )
        assert row is not None
        token = str(row.get("confirm_token") or "")
        assert token
    
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_token_leak.py:72: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,123 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b6eeadd863e8436eb71bc907e106a93a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,132 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b6eeadd863e8436eb71bc907e106a93a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
____________________ test_automation_builder_requires_login ____________________

    def test_automation_builder_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.get("/automation", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,266 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=c2ac8e[REDACTED_PII]b3795d[REDACTED_PII]eae9c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,275 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=c2ac8e1361174869b3795d44966eae9c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
_____________________ test_automation_builder_toggle_rule ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_builder_toggle0')

    def test_automation_builder_toggle_rule(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
    
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:61: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,331 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d4d[REDACTED_PII]e02bee727b50a96
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,340 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=703175d4d55843928e02bee727b50a96
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
__________ test_automation_pending_confirm_requires_ack_and_confirms ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_pending_confir0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f1c1b20>

    def test_automation_pending_confirm_requires_ack_and_confirms(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        pending = execute_action(
            tenant_id="KUKANILEA",
            rule_id=rule_id,
            action_config={
                "action_type": "create_task",
                "title": "From pending",
                "requires_confirm": True,
            },
            context={"event_id": "42"},
            db_path=db_path,
            user_confirmed=False,
        )
        pending_id = str(pending.get("pending_id") or "")
        assert pending_id
        client = app.test_client()
        _login(client)
        pending_page = client.get("/automation/pending")
>       assert pending_page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:107: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,417 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3ccfcfd2a4214e1aad9f99d4c4e0f7c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,426 - kukanilea - INFO - GET /automation/pending 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3ccfcfd2a4214e1aad9f99d4c4e0f7c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/pending 500
__________ test_automation_rule_detail_supports_cron_and_mail_actions __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_rule_detail_su0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f23cf20>

    def test_automation_rule_detail_supports_cron_and_mail_actions(
        tmp_path: Path, monkeypatch
    ) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        monkeypatch.setattr(
            webmod.Config, "WEBHOOK_ALLOWED_DOMAINS_LIST", ["hooks.example.com"]
        )
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:161: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,502 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=820ebb67fd7f[REDACTED_PII]ad8f739c17e3aec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,511 - kukanilea - INFO - GET /automation/aa62b3a4-c7a[REDACTED_PII]-b7fd-1e38d0d2ff[REDACTED_PII]
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=820ebb67fd7f47029ad8f739c17e3aec
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/aa62b3a4-c7a9-4743-b7fd-1e38d0d2ff43 500
_________ test_automation_rule_detail_rejects_invalid_email_templates __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_automation_rule_detail_re0')

    def test_automation_rule_detail_rejects_invalid_email_templates(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        rule_id = create_rule(
            tenant_id="KUKANILEA",
            name="Builder Rule",
            triggers=[],
            conditions=[],
            actions=[],
            db_path=db_path,
        )
        client = app.test_client()
        _login(client)
        detail = client.get(f"/automation/{rule_id}")
>       assert detail.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_automation_web.py:235: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:33,587 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=aba0cead7dc649c[REDACTED_PII]efb0bc9b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:33,596 - kukanilea - INFO - GET /automation/7a8ff063-e0c4-4d[REDACTED_PII]-c93d2cc4807e 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=aba0cead7dc649c985107324efb0bc9b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation/7a8ff063-e0c4-4d70-8717-c93d2cc4807e 500
_____________ test_scan_history_is_recorded_and_visible_in_health ______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_scan_history_is_recorded_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f3e64b0>

    def test_scan_history_is_recorded_and_visible_in_health(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        monkeypatch.setenv("KUKANILEA_ANONYMIZATION_KEY", "scan-test-key")
        knowledge_policy_update(
            "TENANT_A",
            actor_user_id="dev",
            allow_customer_pii=True,
            allow_documents=True,
        )
    
        docs = tmp_path / "docs"
        docs.mkdir(parents=True, exist_ok=True)
        (docs / "doc.txt").write_text("content", encoding="utf-8")
        source_watch_config_update("TENANT_A", documents_inbox_dir=str(docs), enabled=True)
    
        result = scan_sources_once("TENANT_A", actor_user_id="dev")
        assert int(result["ingested_ok"]) == 1
    
>       overview = get_health_overview("TENANT_A", history_limit=10)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: get_health_overview() got an unexpected keyword argument 'history_limit'

tests/test_autonomy_health_record.py:40: TypeError
________________________ test_smoke_test_updates_status ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_smoke_test_updates_status0')

    def test_smoke_test_updates_status(tmp_path: Path) -> None:
        _init_core(tmp_path)
>       result = run_smoke_test("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_smoke_test() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_health_record.py:49: TypeError
______________ test_rotate_logs_compresses_and_deletes_old_files _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_rotate_logs_compresses_an0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f345280>

    def test_rotate_logs_compresses_and_deletes_old_files(
        tmp_path: Path, monkeypatch
    ) -> None:
        _init_core(tmp_path)
        log_dir = tmp_path / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_dir))
    
        old_log = log_dir / "old.log"
        old_log.write_text("old", encoding="utf-8")
        old_gz = log_dir / "old.log.gz"
        old_gz.write_bytes(b"oldgz")
        fresh_log = log_dir / "fresh.log"
        fresh_log.write_text("fresh", encoding="utf-8")
    
        old_ts = time.time() - (40 * 24 * 3600)
        os.utime(old_log, (old_ts, old_ts))
        os.utime(old_gz, (old_ts, old_ts))
    
>       result = rotate_logs("TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: rotate_logs() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_log_rotation.py:39: TypeError
________________ test_run_backup_once_creates_backup_and_event _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_run_backup_once_creates_b0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f347890>

    def test_run_backup_once_creates_backup_and_event(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
>       result = run_backup_once(tenant_id="TENANT_A", actor_user_id="dev")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup_once() got an unexpected keyword argument 'tenant_id'

tests/test_autonomy_maintenance.py:24: TypeError
_____________________ test_backup_create_rotate_and_verify _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_backup_create_rotate_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f344290>

    def test_backup_create_rotate_and_verify(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        tenant_dir = backup_root / "TENANT_A"
        tenant_dir.mkdir(parents=True, exist_ok=True)
        old_file = tenant_dir / "backup-old.sqlite"
        old_file.write_bytes(b"old")
        old_ts = time.time() - (10 * 24 * 3600)
        os.utime(old_file, (old_ts, old_ts))
    
>       result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:36: TypeError
____________________ test_backup_read_only_blocks_file_ops _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_backup_read_only_blocks_f0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f3479e0>

    def test_backup_read_only_blocks_file_ops(tmp_path: Path, monkeypatch) -> None:
        _init_core(tmp_path)
        backup_root = tmp_path / "backups"
        backup_root.mkdir(parents=True, exist_ok=True)
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
    
        app = Flask(__name__)
        app.config["READ_ONLY"] = True
        with app.app_context():
>           result = run_backup("TENANT_A", actor_user_id="dev", rotate=True)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           TypeError: run_backup() got an unexpected keyword argument 'actor_user_id'

tests/test_autonomy_maintenance_backup.py:73: TypeError
____________________ test_autonomy_health_page_and_actions _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_autonomy_health_page_and_0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f399df0>

    def test_autonomy_health_page_and_actions(tmp_path: Path, monkeypatch) -> None:
        backup_root = tmp_path / "backups"
        log_root = tmp_path / "logs"
        monkeypatch.setenv("KUKANILEA_BACKUP_DIR", str(backup_root))
        monkeypatch.setenv("KUKANILEA_LOG_DIR", str(log_root))
    
        client = _client(tmp_path, read_only=False)
        page = client.get("/autonomy/health")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autonomy_ui_health.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:34,392 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=9e6b9adac85a440b9fd042aeaf2f8ffc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:34,401 - kukanilea - INFO - GET /autonomy/health 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=9e6b9adac85a440b9fd042aeaf2f8ffc
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /autonomy/health 500
______________ test_autonomy_health_actions_blocked_in_read_only _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_autonomy_health_actions_b0')

    def test_autonomy_health_actions_blocked_in_read_only(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
>       assert client.post("/autonomy/health/backup").status_code == 403
E       AssertionError: assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E        +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = post('/autonomy/health/backup')
E        +      where post = <FlaskClient <Flask 'app'>>.post

tests/test_autonomy_ui_health.py:52: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:34,475 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6cb358ed234c4f1c[REDACTED_PII]d49a02ae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:34,484 - kukanilea - INFO - POST /autonomy/health/backup 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6cb358ed234c4f1c94985304d49a02ae
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /autonomy/health/backup 500
__________________________ test_autotag_pages_render ___________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_autotag_pages_render0')

    def test_autotag_pages_render(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       assert client.get("/autonomy/autotag/rules").status_code == 200
E       AssertionError: assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E        +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = get('/autonomy/autotag/rules')
E        +      where get = <FlaskClient <Flask 'app'>>.get

tests/test_autotag_web.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:34,874 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=eba0abce3ab24c[REDACTED_PII]b0661fab4386
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:34,883 - kukanilea - INFO - GET /autonomy/autotag/rules 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=eba0abce3ab24c649573b0661fab4386
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /autonomy/autotag/rules 500
____________________ test_autotag_create_read_only_blocked _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_autotag_create_read_only_0')

    def test_autotag_create_read_only_blocked(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
        resp = client.post(
            "/autonomy/autotag/rules/create",
            data={
                "name": "Blocked",
                "priority": "0",
                "filename_glob": "*x*",
                "set_doctype_token": "invoice",
            },
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_autotag_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:34,957 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6dfb68da[REDACTED_PII]f0bf[REDACTED_PII]d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:34,967 - kukanilea - INFO - POST /autonomy/autotag/rules/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6dfb68da571540f0bf405257274563d6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /autonomy/autotag/rules/create 500
_______________________________ test_chat_api_ok _______________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f01c7a0>

    def test_chat_api_ok(monkeypatch):
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
    
        monkeypatch.setattr(
            web,
            "agent_answer",
            lambda msg: {
                "text": "ok",
                "facts": [{"text": "f1", "meta": {"kind": "task", "pk": 1}, "score": 0.1}],
                "action": None,
            },
        )
    
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "KUKANILEA"
    
        res = client.post("/api/chat", json={"q": "rechnung"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_api.py:27: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,089 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=1e[REDACTED_PII]f18e94c6caf6c[REDACTED_PII]c0ff6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,089 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=1e04253f18e94c6caf6c0178835c0ff6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/chat 500
_________________________ test_api_chat_requires_auth __________________________

    def test_api_chat_requires_auth():
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.post("/api/chat", json={"q": "rechnung"})
>       assert res.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_api.py:47: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,186 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=e5aab4164ffc41b0b132be793c8a9d17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,187 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=e5aab4164ffc41b0b132be793c8a9d17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/chat 500
_______________ test_chat_widget_present_for_authenticated_user ________________

    def test_chat_widget_present_for_authenticated_user() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_widget.py:19: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,285 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]dd[REDACTED_PII]e05ed9d5348bd1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,294 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d725385653dd412889e05ed9d5348bd1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
________________ test_chat_api_hx_request_returns_html_fragment ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fddac30>

    def test_chat_api_hx_request_returns_html_fragment(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        monkeypatch.setattr(web, "agent_answer", lambda msg: {"text": "Antwort"})
    
        res = client.post(
            "/api/chat",
            data={"msg": "Hallo"},
            headers={"HX-Request": "true"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_chat_widget.py:36: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,343 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=894c1c697d3b490c8df15c5ce[REDACTED_PII]c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,344 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=894c1c697d3b490c8df15c5ce23903c2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/chat 500
______________ test_collision_event_emitted_on_claim_guard_block _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_collision_event_emitted_o0')

    def test_collision_event_emitted_on_claim_guard_block(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            ANONYMIZATION_KEY="collision-key",
            READ_ONLY=False,
        )
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice")
        _set_session(c2, user="bob")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_collision_event_emitted.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_collision_event_emitted.py:48: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,422 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6e[REDACTED_PII]e416a881da[REDACTED_PII]a23f0f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,422 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6e875978116e416a881da05706a23f0f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
___________________ test_read_only_blocks_crm_mutation_route ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_read_only_blocks_crm_muta0')

    def test_read_only_blocks_crm_mutation_route(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
    
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        resp = client.post("/api/customers", json={"name": "Blocked"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_customers.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,641 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=0705c[REDACTED_PII]bb0c8d7395b2a3912
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,642 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=0705c3502193483bb0c8d7395b2a3912
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/customers 500
_____________________ test_api_tenant_isolation_customers ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_api_tenant_isolation_cust0')

    def test_api_tenant_isolation_customers(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "alice"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
        res_create = client.post("/api/customers", json={"name": "A-Customer"})
>       assert res_create.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_tenant_isolation.py:29: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,876 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=4c5281ae7a954c2da6661cb84cfb5829
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,877 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=4c5281ae7a954c2da6661cb84cfb5829
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/customers 500
___________ test_crm_ui_shows_read_only_banner_and_disabled_controls ___________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_crm_ui_shows_read_only_ba0')

    def test_crm_ui_shows_read_only_banner_and_disabled_controls(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        res = client.get("/crm/customers")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_read_only.py:30: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:35,951 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=7f0b[REDACTED_PII]ca4f735e84b[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:35,960 - kukanilea - INFO - GET /crm/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=7f0b97655072489ca4f735e84b117600
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
____________________ test_crm_pages_and_partials_return_200 ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_crm_pages_and_partials_re0')

    def test_crm_pages_and_partials_return_200(tmp_path: Path) -> None:
        _init_core(tmp_path)
        customer_id = core.customers_create("TENANT_A", "UI Kunde")
        core.contacts_create(
            "TENANT_A", customer_id, "Max Mustermann", email="max@example.com"
        )
        deal_id = core.deals_create("TENANT_A", customer_id, "UI Deal", stage="lead")
        quote = core.quotes_create_from_deal("TENANT_A", deal_id)
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _auth(client)
    
        for path in [
            "/crm/customers",
            f"/crm/customers/{customer_id}",
            "/crm/deals",
            "/crm/quotes",
            "/crm/emails/import",
            "/crm/_customers_table",
            f"/crm/_customer_contacts/{customer_id}",
            f"/crm/_customer_deals/{customer_id}",
            f"/crm/_customer_quotes/{customer_id}",
            f"/crm/_customer_emails/{customer_id}",
            "/crm/_deals_pipeline",
            "/crm/_quotes_table",
            f"/crm/quotes/{quote['id']}",
        ]:
            res = client.get(path)
>           assert res.status_code == 200, path
E           AssertionError: /crm/customers
E           assert 500 == 200
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_routes.py:56: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:36,053 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=8752b8f0fed24e3094e2723c1ff3c482
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:36,062 - kukanilea - INFO - GET /crm/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=8752b8f0fed24e3094e2723c1ff3c482
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /crm/customers 500
____________________ test_crm_email_import_page_upload_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_crm_email_import_page_upl0')

    def test_crm_email_import_page_upload_flow(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _auth(client)
    
        eml = b"From: sender@example.com\nTo: receiver@example.com\nSubject: UI\n\nBody"
        resp = client.post(
            "/api/emails/import",
            data={"file": (io.BytesIO(eml), "sample.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_crm_ui_routes.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:36,177 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=cff7cc41f3484c9d[REDACTED_PII]c360bd996f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:36,178 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=cff7cc41f3484c9d912305c360bd996f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/emails/import 500
____________________ test_run_native_desktop_bootstrap_flow ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10af957f0>

    def test_run_native_desktop_bootstrap_flow(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5123,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:43: TypeError
________________ test_run_native_desktop_raises_when_not_ready _________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10af95670>

    def test_run_native_desktop_raises_when_not_ready(monkeypatch) -> None:
        dummy_webview = _DummyWebview()
        dummy_server = _DummyServer()
>       dummy_handle = desktop._ServerHandle(  # noqa: SLF001
            server=dummy_server,
            thread=_DummyThread(),
            port=5124,
        )
E       TypeError: _ServerHandle.__init__() got an unexpected keyword argument 'server'

tests/test_desktop_mode.py:81: TypeError
________________________ test_oversize_eml_returns_413 _________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_oversize_eml_returns_4130')

    def test_oversize_eml_returns_413(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", MAX_EML_BYTES=1024)
        client = app.test_client()
        _auth(client, "TENANT_A")
    
        payload = b"From: a@a\nTo: b@b\nSubject: S\n\n" + (b"x" * 2000)
        data = {"file": (io.BytesIO(payload), "mail.eml")}
        resp = client.post(
            "/api/emails/import", data=data, content_type="multipart/form-data"
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_email_import_limits.py:39: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:36,911 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=f[REDACTED_PII]a814c47bdd5f982ed4d4c4d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:36,912 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=f58953027a814c47bdd5f982ed4d4c4d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/emails/import 500
______________ test_malformed_email_does_not_crash_and_truncates _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_malformed_email_does_not_0')

    def test_malformed_email_does_not_crash_and_truncates(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", MAX_EML_BYTES=1024 * 1024)
        client = app.test_client()
        _auth(client, "TENANT_A")
    
        huge = (
            b"From: a@a\nTo: b@b\nSubject: S\nContent-Type: text/plain\n\n" + b"A" * 25000
        )
        data = {"file": (io.BytesIO(huge), "mail.eml")}
        resp = client.post(
            "/api/emails/import", data=data, content_type="multipart/form-data"
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_email_import_limits.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:36,989 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b2c294e[REDACTED_PII]ce92e76f[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:36,990 - kukanilea - INFO - POST /api/emails/import 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b2c294e1969243ce92e76f9336247719
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/emails/import 500
_______________ test_entity_links_panel_renders_sanitized_titles _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_entity_links_panel_render0')

    def test_entity_links_panel_renders_sanitized_titles(tmp_path: Path) -> None:
        client, lead_id = _client(tmp_path)
        resp = client.get(f"/entity-links/lead/{lead_id}")
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_panel_render.py:62: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,227 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6aeb43edff9d4e81aa68dc08e[REDACTED_PII]d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,237 - kukanilea - INFO - GET /entity-links/lead/51d70e[REDACTED_PII]c9a0685c1a[REDACTED_PII]
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6aeb43edff9d4e81aa68dc08e412368d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /entity-links/lead/51d70e957191437692c9a0685c1a9290 500
_________________ test_entity_links_routes_create_list_delete __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_entity_links_routes_creat0')

    def test_entity_links_routes_create_list_delete(tmp_path: Path) -> None:
        client, lead_id, note_id = _client(tmp_path)
    
        partial = client.get(f"/entity-links/lead/{lead_id}")
>       assert partial.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,352 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6ba0c03f[REDACTED_PII]a[REDACTED_PII]d[REDACTED_PII]f8082c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,362 - kukanilea - INFO - GET /entity-links/lead/b4697a[REDACTED_PII]ea572b747f5cf74c2 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6ba0c03f386849a18515d89617f8082c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /entity-links/lead/b4697a712782401ea572b747f5cf74c2 500
___________________ test_entity_links_read_only_returns_403 ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_entity_links_read_only_re0')

    def test_entity_links_read_only_returns_403(tmp_path: Path) -> None:
        client, lead_id, note_id = _client(tmp_path, read_only=True)
        resp = client.post(
            "/entity-links/create",
            data={
                "left_type": "lead",
                "left_id": lead_id,
                "right_type": "knowledge_note",
                "right_id": note_id,
                "link_type": "related",
            },
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_entity_links_web.py:89: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,449 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=3b09b8936f1b4a05a392aff90fb4c111
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,459 - kukanilea - INFO - POST /entity-links/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=3b09b8936f1b4a05a392aff90fb4c111
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /entity-links/create 500
________________ test_global_http_exception_honors_accept_json _________________

    def test_global_http_exception_honors_accept_json() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="OPERATOR")
    
        res = client.get("/route-does-not-exist", headers={"Accept": "application/json"})
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_content_negotiation.py:60: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,711 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=0f88b5e95d304d83bd9667f[REDACTED_PII]c8e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,711 - kukanilea - INFO - GET /route-does-not-exist 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=0f88b5e95d304d83bd9667f012613c8e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /route-does-not-exist 500
______________ test_web_404_uses_shell_with_back_reload_controls _______________

    def test_web_404_uses_shell_with_back_reload_controls() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/route-does-not-exist")
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:20: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,761 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=dd1136a7c9ee4c86a0cb5342ec3b86c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,770 - kukanilea - INFO - GET /route-does-not-exist 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=dd1136a7c9ee4c86a0cb5342ec3b86c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /route-does-not-exist 500
____________ test_navigation_is_persistent_and_minimizable_in_shell ____________

    def test_navigation_is_persistent_and_minimizable_in_shell() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:34: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,819 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a6b4ce1e[REDACTED_PII]c9cb8d95c9c146bd2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,829 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a6b4ce1e8212429c9cb8d95c9c146bd2
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings 500
____________________ test_api_404_returns_json_error_shape _____________________

    def test_api_404_returns_json_error_shape() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/api/not-found")
>       assert res.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_error_shell_navigation.py:53: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:37,879 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=428ef5e73e[REDACTED_PII]e206b[REDACTED_PII]b63
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:37,879 - kukanilea - INFO - GET /api/not-found 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=428ef5e73e16438493e206b175713b63
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/not-found 500
_______________________ test_evidence_pack_requires_auth _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_evidence_pack_requires_au0')

    def test_evidence_pack_requires_auth(tmp_path: Path) -> None:
        _init_core(tmp_path)
        Config.CORE_DB = core.DB_PATH
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", CORE_DB=core.DB_PATH)
        client = app.test_client()
        resp = client.get("/api/reports/evidence-pack/abc?entity_type=lead")
>       assert resp.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,152 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=82a8be4143f74d87b44d935edfe73d76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,153 - kukanilea - INFO - GET /api/reports/evidence-pack/abc 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=82a8be4143f74d87b44d935edfe73d76
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/reports/evidence-pack/abc 500
_________ test_evidence_pack_lead_includes_request_ids_and_attachments _________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_evidence_pack_lead_includ0')

    def test_evidence_pack_lead_includes_request_ids_and_attachments(
        tmp_path: Path,
    ) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_evidence_pack.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,272 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=cb489f[REDACTED_PII]df996cca[REDACTED_PII]fd4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,273 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=cb489f1981554df996cca31390314fd4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_____________________ test_evidence_pack_tenant_isolation ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_evidence_pack_tenant_isol0')

    def test_evidence_pack_tenant_isolation(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_evidence_pack.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,349 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5490f79d87f24d4094f29cc9c2e147c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,349 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5490f79d87f24d4094f29cc9c2e147c5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_____________________ test_evidence_pack_validation_error ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_evidence_pack_validation_0')

    def test_evidence_pack_validation_error(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.get("/api/reports/evidence-pack/abc?entity_type=invalid")
>       assert resp.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_evidence_pack.py:123: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,428 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]e4f0c831a2e909d501cb6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,428 - kukanilea - INFO - GET /api/reports/evidence-pack/abc 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=06469207438e4f0c831a2e909d501cb6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/reports/evidence-pack/abc 500
____________ test_run_latency_suite_mock_mode_collects_percentiles _____________

    def test_run_latency_suite_mock_mode_collects_percentiles() -> None:
>       report = run_latency_suite(requests_count=2, use_real_ai=False)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_hardening_latency_bench.py:7: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

requests_count = 2, use_real_ai = False

    def run_latency_suite(
        requests_count: int = 30, use_real_ai: bool = False
    ) -> dict[str, Any]:
        req_count = max(1, int(requests_count))
        with _isolated_env():
            app = create_app()
            app.config.update(TESTING=True, READ_ONLY=False)
            with app.app_context():
                auth_db: AuthDB = app.extensions["auth_db"]
                _seed_auth(auth_db)
    
            client = app.test_client()
            with client.session_transaction() as sess:
                sess["user"] = "bench"
                sess["role"] = "DEV"
                sess["tenant_id"] = "KUKANILEA"
    
            # Seed one searchable knowledge note.
            seed = client.post(
                "/api/knowledge/notes",
                json={"title": "Latency Seed Note", "body": "Hardening benchmark seed"},
            )
            if seed.status_code != 200:
>               raise RuntimeError(f"knowledge seed failed: HTTP {seed.status_code}")
E               RuntimeError: knowledge seed failed: HTTP 500

app/bench/hardening_latency.py:112: RuntimeError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,508 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=32a7c45a1c2b4c8dae85baa[REDACTED_PII]e99d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,509 - kukanilea - INFO - POST /api/knowledge/notes 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=32a7c45a1c2b4c8dae85baa90918e99d
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/knowledge/notes 500
_____________ test_unauthenticated_requests_are_denied_by_default ______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fd027b0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_unauthenticated_requests_0')

    def test_unauthenticated_requests_are_denied_by_default(
        monkeypatch, tmp_path: Path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
    
        for path in ("/api/tasks", "/api/customers", "/api/audit"):
            res = client.get(path)
>           assert res.status_code == 401, path
E           AssertionError: /api/tasks
E           assert 500 == 401
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:65: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,595 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=01bedb23bb[REDACTED_PII]a[REDACTED_PII]d4d34f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,596 - kukanilea - INFO - GET /api/tasks 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=01bedb23bb7041289073a50286d4d34f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/tasks 500
__________________ test_low_role_is_denied_on_admin_endpoint ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ec4da00>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_low_role_is_denied_on_adm0')

    def test_low_role_is_denied_on_admin_endpoint(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="op", role="OPERATOR")
        client = app.test_client()
        _login(client, username="op", role="OPERATOR")
    
        res = client.get("/api/audit")
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:79: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,708 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3abc424dbb1542b287f9f9b6f4fcbc7c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,709 - kukanilea - INFO - GET /api/audit 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3abc424dbb1542b287f9f9b6f4fcbc7c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/audit 500
_________________ test_cross_tenant_access_does_not_leak_data __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f8f13a0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_cross_tenant_access_does_0')

    def test_cross_tenant_access_does_not_leak_data(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path, fixed_tenant_enforce=False)
        _seed_user(app, username="alice", role="OPERATOR")
        _seed_user(app, username="bob", role="OPERATOR")
        client = app.test_client()
    
        core.DB_PATH = app.config["CORE_DB"]
        task_id = int(
            core.task_create(
                tenant="KUKANILEA",
                severity="INFO",
                task_type="GENERAL",
                title="Tenant A Secret Task",
                details="Do not leak",
                created_by="alice",
            )
        )
    
        _login(client, username="bob", role="OPERATOR", tenant="OTHER_TENANT")
        denied = client.post(f"/api/tasks/{task_id}/move", json={"column": "done"})
>       assert denied.status_code in (403, 404)
E       assert 500 in (403, 404)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:111: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,848 - kukanilea - ERROR - unhandled_exception tenant_id=OTHER_TENANT request_id=9cab[REDACTED_PII]b48e2818c2c55c2509de3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,849 - kukanilea - INFO - POST /api/tasks/1/move 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=OTHER_TENANT request_id=9cab4843205b48e2818c2c55c2509de3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/tasks/1/move 500
_______________________ test_logout_invalidates_session ________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ef2e0f0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_logout_invalidates_sessio0')

    def test_logout_invalidates_session(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="dev", role="OPERATOR")
        client = app.test_client()
        _login(client, username="dev", role="OPERATOR")
    
        before = client.get("/api/tasks")
>       assert before.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_hardening_security.py:125: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:38,995 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e1b45a9ca60b4d[REDACTED_PII]a621e[REDACTED_PII]c60
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:38,996 - kukanilea - INFO - GET /api/tasks 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e1b45a9ca60b4d76943a621e30980c60
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/tasks 500
_____________________ test_idle_timeout_default_60_logout ______________________

    def test_idle_timeout_default_60_logout() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        now = datetime.now(UTC)
        with client.session_transaction() as sess:
            sess["session_created_at"] = _iso_utc(now - timedelta(minutes=10))
            sess["last_activity"] = _iso_utc(now - timedelta(minutes=61))
            sess["idle_timeout_minutes"] = 60
    
        res = client.get("/settings", follow_redirects=False)
>       assert res.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,138 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]cc78c04aa9aef585a19f[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,147 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f72880cc78c04aa9aef585a19f233984
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings 500
______________________ test_idle_timeout_bounds_enforced _______________________

    def test_idle_timeout_bounds_enforced() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        with client.session_transaction() as sess:
            sess["csrf_token"] = "csrf-test"
    
        low = client.post(
            "/settings/idle-timeout",
            data={"idle_timeout": "5", "csrf_token": "csrf-test"},
            follow_redirects=False,
        )
>       assert low.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:50: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,198 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=e[REDACTED_PII]ef6c641b59a776cf6933fcdf7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,207 - kukanilea - INFO - POST /settings/idle-timeout 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=e154288ef6c641b59a776cf6933fcdf7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /settings/idle-timeout 500
_______________________ test_absolute_timeout_8h_logout ________________________

    def test_absolute_timeout_8h_logout() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login_session(client, role="ADMIN")
    
        now = datetime.now(UTC)
        with client.session_transaction() as sess:
            sess["session_created_at"] = _iso_utc(now - timedelta(hours=9))
            sess["last_activity"] = _iso_utc(now - timedelta(minutes=1))
            sess["idle_timeout_minutes"] = 480
    
        res = client.get("/settings", follow_redirects=False)
>       assert res.status_code in (302, 303)
E       assert 500 in (302, 303)
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_idle_timeout.py:77: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,259 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=57ca3befd9fa418abc4d0712cadc46c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,268 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=57ca3befd9fa418abc4d0712cadc46c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings 500
_______________________ test_intake_triage_invoice_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_invoice_lab0')

    def test_intake_triage_invoice_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post(
            "/api/intake/triage",
            json={
                "text": "Bitte Rechnung 2026-44 senden, Zahlung und Mahnung unklar.",
                "metadata": {"channel": "email"},
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:42: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,485 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=85aecc[REDACTED_PII]a6d17de95ae26d17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,486 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=85aecc2567744186a6d17de95ae26d17
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
_______________________ test_intake_triage_support_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_support_lab0')

    def test_intake_triage_support_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post(
            "/api/intake/triage",
            json={"text": "Störung in der Anlage, bitte dringend Hilfe."},
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:56: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,561 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=2f8a41d[REDACTED_PII]dc9939c8106ae[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,562 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=2f8a41d9425644dc9939c8106ae83942
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
_______________________ test_intake_triage_unknown_label _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_unknown_lab0')

    def test_intake_triage_unknown_label(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "Hallo zusammen"})
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:65: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,677 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=00eb97f680d74cd889a[REDACTED_PII]c00c4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,678 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=00eb97f680d74cd889a17135000c00c4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
________________________ test_intake_triage_validation _________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_validation0')

    def test_intake_triage_validation(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "   "})
>       assert resp.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:74: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,753 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=a18d0c42a43e4c679df1c354b[REDACTED_PII]ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,754 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=a18d0c42a43e4c679df1c354b62079ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
_______________________ test_intake_triage_requires_auth _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_requires_au0')

    def test_intake_triage_requires_auth(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        resp = client.post("/api/intake/triage", json={"text": "anfrage angebot"})
>       assert resp.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:85: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,828 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=5110b488c2774dcd[REDACTED_PII]d0b859c41
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,829 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=5110b488c2774dcd9986247d0b859c41
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
___________________ test_intake_triage_event_contains_tenant ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_intake_triage_event_conta0')

    def test_intake_triage_event_contains_tenant(tmp_path: Path) -> None:
        client = _client(tmp_path)
        resp = client.post("/api/intake/triage", json={"text": "Neukunde Anfrage"})
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_intake_triage.py:91: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:39,904 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=1a300b1ae20d4926a6ba[REDACTED_PII]af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:39,905 - kukanilea - INFO - POST /api/intake/triage 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=1a300b1ae20d4926a6ba9631019302af
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/intake/triage 500
_________ test_email_upload_denied_when_policy_off_and_no_rows_written _________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_email_upload_denied_when_0')

    def test_email_upload_denied_when_policy_off_and_no_rows_written(
        tmp_path: Path,
    ) -> None:
        client = _client(tmp_path)
        eml = b"From: a@example.com\nTo: b@example.com\nSubject: Test\n\nHallo"
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (eml, "sample.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_policy_default_deny.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,056 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=08b99f1f841b41b6af01c450acd2de7e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,066 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=08b99f1f841b41b6af01c450acd2de7e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /knowledge/email/upload 500
_______________________ test_oversize_upload_is_rejected _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_oversize_upload_is_reject0')

    def test_oversize_upload_is_rejected(tmp_path: Path) -> None:
        client = _client(tmp_path)
        eml = b"From:a@x.tld\nTo:b@y.tld\nSubject:x\n\n" + (b"x" * 4096)
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (io.BytesIO(eml), "big.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_security_limits.py:53: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,149 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6bbba18d71c74a278c4a000e0e3d6e7c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,158 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6bbba18d71c74a278c4a000e0e3d6e7c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /knowledge/email/upload 500
________________________ test_subject_newline_sanitized ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_subject_newline_sanitized0')

    def test_subject_newline_sanitized(tmp_path: Path) -> None:
        client = _client(tmp_path)
        eml = (
            b"From:a@x.tld\nTo:b@y.tld\n"
            b"Subject: Hello\r\nBcc: injected@evil.tld\n\n"
            b"Body with enough text to pass minimal threshold Body with enough text to pass."
        )
        resp = client.post(
            "/knowledge/email/upload",
            data={"file": (io.BytesIO(eml), "ok.eml")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_email_security_limits.py:68: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,242 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=98c[REDACTED_PII]e37ad1ea3ea1b5f3615
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,251 - kukanilea - INFO - POST /knowledge/email/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=98c5364607574e37ad1ea3ea1b5f3615
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /knowledge/email/upload 500
_____________________ test_ics_oversize_upload_is_rejected _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_ics_oversize_upload_is_re0')

    def test_ics_oversize_upload_is_rejected(tmp_path: Path) -> None:
        client = _client(tmp_path)
        data = b"BEGIN:VCALENDAR\nBEGIN:VEVENT\nSUMMARY:X\nEND:VEVENT\nEND:VCALENDAR\n" + (
            b"x" * 4096
        )
        resp = client.post(
            "/knowledge/ics/upload",
            data={"file": (io.BytesIO(data), "big.ics")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 413
E       assert 500 == 413
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_ics_limits.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,559 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=[REDACTED_PII]b7480d340c[REDACTED_PII]fda10ed79a29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,568 - kukanilea - INFO - POST /knowledge/ics/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=61725b7480d340c88759fda10ed79a29
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /knowledge/ics/upload 500
__________ test_ics_upload_denied_when_policy_off_and_no_rows_written __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_ics_upload_denied_when_po0')

    def test_ics_upload_denied_when_policy_off_and_no_rows_written(tmp_path: Path) -> None:
        client = _client(tmp_path)
        data = b"BEGIN:VCALENDAR\nBEGIN:VEVENT\nSUMMARY:X\nEND:VEVENT\nEND:VCALENDAR\n"
        resp = client.post(
            "/knowledge/ics/upload",
            data={"file": (io.BytesIO(data), "sample.ics")},
            content_type="multipart/form-data",
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_ics_policy_default_deny.py:40: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,643 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=b5f6890c5cbb44a48ca[REDACTED_PII]dd[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,652 - kukanilea - INFO - POST /knowledge/ics/upload 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=b5f6890c5cbb44a48ca79299dd409254
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /knowledge/ics/upload 500
__________________ test_read_only_blocks_note_mutations_route __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_read_only_blocks_note_mut0')

    def test_read_only_blocks_note_mutations_route(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        resp = client.post(
            "/api/knowledge/notes",
            json={"title": "x", "body": "y", "tags": "z"},
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_knowledge_notes_crud.py:76: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:40,768 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6114eee5fd2b4fd7954ef58fdb76a76e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:40,769 - kukanilea - INFO - POST /api/knowledge/notes 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6114eee5fd2b4fd7954ef58fdb76a76e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/knowledge/notes 500
____________________ test_claim_panel_escapes_user_content _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_claim_panel_escapes_user_0')

    def test_claim_panel_escapes_user_content(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "<script>alert(1)</script>"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_A"
    
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "A",
                "subject": "Lead",
                "message": "M",
            },
        )
        lead_id = (created.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_claims_template_safety.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,160 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=43b5b7a37e8e4e0ba46d6e49f94f7a67
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,161 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=43b5b7a37e8e4e0ba46d6e49f94f7a67
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
____________________ test_claim_and_collision_guard_routes _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_claim_and_collision_guard0')

    def test_claim_and_collision_guard_routes(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice")
        _set_session(c2, user="bob")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_claims_web.py:51: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_claims_web.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,236 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=ecf8c6ff[REDACTED_PII]c[REDACTED_PII]b34b14a8c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,237 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=ecf8c6ff7890419c9973042b34b14a8c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
____________________ test_claim_endpoints_read_only_blocked ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_claim_endpoints_read_only0')

    def test_claim_endpoints_read_only_blocked(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_claims_web.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_claims_web.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,313 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=4558de2e0b[REDACTED_PII]cfa9cea1cd98d7a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,314 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=4558de2e0b7948859cfa9cea1cd98d7a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
______________ test_lead_conversion_creates_deal_quote_and_links _______________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_conversion_creates_d0')

    def test_lead_conversion_creates_deal_quote_and_links(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice", tenant="TENANT_A")
    
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_conversion.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,390 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=66bcdcc0f[REDACTED_PII]bbb161ac41b159a12
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,390 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=66bcdcc0f743450bbb161ac41b159a12
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
___________ test_lead_conversion_blocked_when_claimed_by_other_user ____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_conversion_blocked_w0')

    def test_lead_conversion_blocked_when_claimed_by_other_user(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice", tenant="TENANT_A")
        _set_session(c2, user="bob", tenant="TENANT_A")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_conversion.py:180: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,508 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=27e[REDACTED_PII]a[REDACTED_PII]a2cc1c28d9347ad
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,509 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=27e29000a60243968a2cc1c28d9347ad
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
___________________ test_lead_conversion_is_tenant_isolated ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_conversion_is_tenant0')

    def test_lead_conversion_is_tenant_isolated(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        c1 = app.test_client()
        c2 = app.test_client()
        _set_session(c1, user="alice", tenant="TENANT_A")
        _set_session(c2, user="bob", tenant="TENANT_B")
    
>       lead_id = _new_lead(c1)
                  ^^^^^^^^^^^^^

tests/test_lead_conversion.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,587 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=fbb0337bd1ad4a9f[REDACTED_PII]cbcb894b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,587 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=fbb0337bd1ad4a9f86981277cbcb894b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
____________________ test_lead_conversion_read_only_blocked ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_conversion_read_only0')

    def test_lead_conversion_read_only_blocked(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice", tenant="TENANT_A")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_conversion.py:216: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "contact_email": "alice@example.com",
                "contact_phone": "+491701234567",
                "subject": "Dachsanierung am Objekt",
                "message": "Bitte Angebot erstellen",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_conversion.py:51: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,665 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=281c9fcb3e5a484da9dd0409a1a06d51
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,666 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=281c9fcb3e5a484da9dd0409a1a06d51
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_______________________ test_guard_allows_owner_mutation _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_guard_allows_owner_mutati0')

    def test_guard_allows_owner_mutation(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_allows_owner.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_allows_owner.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,743 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=790f633fa9354ebebd6c74db81b436d5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,744 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=790f633fa9354ebebd6c74db81b436d5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
________________ test_guard_blocks_non_owner_and_logs_collision ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_guard_blocks_non_owner_an0')

    def test_guard_blocks_non_owner_and_logs_collision(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", ANONYMIZATION_KEY="guard-key")
    
        owner = app.test_client()
        other = app.test_client()
        _set_session(owner, user="alice")
        _set_session(other, user="bob")
    
>       lead_id = _new_lead(owner)
                  ^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_blocks_claimed.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_blocks_claimed.py:36: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,819 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=1469b9f9aae[REDACTED_PII]e70ee1398e08d2f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,820 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=1469b9f9aae049028e70ee1398e08d2f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
________________ test_guard_blocks_mutations_in_read_only_mode _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_guard_blocks_mutations_in0')

    def test_guard_blocks_mutations_in_read_only_mode(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=False)
    
        client = app.test_client()
        _set_session(client, user="alice")
>       lead_id = _new_lead(client)
                  ^^^^^^^^^^^^^^^^^

tests/test_lead_guard_decorator_read_only.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _new_lead(client) -> str:
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dach",
                "message": "Bitte melden",
            },
        )
>       assert resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_guard_decorator_read_only.py:35: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:41,943 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=dc6e883ceeac4f158e7cf1a6cec[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:41,944 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=dc6e883ceeac4f158e7cf1a6cec00461
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_________________ test_lead_api_read_only_blocks_all_new_posts _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_api_read_only_blocks0')

    def test_lead_api_read_only_blocks_all_new_posts(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        lead_id = "abc123"
        routes = [
            ("POST", "/api/leads", {"source": "manual", "subject": "X"}),
            ("POST", f"/api/leads/{lead_id}/screen/accept", {}),
            ("POST", f"/api/leads/{lead_id}/screen/ignore", {}),
            ("PUT", f"/api/leads/{lead_id}/priority", {"priority": "high", "pinned": 1}),
            ("PUT", f"/api/leads/{lead_id}/assign", {"assigned_to": "dev"}),
            ("POST", "/api/leads/blocklist", {"kind": "email", "value": "a@example.com"}),
        ]
    
        for method, url, body in routes:
            resp = client.open(url, method=method, json=body)
>           assert resp.status_code == 403
E           assert 500 == 403
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:62: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:42,019 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=aa1c93df7f1c4cf4a37c91f4554c9259
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:42,020 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=aa1c93df7f1c4cf4a37c91f4554c9259
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
________________ test_lead_api_validation_and_tenant_isolation _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_lead_api_validation_and_t0')

    def test_lead_api_validation_and_tenant_isolation(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        bad = client.post("/api/leads", json={"source": "invalid", "subject": "X"})
>       assert bad.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:73: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:42,138 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=6eec[REDACTED_PII]bb7f94ef[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:42,139 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=6eec667304914349bb7f94ef16747305
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_________________ test_actor_user_id_written_to_event_payload __________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_actor_user_id_written_to_0')

    def test_actor_user_id_written_to_event_payload(tmp_path: Path) -> None:
        client = _client(tmp_path)
>       lead_id = _create_lead(client)
                  ^^^^^^^^^^^^^^^^^^^^

tests/test_lead_intake_api.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <FlaskClient <Flask 'app'>>

    def _create_lead(client) -> str:
        created = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "Alice",
                "subject": "Dachreparatur",
                "message": "Bitte melden",
            },
        )
>       assert created.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_lead_intake_api.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:42,215 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=e5ad0a942b354cf09d41baddc7d438dd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:42,215 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=e5ad0a942b354cf09d41baddc7d438dd
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
______________________ test_xss_payload_is_escaped_in_ui _______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_xss_payload_is_escaped_in0')

    def test_xss_payload_is_escaped_in_ui(tmp_path: Path) -> None:
        client = _client(tmp_path)
        bad_subject = "<script>alert(1)</script>"
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "X",
                "subject": bad_subject,
                "message": "m",
            },
        )
        lead_id = (resp.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_intake_api.py:117: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:42,292 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=3f3d225f5e1e4f2589f26e2a8c42b3a8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:42,293 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=3f3d225f5e1e4f2589f26e2a8c42b3a8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
_____________________ test_ics_crlf_injection_is_sanitized _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_ics_crlf_injection_is_san0')

    def test_ics_crlf_injection_is_sanitized(tmp_path: Path) -> None:
        client = _client(tmp_path)
        subject = "Bad\\r\\nBEGIN:VEVENT"
        resp = client.post(
            "/api/leads",
            json={
                "source": "manual",
                "contact_name": "X",
                "subject": subject,
                "message": "m",
            },
        )
        lead_id = (resp.get_json() or {}).get("lead_id")
>       assert lead_id
E       assert None

tests/test_lead_intake_api.py:142: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:42,369 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=d639f835b3a54f2e[REDACTED_PII]dab[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:42,370 - kukanilea - INFO - POST /api/leads 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=d639f835b3a54f2e81712600dab50609
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/leads 500
___________________ test_read_only_blocks_mutating_requests ____________________

    def test_read_only_blocks_mutating_requests() -> None:
        app = create_app()
        app.config["READ_ONLY"] = True
        app.config["LICENSE_REASON"] = "trial_expired"
        client = app.test_client()
    
        resp = client.post("/api/chat", json={"q": "hallo"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_license_read_only.py:18: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:43,719 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f[REDACTED_PII]f2e842f4a7ec3fda59aa277e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:43,720 - kukanilea - INFO - POST /api/chat 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f8227128f2e842f4a7ec3fda59aa277e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/chat 500
_______________________ test_conversations_pages_render ________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_conversations_pages_rende0')

    def test_conversations_pages_render(tmp_path: Path) -> None:
        client, event_id = _client(tmp_path)
        list_resp = client.get("/conversations")
>       assert list_resp.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_omni_web.py:44: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:44,961 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=31e81bd0a[REDACTED_PII]eaace26e62a1bc99c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:44,970 - kukanilea - INFO - GET /conversations 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=31e81bd0a76541eaace26e62a1bc99c1
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /conversations 500
_____________________ test_conversations_tenant_isolation ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_conversations_tenant_isol0')

    def test_conversations_tenant_isolation(tmp_path: Path) -> None:
        client, event_id = _client(tmp_path)
        with client.session_transaction() as sess:
            sess["tenant_id"] = "TENANT_B"
        resp = client.get(f"/conversations/{event_id}")
>       assert resp.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_omni_web.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,051 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_B request_id=149e1989b4a64f9a9d21e15cae38c0cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,060 - kukanilea - INFO - GET /conversations/[REDACTED_PII]b[REDACTED_PII]d[REDACTED_PII]e4 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_B request_id=149e1989b4a64f9a9d21e15cae38c0cb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /conversations/55529b978810410487d95151483293e4 500
___________________________ test_onboarding_seeding ____________________________

    def test_onboarding_seeding():
        """Verify that vertical kit selection seeds the database correctly."""
        init_db()
    
        # Select SHK kit
        headers = {
            "X-Tenant-ID": "test-tenant",
            "X-User-ID": "test-user",
            "X-Role": "ADMIN",
        }
        response = client.post(
            "/ui/onboarding/setup", data={"vertical": "shk"}, headers=headers
        )
        assert response.status_code == 204
        assert response.headers["HX-Redirect"] == "/crm/"
    
        # Check DB content
        conn = get_db_connection()
        rows = conn.execute("SELECT name FROM templates WHERE vertical = 'shk'").fetchall()
        names = [row["name"] for row in rows]
    
>       assert "Protokoll: Wartung Gastherme" in names
E       AssertionError: assert 'Protokoll: Wartung Gastherme' in []

tests/test_onboarding.py:30: AssertionError
----------------------------- Captured stdout call -----------------------------
Database initialized at instance/kukanilea.db with FTS5.
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,064 - kukanilea.onboarding - INFO - User test-user applying Vertical Kit: shk
[REDACTED_PII] 23:28:45,065 - kukanilea.seeder - INFO - Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
[REDACTED_PII] 23:28:45,065 - kukanilea.onboarding - INFO - Successfully seeded vertical 'shk'.
------------------------------ Captured log call -------------------------------
INFO     kukanilea.onboarding:onboarding.py:37 User test-user applying Vertical Kit: shk
INFO     kukanilea.seeder:seeder.py:35 Successfully applied vertical kit 'shk' for tenant 'test-tenant'.
INFO     kukanilea.onboarding:onboarding.py:45 Successfully seeded vertical 'shk'.
__________________________ test_postfach_page_renders __________________________

    def test_postfach_page_renders() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/postfach")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:57: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,542 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=274b0cb[REDACTED_PII]d7b628e[REDACTED_PII]ecaee0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,551 - kukanilea - INFO - GET /postfach 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=274b0cb6799849d7b628e21413ecaee0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /postfach 500
______________ test_postfach_page_shows_key_warning_when_missing _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f1906b0>

    def test_postfach_page_shows_key_warning_when_missing(monkeypatch) -> None:
        monkeypatch.delenv("EMAIL_ENCRYPTION_KEY", raising=False)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/postfach")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:69: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,603 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=613ef8bea7f04e2b99a6595e7ce6da05
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,611 - kukanilea - INFO - GET /postfach 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=613ef8bea7f04e2b99a6595e7ce6da05
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /postfach 500
____________________ test_mail_route_redirects_to_postfach _____________________

    def test_mail_route_redirects_to_postfach() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.get("/mail", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:81: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,662 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f541ca8724dd4f91a8f9cfe150bda67b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,671 - kukanilea - INFO - GET /mail 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f541ca8724dd4f91a8f9cfe150bda67b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /mail 500
______________ test_postfach_account_add_fails_closed_without_key ______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f0d8ce0>

    def test_postfach_account_add_fails_closed_without_key(monkeypatch) -> None:
        monkeypatch.delenv("EMAIL_ENCRYPTION_KEY", raising=False)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
    
        res = client.post(
            "/postfach/accounts/add",
            data={
                "label": "Demo",
                "imap_host": "imap.example.com",
                "imap_port": "993",
                "imap_username": "user@example.com",
                "secret": "pass",
            },
            follow_redirects=True,
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:103: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,722 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=57e8c[REDACTED_PII]f[REDACTED_PII]baeec9fb32e5f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,731 - kukanilea - INFO - POST /postfach/accounts/add 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=57e8c51433194f56974baeec9fb32e5f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /postfach/accounts/add 500
_____________ test_postfach_oauth_start_sets_session_and_redirects _____________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_postfach_oauth_start_sets0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f871d90>

    def test_postfach_oauth_start_sets_session_and_redirects(
        tmp_path: Path, monkeypatch
    ) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            GOOGLE_CLIENT_ID="google-client-id",
            GOOGLE_CLIENT_SECRET="google-client-secret",
            OAUTH_REDIRECT_BASE="http://127.0.0.1:5051",
        )
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="OAuth Google",
            imap_host="imap.gmail.com",
            imap_port=993,
            imap_username="user@example.com",
            smtp_host="smtp.gmail.com",
            smtp_port=465,
            smtp_username="user@example.com",
            smtp_use_ssl=True,
            secret_plain="",
            auth_mode="oauth_google",
            oauth_provider="google",
        )
        monkeypatch.setattr(
            "app.web.postfach_build_authorization_url",
            lambda **kwargs: "https://accounts.google.com/o/oauth2/v2/auth?state=test",
        )
        client = app.test_client()
        _login(client)
        res = client.post(
            "/postfach/accounts/oauth/start",
            data={"account_id": account_id},
            follow_redirects=False,
        )
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:146: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,841 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=39d1abeebd204c[REDACTED_PII]f7d969de4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,851 - kukanilea - INFO - POST /postfach/accounts/oauth/start 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=39d1abeebd204c508146221f7d969de4
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /postfach/accounts/oauth/start 500
___________________ test_postfach_oauth_callback_saves_token ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_postfach_oauth_callback_s0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fe01250>

    def test_postfach_oauth_callback_saves_token(tmp_path: Path, monkeypatch) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(
            TESTING=True,
            SECRET_KEY="test",
            GOOGLE_CLIENT_ID="google-client-id",
            GOOGLE_CLIENT_SECRET="google-client-secret",
            OAUTH_REDIRECT_BASE="http://127.0.0.1:5051",
        )
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="OAuth Google",
            imap_host="imap.gmail.com",
            imap_port=993,
            imap_username="user@example.com",
            smtp_host="smtp.gmail.com",
            smtp_port=465,
            smtp_username="user@example.com",
            smtp_use_ssl=True,
            secret_plain="",
            auth_mode="oauth_google",
            oauth_provider="google",
        )
        monkeypatch.setattr(
            "app.web.postfach_exchange_code_for_tokens",
            lambda **kwargs: {
                "access_token": "access-token",
                "refresh_token": "refresh-token",
                "expires_at": "2099-01-01T00:00:00+00:00",
                "scopes": ["https://mail.google.com/"],
                "token_type": "Bearer",
            },
        )
        client = app.test_client()
        _login(client)
        with client.session_transaction() as sess:
            sess["postfach_oauth_state"] = "state-123"
            sess["postfach_oauth_verifier"] = "verifier-123"
            sess["postfach_oauth_account_id"] = account_id
            sess["postfach_oauth_provider"] = "google"
    
        res = client.get(
            "/postfach/accounts/oauth/callback?state=state-123&code=auth-code-123",
            follow_redirects=False,
        )
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:203: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:45,940 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=2c97ef7da[REDACTED_PII]c[REDACTED_PII]de2cf3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:45,949 - kukanilea - INFO - GET /postfach/accounts/oauth/callback 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=2c97ef7da6194766808c319527de2cf3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /postfach/accounts/oauth/callback 500
__________ test_postfach_send_requires_safety_ack_when_warnings_exist __________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_postfach_send_requires_sa0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f2d8c20>

    def test_postfach_send_requires_safety_ack_when_warnings_exist(
        tmp_path: Path, monkeypatch
    ) -> None:
        monkeypatch.setenv("EMAIL_ENCRYPTION_KEY", "dev-secret-key")
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        account_id = create_account(
            db_path,
            tenant_id="KUKANILEA",
            label="SMTP",
            imap_host="imap.example.com",
            imap_port=993,
            imap_username="sender@example.com",
            smtp_host="smtp.example.com",
            smtp_port=465,
            smtp_username="sender@example.com",
            smtp_use_ssl=True,
            secret_plain="secret",
        )
        draft_id = create_draft(
            db_path,
            tenant_id="KUKANILEA",
            account_id=account_id,
            thread_id=None,
            to_value="recipient@other-domain.com",
            subject_value="Angebot",
            body_value="Link: https://bit.ly/test und IBAN DE89370400440532013000",
        )
        client = app.test_client()
        _login(client)
        blocked = client.post(
            "/postfach/drafts/send",
            data={
                "draft_id": draft_id,
                "account_id": account_id,
                "thread_id": "",
                "user_confirmed": "1",
            },
            follow_redirects=True,
        )
>       assert blocked.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_postfach_web.py:255: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:46,043 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=3611a2f038db497daa979d29c582e2d5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:46,052 - kukanilea - INFO - POST /postfach/drafts/send 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=3611a2f038db497daa979d29c582e2d5
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /postfach/drafts/send 500
____________________ test_permissions_manager_denies_office ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f307ce0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_permissions_manager_denie0')

    def test_permissions_manager_denies_office(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        _seed_user(app, username="office", role="OFFICE")
        client = app.test_client()
        _login(client, "office", "OPERATOR")
        res = client.get("/settings/permissions")
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:54: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:46,294 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d[REDACTED_PII]d4f[REDACTED_PII]a40b57edae5a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:46,303 - kukanilea - INFO - GET /settings/permissions 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=24713d93425d4f958163a40b57edae5a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings/permissions 500
_________________ test_permissions_manager_allows_owner_admin __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ecf8380>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_permissions_manager_allow0')

    def test_permissions_manager_allows_owner_admin(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        client = app.test_client()
        _login(client, "owner", "ADMIN")
        res = client.get("/settings/permissions")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:63: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:46,390 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a8bca1784b154dd69af[REDACTED_PII]ed85d669
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:46,399 - kukanilea - INFO - GET /settings/permissions 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a8bca1784b154dd69af07580ed85d669
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings/permissions 500
_________________________ test_dev_update_is_dev_only __________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fb77b60>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_update_is_dev_only0')

    def test_dev_update_is_dev_only(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        _seed_user(app, username="owner", role="OWNER_ADMIN")
        _seed_user(app, username="dev", role="DEV")
        client = app.test_client()
    
        _login(client, "owner", "ADMIN")
        denied = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert denied.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_rbac_permissions.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:46,558 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]cc[REDACTED_PII]a1a565c[REDACTED_PII]fb0e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:46,567 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d098102cc91945a1a565c754267fb0e6
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
__________________ test_read_only_crm_endpoints_do_not_write ___________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_read_only_crm_endpoints_d0')

    def test_read_only_crm_endpoints_do_not_write(tmp_path: Path) -> None:
        _init_core(tmp_path)
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test", READ_ONLY=True)
        client = app.test_client()
    
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "ADMIN"
            sess["tenant_id"] = "TENANT_A"
    
        resp = client.post("/api/customers", json={"name": "Blocked"})
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_read_only_crm_api.py:31: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:46,859 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=09cb2c4f[REDACTED_PII]ac4859dc77feac076c7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:46,860 - kukanilea - INFO - POST /api/customers 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=09cb2c4f36664ac4859dc77feac076c7
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/customers 500
_____________________ test_settings_available_for_operator _____________________

    def test_settings_available_for_operator():
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, "OPERATOR")
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_settings_and_open.py:19: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:48,422 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=c09c387d576f40eda9496e5d4f1cc139
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:48,431 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=c09c387d576f40eda9496e5d4f1cc139
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings 500
______________________ test_open_by_token_creates_pending ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_open_by_token_creates_pen0')
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10eeeb8c0>

    def test_open_by_token_creates_pending(tmp_path, monkeypatch):
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, "ADMIN")
    
        sample = tmp_path / "doc.pdf"
        sample.write_text("sample")
        monkeypatch.setattr(
            web, "db_latest_path_for_doc", lambda doc_id, tenant_id="": str(sample)
        )
        monkeypatch.setattr(web, "analyze_to_pending", lambda path: "newtoken123")
    
        res = client.post("/api/open", json={"token": "abc123"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_settings_and_open.py:37: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:48,482 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=24e97ccf572d4fb483f05dd8416db05e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:48,483 - kukanilea - INFO - POST /api/open 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=24e97ccf572d4fb483f05dd8416db05e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/open 500
________________________ test_api_status_requires_login ________________________

    def test_api_status_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
    
        res = client.get("/api/status")
>       assert res.status_code == 401
E       assert 500 == 401
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:26: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:49,357 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=6ee9041d916a4e[REDACTED_PII]e87fafd09a51
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:49,358 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=6ee9041d916a4e429267e87fafd09a51
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
__________________ test_api_status_reports_queue_and_running ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f1e06b0>

    def test_api_status_reports_queue_and_running(monkeypatch) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="DEV", username="status_dev")
        _reset_job_trackers()
    
        monkeypatch.setattr(
            webmod,
            "list_pending",
            lambda: [
                {"_token": "a", "status": "ANALYZING"},
                {"_token": "b", "status": "ERROR"},
                {"_token": "c", "status": "READY"},
            ],
        )
        monkeypatch.setattr(
            webmod,
            "_ocr_status_snapshot",
            lambda tenant_id: {
                "available": True,
                "pending": 2,
                "processing": 1,
                "failed_24h": 0,
                "last_event_at": "",
            },
        )
        webmod._job_tracker_start("index")
    
        res = client.get("/api/status")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:64: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:49,454 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=6f841e1caf604f48a1ca752c16e[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:49,455 - kukanilea - INFO - GET /api/status 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=6f841e1caf604f48a1ca752c16e76489
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /api/status 500
______________________ test_dev_test_llm_updates_tracker _______________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ee8aff0>

    def test_dev_test_llm_updates_tracker(monkeypatch) -> None:
        class _FakeLLM:
            name = "fake-llm"
    
            def rewrite_query(self, q: str):
                return {"intent": "search", "query": q}
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, role="DEV", username="llm_dev")
        _reset_job_trackers()
    
        monkeypatch.setattr(webmod.ORCHESTRATOR, "llm", _FakeLLM(), raising=False)
    
        res = client.post("/api/dev/test-llm", json={"q": "rechnung 123"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_status_endpoint.py:92: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:49,505 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b[REDACTED_PII]d9d3fa442aa74f110a1735e4c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:49,506 - kukanilea - INFO - POST /api/dev/test-llm 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b41749d9d3fa442aa74f110a1735e4c3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/dev/test-llm 500
___________________ test_tags_page_and_assign_unassign_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tags_page_and_assign_unas0')

    def test_tags_page_and_assign_unassign_flow(tmp_path: Path) -> None:
        client = _client(tmp_path)
        note = knowledge_note_create("TENANT_A", "dev", "N1", "Body", "a")
        tag = tag_create("TENANT_A", "Alpha", actor_user_id="dev")
    
        page = client.get("/tags")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tags_web.py:38: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,124 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=a[REDACTED_PII]a5d[REDACTED_PII]cbba[REDACTED_PII]ce[REDACTED_PII]b3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,134 - kukanilea - INFO - GET /tags 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=a46168a5d43442cbba48197ce16225b3
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /tags 500
_________________________ test_tags_read_only_blocked __________________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tags_read_only_blocked0')

    def test_tags_read_only_blocked(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
    
        resp = client.post(
            "/tags/create",
            data={"name": "Blocked", "color": "#112233"},
        )
>       assert resp.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tags_web.py:69: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,211 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=e[REDACTED_PII]c9c4ccca32a[REDACTED_PII]e539b0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,220 - kukanilea - INFO - POST /tags/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=e51337487c9c4ccca32a322847e539b0
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /tags/create 500
____________________ test_tasks_kanban_create_and_move_flow ____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tasks_kanban_create_and_m0')

    def test_tasks_kanban_create_and_move_flow(tmp_path: Path) -> None:
        client = _client(tmp_path)
    
        create = client.post(
            "/api/tasks/create",
            json={
                "title": "Kanban Test Task",
                "task_type": "GENERAL",
                "severity": "INFO",
                "details": "sample",
            },
        )
>       assert create.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:42: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,295 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=5e8f006e2da043ba9ec06b369d[REDACTED_PII]c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,296 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=5e8f006e2da043ba9ec06b369d62762c
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/tasks/create 500
____________________ test_tasks_read_only_blocks_mutations _____________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tasks_read_only_blocks_mu0')

    def test_tasks_read_only_blocks_mutations(tmp_path: Path) -> None:
        client = _client(tmp_path, read_only=True)
        create = client.post("/api/tasks/create", json={"title": "Blocked Task"})
>       assert create.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:72: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,371 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_A request_id=1a94f92b94ad448c8b[REDACTED_PII]d1da241
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,372 - kukanilea - INFO - POST /api/tasks/create 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_A request_id=1a94f92b94ad448c8b8981911d1da241
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/tasks/create 500
_____________________ test_tasks_tenant_isolation_on_move ______________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tasks_tenant_isolation_on0')

    def test_tasks_tenant_isolation_on_move(tmp_path: Path) -> None:
        _init_core(tmp_path)
        task_id = core.task_create(
            tenant="TENANT_A",
            severity="INFO",
            task_type="GENERAL",
            title="Tenant Task",
            details="x",
            created_by="seed",
        )
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        with client.session_transaction() as sess:
            sess["user"] = "dev"
            sess["role"] = "OPERATOR"
            sess["tenant_id"] = "TENANT_B"
    
        move = client.post(
            f"/api/tasks/{int(task_id)}/move",
            json={"column": "done"},
        )
>       assert move.status_code == 404
E       assert 500 == 404
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tasks_kanban_web.py:99: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,451 - kukanilea - ERROR - unhandled_exception tenant_id=TENANT_B request_id=dc13c[REDACTED_PII]ff4e21bb32da271b294adf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,452 - kukanilea - INFO - POST /api/tasks/1/move 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=TENANT_B request_id=dc13c08765ff4e21bb32da271b294adf
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /api/tasks/1/move 500
___________ test_tenant_context_is_set_and_overrides_session_tenant ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fbbdd90>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_tenant_context_is_set_and0')

    def test_tenant_context_is_set_and_overrides_session_tenant(
        monkeypatch, tmp_path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="ADMIN", tenant_id="TENANT_EVASION")
    
        res = client.get("/settings")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:58: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,635 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=af4defdd[REDACTED_PII]ab1c4c5115afba4ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,645 - kukanilea - INFO - GET /settings 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=af4defdd0420443ab1c4c5115afba4ef
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /settings 500
_________________ test_dev_can_edit_tenant_name_localhost_only _________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10fbbe390>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_can_edit_tenant_name_0')

    def test_dev_can_edit_tenant_name_localhost_only(monkeypatch, tmp_path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
    
        res = client.post(
            "/dev/tenant",
            data={"tenant_name": "ACME Handwerk"},
            environ_overrides={"REMOTE_ADDR": "127.0.0.1"},
        )
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:81: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,705 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8bf5d2765d[REDACTED_PII]e8a476b1edd31e96f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,714 - kukanilea - INFO - POST /dev/tenant 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8bf5d2765d80424e8a476b1edd31e96f
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /dev/tenant 500
___________ test_dev_tenant_override_forbidden_for_remote_or_non_dev ___________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f3354f0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_tenant_override_forbi0')

    def test_dev_tenant_override_forbidden_for_remote_or_non_dev(
        monkeypatch, tmp_path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
    
        remote = client.get("/dev/tenant", environ_overrides={"REMOTE_ADDR": "10.0.0.9"})
>       assert remote.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_tenant_isolation.py:99: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,774 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=a7c5ff491da44f799b9d49f9174a95aa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,783 - kukanilea - INFO - GET /dev/tenant 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=a7c5ff491da44f799b9d49f9174a95aa
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 271, in _set_tenant_context
    if session.get("tenant_id") != ctx.tenant_id:
       ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/tenant 500
______________________ test_shell_default_theme_is_light _______________________

    def test_shell_default_theme_is_light() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        auth_db = app.extensions["auth_db"]
        auth_db.set_user_preference("dev", "ui.theme", "light")
        client = app.test_client()
        _login(client)
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_theme_default.py:21: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:50,834 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]d1720e64e9b86a590dfd316a941
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:50,843 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=02011d1720e64e9b86a590dfd316a941
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
________________ test_default_theme_is_light_when_no_preference ________________

    def test_default_theme_is_light_when_no_preference() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_default_user")
    
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:20: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,212 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=f2bb5633a[REDACTED_PII]ced4b1d4c79
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,221 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=f2bb5633a627420298442ced4b1d4c79
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
__________________ test_theme_preference_loaded_from_auth_db ___________________

    def test_theme_preference_loaded_from_auth_db() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        auth_db = app.extensions["auth_db"]
        auth_db.set_user_preference("theme_dark_user", "ui.theme", "dark")
        client = app.test_client()
        _login(client, username="theme_dark_user")
    
        res = client.get("/")
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:33: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,272 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=bea8a5306f464e5ea[REDACTED_PII]fbd2f31e0e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,281 - kukanilea - INFO - GET / 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=bea8a5306f464e5ea17616fbd2f31e0e
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET / 500
_________________ test_theme_preference_route_persists_setting _________________

    def test_theme_preference_route_persists_setting() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_route_user")
    
        res = client.post("/settings/ui/theme", json={"theme": "dark"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:44: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,332 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=7eaca996af7b[REDACTED_PII]b1c72cb[REDACTED_PII]ee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,341 - kukanilea - INFO - POST /settings/ui/theme 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=7eaca996af7b48049b1c72cb467018ee
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /settings/ui/theme 500
_______________ test_sidebar_preference_route_and_shell_default ________________

    def test_sidebar_preference_route_and_shell_default() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="sidebar_route_user")
    
        save = client.post("/settings/ui/sidebar", json={"collapsed": True})
>       assert save.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,436 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=[REDACTED_PII]f87de946d38f[REDACTED_PII]c8e4830d9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,446 - kukanilea - INFO - POST /settings/ui/sidebar 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=041044f87de946d38f62469c8e4830d9
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /settings/ui/sidebar 500
____________________ test_theme_route_rejects_invalid_value ____________________

    def test_theme_route_rejects_invalid_value() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client, username="theme_invalid_user")
    
        res = client.post("/settings/ui/theme", json={"theme": "sepia"})
>       assert res.status_code == 400
E       assert 500 == 400
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_ui_preferences.py:75: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,496 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=09eb53f[REDACTED_PII]c09f944e727c692a59
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,506 - kukanilea - INFO - POST /settings/ui/theme 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=09eb53f1427846c09f944e727c692a59
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 POST /settings/ui/theme 500
___________________ test_dev_update_route_requires_dev_role ____________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10e161ac0>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_update_route_requires0')

    def test_dev_update_route_requires_dev_role(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="ADMIN")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:41: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,576 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=106ed[REDACTED_PII]f4d8692ec2e6b8a4c07db
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,585 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=106ed999828f4d8692ec2e6b8a4c07db
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
___________________ test_dev_update_route_requires_localhost ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10ebe0140>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_update_route_requires1')

    def test_dev_update_route_requires_localhost(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "10.0.0.8"})
>       assert res.status_code == 403
E       assert 500 == 403
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,645 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=954caae7a7894f9e96cf43ec91cb5ace
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,654 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=954caae7a7894f9e96cf43ec91cb5ace
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
_______________ test_dev_update_route_renders_for_dev_localhost ________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f434290>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_dev_update_route_renders_0')

    def test_dev_update_route_renders_for_dev_localhost(
        monkeypatch, tmp_path: Path
    ) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        res = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       assert res.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_update_routes.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,713 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=8d[REDACTED_PII]e[REDACTED_PII]c9125b[REDACTED_PII]
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,722 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=8d5496472e37438789310c9125b46339
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
__________________ test_install_action_blocked_when_disabled ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10f191700>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_install_action_blocked_wh0')

    def test_install_action_blocked_when_disabled(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        client = app.test_client()
        _login(client, role="DEV")
        page = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       csrf = _csrf_from_html(page.data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_update_routes.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

payload = b'<!doctype html>\n<html lang="de" data-theme="light">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content=... btn.dataset.q || \'\';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n</script>\n</body>\n</html>'

    def _csrf_from_html(payload: bytes) -> str:
        match = re.search(rb'name="csrf_token"\s+value="([^"]+)"', payload)
>       assert match is not None
E       assert None is not None

tests/test_update_routes.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,781 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=eb64c8e69a0d4206becfc4c97daf95fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,790 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=eb64c8e69a0d4206becfc4c97daf95fb
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
__________________ test_install_action_calls_update_pipeline ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x10e537770>
tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_install_action_calls_upda0')

    def test_install_action_calls_update_pipeline(monkeypatch, tmp_path: Path) -> None:
        app = _make_app(monkeypatch, tmp_path)
        app.config["UPDATE_INSTALL_ENABLED"] = True
        app.config["UPDATE_INSTALL_TIMEOUT_SECONDS"] = 5
        client = app.test_client()
        _login(client, role="DEV")
    
        calls: list[str] = []
    
        def _fake_check(*args, **kwargs):
            calls.append("check")
            return {
                "checked": True,
                "update_available": True,
                "latest_version": "1.0.0-beta.2",
                "release_url": "https://example/release",
                "asset_name": "KUKANILEA.zip",
                "asset_url": "https://example/KUKANILEA.zip",
                "sha256": "a" * 64,
                "error": "",
            }
    
        def _fake_download(*args, **kwargs):
            calls.append("download")
            archive = tmp_path / "download.zip"
            archive.write_bytes(b"ZIP")
            return archive
    
        def _fake_install(*args, **kwargs):
            calls.append("install")
            return {
                "app_dir": str(tmp_path / "KUKANILEA.app"),
                "backup_dir": str(tmp_path / "KUKANILEA.app.backup"),
                "data_dir": str(tmp_path / "data"),
                "sha256": "a" * 64,
            }
    
        import app.web as webmod
    
        monkeypatch.setattr(webmod, "check_for_installable_update", _fake_check)
        monkeypatch.setattr(webmod, "download_update_asset", _fake_download)
        monkeypatch.setattr(webmod, "install_update_from_archive", _fake_install)
    
        page = client.get("/dev/update", environ_overrides={"REMOTE_ADDR": "127.0.0.1"})
>       csrf = _csrf_from_html(page.data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_update_routes.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

payload = b'<!doctype html>\n<html lang="de" data-theme="light">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content=... btn.dataset.q || \'\';\n      _cwSend();\n    });\n  });\n  _cwRefreshAiStatus();\n})();\n</script>\n</body>\n</html>'

    def _csrf_from_html(payload: bytes) -> str:
        match = re.search(rb'name="csrf_token"\s+value="([^"]+)"', payload)
>       assert match is not None
E       assert None is not None

tests/test_update_routes.py:32: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,851 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=fba4eb7e7d[REDACTED_PII]a259e7163b91b834
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:51,860 - kukanilea - INFO - GET /dev/update 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=fba4eb7e7d044539a259e7163b91b834
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /dev/update 500
________________ test_upgrade_smoke_automation_schema_and_page _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_upgrade_smoke_automation_0')

    def test_upgrade_smoke_automation_schema_and_page(tmp_path: Path) -> None:
        db_path = tmp_path / "legacy.sqlite3"
        _bootstrap_legacy_automation_schema(db_path)
    
        ensure_automation_schema(db_path)
    
        rule_columns = _table_columns(db_path, RULE_TABLE)
        assert "max_executions_per_minute" in rule_columns
    
        pending_columns = _table_columns(db_path, PENDING_ACTION_TABLE)
        assert "status" in pending_columns
        assert "confirm_token" in pending_columns
    
        con = sqlite3.connect(str(db_path), timeout=30)
        con.row_factory = sqlite3.Row
        try:
            index_rows = con.execute(
                "SELECT name FROM sqlite_master WHERE type='index' AND tbl_name=?",
                (PENDING_ACTION_TABLE,),
            ).fetchall()
            index_names = {str(row["name"]) for row in index_rows}
            assert (
                "idx_automation_builder_pending_actions_tenant_confirm_token" in index_names
            )
        finally:
            con.close()
    
        webmod.core.DB_PATH = db_path
        core.DB_PATH = db_path
    
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        _login(client)
        page = client.get("/automation")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_upgrade.py:104: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:51,994 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=d[REDACTED_PII]e[REDACTED_PII]ef009a327e54b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:52,004 - kukanilea - INFO - GET /automation 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=d07284e553174557804ef009a327e54b
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /automation 500
________________________ test_workflows_requires_login _________________________

    def test_workflows_requires_login() -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        client = app.test_client()
        res = client.get("/workflows", follow_redirects=False)
>       assert res.status_code in {301, 302}
E       assert 500 in {301, 302}
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:37: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:52,054 - kukanilea - ERROR - unhandled_exception tenant_id=None request_id=f00fd8e8fe5e40fc9a1a21ed6fa040c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:52,063 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=None request_id=f00fd8e8fe5e40fc9a1a21ed6fa040c8
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /workflows 500
_________________ test_workflow_template_install_is_idempotent _________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_workflow_template_install0')

    def test_workflow_template_install_is_idempotent(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
    
        page = client.get("/workflows")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:49: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:52,115 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=058bb461ca[REDACTED_PII]b8c3182a[REDACTED_PII]a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:52,124 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=058bb461ca51477b8c3182a83443801a
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /workflows 500
_______________ test_workflow_toggle_route_updates_enabled_flag ________________

tmp_path = PosixPath('/private/var/folders/45/r3ph_5550cg624k1l4c54_840000gn/T/pytest-of-gensuminguyen/pytest-132/test_workflow_toggle_route_upd0')

    def test_workflow_toggle_route_updates_enabled_flag(tmp_path: Path) -> None:
        app = create_app()
        app.config.update(TESTING=True, SECRET_KEY="test")
        db_path = _set_core_db(tmp_path)
        client = app.test_client()
        _login(client)
    
        page = client.get("/workflows")
>       assert page.status_code == 200
E       assert 500 == 200
E        +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

tests/test_workflows_web.py:83: AssertionError
----------------------------- Captured stderr call -----------------------------
[REDACTED_PII] 23:28:52,195 - kukanilea - ERROR - unhandled_exception tenant_id=KUKANILEA request_id=b9b5ded3a6974ad[REDACTED_PII]f371c19b7f37
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
[REDACTED_PII] 23:28:52,204 - kukanilea - INFO - GET /workflows 500
------------------------------ Captured log call -------------------------------
ERROR    kukanilea:__init__.py:405 unhandled_exception tenant_id=KUKANILEA request_id=b9b5ded3a6974ad59059f371c19b7f37
Traceback (most recent call last):
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 915, in full_dispatch_request
    rv = self.preprocess_request()
         ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/flask/app.py", line 1291, in preprocess_request
    rv = self.ensure_sync(before_func)()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gensuminguyen/Tophandwerk/kukanilea-git/app/__init__.py", line 280, in _enforce_session_timeouts
    if not session.get("user"):
           ^^^^^^^^^^^
AttributeError: module 'app.session' has no attribute 'get'
INFO     kukanilea:__init__.py:116 GET /workflows 500
=============================== warnings summary ===============================
kukanilea_app.py:40
  /Users/gensuminguyen/Tophandwerk/kukanilea-git/kukanilea_app.py:40: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/fastapi/applications.py:4573: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/test_offline_proof.py::test_csp_header_enforces_offline_policy
tests/test_offline_proof.py::test_no_rogue_external_urls_in_rendered_html
  /Users/gensuminguyen/.pyenv/versions/3.12.0/lib/python3.12/site-packages/starlette/templating.py:162: DeprecationWarning: The `name` is not the first parameter anymore. The first parameter should be the `Request` instance.
  Replace `TemplateResponse(name, {"request": request})` by `TemplateResponse(request, name)`.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/e2e/test_ai_chat.py::test_ai_chat_widget_with_mocked_orchestrator[chromium]
FAILED tests/e2e/test_ai_smoke.py::test_ai_status_and_chat_smoke_with_mock[chromium]
FAILED tests/e2e/test_crm.py::test_crm_customers_page_loads[chromium] - Asser...
FAILED tests/e2e/test_docs.py::test_knowledge_settings_page_loads[chromium]
FAILED tests/e2e/test_hardening_smoke.py::test_hardening_top_flows_smoke[chromium]
FAILED tests/e2e/test_hardening_smoke.py::test_hardening_error_shell_navigation[chromium]
FAILED tests/e2e/test_tasks.py::test_tasks_kanban_page_loads[chromium] - Asse...
FAILED tests/test_activation_kpi.py::test_api_tasks_create_records_first_task_milestone
FAILED tests/test_activation_kpi.py::test_api_insights_activation_is_tenant_scoped
FAILED tests/test_ai_chat.py::test_ai_chat_shortcut_suggestion - assert 'KI-V...
FAILED tests/test_ai_chat.py::test_ai_chat_unhandled_message - assert 'konnte...
FAILED tests/test_ai_routes.py::test_api_ai_status - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_modelpack_routes - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_chat_success - assert 500 == 200
FAILED tests/test_ai_routes.py::test_api_ai_personal_memory_routes - assert 5...
FAILED tests/test_ai_routes.py::test_api_ai_confirm_tool_success - assert 500...
FAILED tests/test_ai_routes.py::test_api_ai_feedback_route - assert 500 == 200
FAILED tests/test_automation_confirm_replay.py::test_confirm_with_valid_token_succeeds
FAILED tests/test_automation_confirm_replay.py::test_confirm_replay_with_same_token_blocked
FAILED tests/test_automation_confirm_replay.py::test_confirm_with_wrong_token_fails
FAILED tests/test_automation_confirm_replay.py::test_confirm_without_token_fails
FAILED tests/test_automation_confirm_role_gate.py::test_pending_confirm_requires_admin_or_dev_role
FAILED tests/test_automation_csrf.py::test_automation_post_without_csrf_is_forbidden
FAILED tests/test_automation_csrf.py::test_automation_post_with_invalid_csrf_is_forbidden
FAILED tests/test_automation_csrf.py::test_automation_post_with_valid_csrf_is_allowed
FAILED tests/test_automation_dry_run.py::test_rule_simulation_creates_log_without_pending_actions
FAILED tests/test_automation_import_export.py::test_rule_export_and_safe_import
FAILED tests/test_automation_import_export.py::test_rule_import_supports_cron_email_send_and_webhook
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_invalid_cron_expression
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_cron_with_six_fields
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_email_draft_unknown_placeholder
FAILED tests/test_automation_import_export.py::test_rule_import_rejects_webhook_outside_allowlist
FAILED tests/test_automation_read_only.py::test_run_now_blocked_in_read_only
FAILED tests/test_automation_token_leak.py::test_pending_token_not_exposed_in_query_or_eventlog
FAILED tests/test_automation_web.py::test_automation_builder_requires_login
FAILED tests/test_automation_web.py::test_automation_builder_toggle_rule - as...
FAILED tests/test_automation_web.py::test_automation_pending_confirm_requires_ack_and_confirms
FAILED tests/test_automation_web.py::test_automation_rule_detail_supports_cron_and_mail_actions
FAILED tests/test_automation_web.py::test_automation_rule_detail_rejects_invalid_email_templates
FAILED tests/test_autonomy_health_record.py::test_scan_history_is_recorded_and_visible_in_health
FAILED tests/test_autonomy_health_record.py::test_smoke_test_updates_status
FAILED tests/test_autonomy_log_rotation.py::test_rotate_logs_compresses_and_deletes_old_files
FAILED tests/test_autonomy_maintenance.py::test_run_backup_once_creates_backup_and_event
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_create_rotate_and_verify
FAILED tests/test_autonomy_maintenance_backup.py::test_backup_read_only_blocks_file_ops
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_page_and_actions
FAILED tests/test_autonomy_ui_health.py::test_autonomy_health_actions_blocked_in_read_only
FAILED tests/test_autotag_web.py::test_autotag_pages_render - AssertionError:...
FAILED tests/test_autotag_web.py::test_autotag_create_read_only_blocked - ass...
FAILED tests/test_chat_api.py::test_chat_api_ok - assert 500 == 200
FAILED tests/test_chat_api.py::test_api_chat_requires_auth - assert 500 == 401
FAILED tests/test_chat_widget.py::test_chat_widget_present_for_authenticated_user
FAILED tests/test_chat_widget.py::test_chat_api_hx_request_returns_html_fragment
FAILED tests/test_collision_event_emitted.py::test_collision_event_emitted_on_claim_guard_block
FAILED tests/test_crm_customers.py::test_read_only_blocks_crm_mutation_route
FAILED tests/test_crm_tenant_isolation.py::test_api_tenant_isolation_customers
FAILED tests/test_crm_ui_read_only.py::test_crm_ui_shows_read_only_banner_and_disabled_controls
FAILED tests/test_crm_ui_routes.py::test_crm_pages_and_partials_return_200 - ...
FAILED tests/test_crm_ui_routes.py::test_crm_email_import_page_upload_flow - ...
FAILED tests/test_desktop_mode.py::test_run_native_desktop_bootstrap_flow - T...
FAILED tests/test_desktop_mode.py::test_run_native_desktop_raises_when_not_ready
FAILED tests/test_email_import_limits.py::test_oversize_eml_returns_413 - ass...
FAILED tests/test_email_import_limits.py::test_malformed_email_does_not_crash_and_truncates
FAILED tests/test_entity_links_panel_render.py::test_entity_links_panel_renders_sanitized_titles
FAILED tests/test_entity_links_web.py::test_entity_links_routes_create_list_delete
FAILED tests/test_entity_links_web.py::test_entity_links_read_only_returns_403
FAILED tests/test_error_content_negotiation.py::test_global_http_exception_honors_accept_json
FAILED tests/test_error_shell_navigation.py::test_web_404_uses_shell_with_back_reload_controls
FAILED tests/test_error_shell_navigation.py::test_navigation_is_persistent_and_minimizable_in_shell
FAILED tests/test_error_shell_navigation.py::test_api_404_returns_json_error_shape
FAILED tests/test_evidence_pack.py::test_evidence_pack_requires_auth - assert...
FAILED tests/test_evidence_pack.py::test_evidence_pack_lead_includes_request_ids_and_attachments
FAILED tests/test_evidence_pack.py::test_evidence_pack_tenant_isolation - ass...
FAILED tests/test_evidence_pack.py::test_evidence_pack_validation_error - ass...
FAILED tests/test_hardening_latency_bench.py::test_run_latency_suite_mock_mode_collects_percentiles
FAILED tests/test_hardening_security.py::test_unauthenticated_requests_are_denied_by_default
FAILED tests/test_hardening_security.py::test_low_role_is_denied_on_admin_endpoint
FAILED tests/test_hardening_security.py::test_cross_tenant_access_does_not_leak_data
FAILED tests/test_hardening_security.py::test_logout_invalidates_session - as...
FAILED tests/test_idle_timeout.py::test_idle_timeout_default_60_logout - asse...
FAILED tests/test_idle_timeout.py::test_idle_timeout_bounds_enforced - assert...
FAILED tests/test_idle_timeout.py::test_absolute_timeout_8h_logout - assert 5...
FAILED tests/test_intake_triage.py::test_intake_triage_invoice_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_support_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_unknown_label - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_validation - assert 50...
FAILED tests/test_intake_triage.py::test_intake_triage_requires_auth - assert...
FAILED tests/test_intake_triage.py::test_intake_triage_event_contains_tenant
FAILED tests/test_knowledge_email_policy_default_deny.py::test_email_upload_denied_when_policy_off_and_no_rows_written
FAILED tests/test_knowledge_email_security_limits.py::test_oversize_upload_is_rejected
FAILED tests/test_knowledge_email_security_limits.py::test_subject_newline_sanitized
FAILED tests/test_knowledge_ics_limits.py::test_ics_oversize_upload_is_rejected
FAILED tests/test_knowledge_ics_policy_default_deny.py::test_ics_upload_denied_when_policy_off_and_no_rows_written
FAILED tests/test_knowledge_notes_crud.py::test_read_only_blocks_note_mutations_route
FAILED tests/test_lead_claims_template_safety.py::test_claim_panel_escapes_user_content
FAILED tests/test_lead_claims_web.py::test_claim_and_collision_guard_routes
FAILED tests/test_lead_claims_web.py::test_claim_endpoints_read_only_blocked
FAILED tests/test_lead_conversion.py::test_lead_conversion_creates_deal_quote_and_links
FAILED tests/test_lead_conversion.py::test_lead_conversion_blocked_when_claimed_by_other_user
FAILED tests/test_lead_conversion.py::test_lead_conversion_is_tenant_isolated
FAILED tests/test_lead_conversion.py::test_lead_conversion_read_only_blocked
FAILED tests/test_lead_guard_decorator_allows_owner.py::test_guard_allows_owner_mutation
FAILED tests/test_lead_guard_decorator_blocks_claimed.py::test_guard_blocks_non_owner_and_logs_collision
FAILED tests/test_lead_guard_decorator_read_only.py::test_guard_blocks_mutations_in_read_only_mode
FAILED tests/test_lead_intake_api.py::test_lead_api_read_only_blocks_all_new_posts
FAILED tests/test_lead_intake_api.py::test_lead_api_validation_and_tenant_isolation
FAILED tests/test_lead_intake_api.py::test_actor_user_id_written_to_event_payload
FAILED tests/test_lead_intake_api.py::test_xss_payload_is_escaped_in_ui - ass...
FAILED tests/test_lead_intake_api.py::test_ics_crlf_injection_is_sanitized - ...
FAILED tests/test_license_read_only.py::test_read_only_blocks_mutating_requests
FAILED tests/test_omni_web.py::test_conversations_pages_render - assert 500 =...
FAILED tests/test_omni_web.py::test_conversations_tenant_isolation - assert 5...
FAILED tests/test_onboarding.py::test_onboarding_seeding - AssertionError: as...
FAILED tests/test_postfach_web.py::test_postfach_page_renders - assert 500 ==...
FAILED tests/test_postfach_web.py::test_postfach_page_shows_key_warning_when_missing
FAILED tests/test_postfach_web.py::test_mail_route_redirects_to_postfach - as...
FAILED tests/test_postfach_web.py::test_postfach_account_add_fails_closed_without_key
FAILED tests/test_postfach_web.py::test_postfach_oauth_start_sets_session_and_redirects
FAILED tests/test_postfach_web.py::test_postfach_oauth_callback_saves_token
FAILED tests/test_postfach_web.py::test_postfach_send_requires_safety_ack_when_warnings_exist
FAILED tests/test_rbac_permissions.py::test_permissions_manager_denies_office
FAILED tests/test_rbac_permissions.py::test_permissions_manager_allows_owner_admin
FAILED tests/test_rbac_permissions.py::test_dev_update_is_dev_only - assert 5...
FAILED tests/test_read_only_crm_api.py::test_read_only_crm_endpoints_do_not_write
FAILED tests/test_settings_and_open.py::test_settings_available_for_operator
FAILED tests/test_settings_and_open.py::test_open_by_token_creates_pending - ...
FAILED tests/test_status_endpoint.py::test_api_status_requires_login - assert...
FAILED tests/test_status_endpoint.py::test_api_status_reports_queue_and_running
FAILED tests/test_status_endpoint.py::test_dev_test_llm_updates_tracker - ass...
FAILED tests/test_tags_web.py::test_tags_page_and_assign_unassign_flow - asse...
FAILED tests/test_tags_web.py::test_tags_read_only_blocked - assert 500 == 403
FAILED tests/test_tasks_kanban_web.py::test_tasks_kanban_create_and_move_flow
FAILED tests/test_tasks_kanban_web.py::test_tasks_read_only_blocks_mutations
FAILED tests/test_tasks_kanban_web.py::test_tasks_tenant_isolation_on_move - ...
FAILED tests/test_tenant_isolation.py::test_tenant_context_is_set_and_overrides_session_tenant
FAILED tests/test_tenant_isolation.py::test_dev_can_edit_tenant_name_localhost_only
FAILED tests/test_tenant_isolation.py::test_dev_tenant_override_forbidden_for_remote_or_non_dev
FAILED tests/test_theme_default.py::test_shell_default_theme_is_light - asser...
FAILED tests/test_ui_preferences.py::test_default_theme_is_light_when_no_preference
FAILED tests/test_ui_preferences.py::test_theme_preference_loaded_from_auth_db
FAILED tests/test_ui_preferences.py::test_theme_preference_route_persists_setting
FAILED tests/test_ui_preferences.py::test_sidebar_preference_route_and_shell_default
FAILED tests/test_ui_preferences.py::test_theme_route_rejects_invalid_value
FAILED tests/test_update_routes.py::test_dev_update_route_requires_dev_role
FAILED tests/test_update_routes.py::test_dev_update_route_requires_localhost
FAILED tests/test_update_routes.py::test_dev_update_route_renders_for_dev_localhost
FAILED tests/test_update_routes.py::test_install_action_blocked_when_disabled
FAILED tests/test_update_routes.py::test_install_action_calls_update_pipeline
FAILED tests/test_upgrade.py::test_upgrade_smoke_automation_schema_and_page
FAILED tests/test_workflows_web.py::test_workflows_requires_login - assert 50...
FAILED tests/test_workflows_web.py::test_workflow_template_install_is_idempotent
FAILED tests/test_workflows_web.py::test_workflow_toggle_route_updates_enabled_flag
152 failed, 453 passed, 1 skipped, 4 warnings in 82.05s (0:01:22)


STDERR:
