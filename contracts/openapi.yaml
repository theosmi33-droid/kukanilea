openapi: 3.0.3
info:
  title: KUKANILEA API
  version: 0.1.0
  description: Local-first office assistant API (tenant-scoped, DB-first).
servers:
  - url: http://localhost:5051
paths:
  /api/ping:
    get:
      summary: Liveness ping
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
  /api/health:
    get:
      summary: Health and index stats
      responses:
        '200':
          description: Health payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  schema_version:
                    type: integer
                  auth_db_path:
                    type: string
                  tenants:
                    type: integer
                  last_indexed_at:
                    type: string
                    nullable: true
                  doc_count:
                    type: integer
                  fts_enabled:
                    type: boolean
                  tenant_id:
                    type: string
                  profile:
                    $ref: './schemas/Profile.json'
                  db_path:
                    type: string
                required: [ok]
  /api/chat:
    post:
      summary: Chat entrypoint
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/ChatRequest.json'
      responses:
        '200':
          description: Chat response
          content:
            application/json:
              schema:
                $ref: './schemas/ChatResponse.json'
        '400':
          description: Chat error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/search:
    post:
      summary: Search documents
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: './schemas/SearchQuery.json'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: './schemas/SearchResult.json'
  /api/customer:
    post:
      summary: Customer lookup
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                kdnr:
                  type: string
              required: [kdnr]
      responses:
        '200':
          description: Customer summary
          content:
            application/json:
              schema:
                $ref: './schemas/CustomerSummary.json'
  /api/tasks:
    get:
      summary: List tasks
      parameters:
        - in: query
          name: status
          schema:
            type: string
            default: OPEN
      responses:
        '200':
          description: Task list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  tasks:
                    type: array
                    items:
                      $ref: './schemas/Task.json'
                required: [ok, tasks]
  /api/audit:
    get:
      summary: Audit log
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  events:
                    type: array
                    items:
                      $ref: './schemas/AuditEvent.json'
                required: [ok, events]
  /api/time/projects:
    get:
      summary: List time tracking projects
      responses:
        '200':
          description: Project list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  projects:
                    type: array
                    items:
                      $ref: './schemas/TimeProject.json'
                required: [ok, projects]
    post:
      summary: Create a time tracking project
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
              required: [name]
      responses:
        '200':
          description: Project created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  project:
                    $ref: './schemas/TimeProject.json'
                required: [ok, project]
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/time/start:
    post:
      summary: Start a time entry
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                project_id:
                  type: integer
                  nullable: true
                note:
                  type: string
      responses:
        '200':
          description: Timer started
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  entry:
                    $ref: './schemas/TimeEntry.json'
                required: [ok, entry]
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/time/stop:
    post:
      summary: Stop a time entry
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                entry_id:
                  type: integer
      responses:
        '200':
          description: Timer stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  entry:
                    $ref: './schemas/TimeEntry.json'
                required: [ok, entry]
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/time/entries:
    get:
      summary: List time entries for a day or week
      parameters:
        - in: query
          name: range
          schema:
            type: string
            enum: [day, week]
            default: week
        - in: query
          name: date
          schema:
            type: string
            description: YYYY-MM-DD
        - in: query
          name: user
          schema:
            type: string
      responses:
        '200':
          description: Time entries and summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  entries:
                    type: array
                    items:
                      $ref: './schemas/TimeEntry.json'
                  summary:
                    type: array
                    items:
                      $ref: './schemas/TimeEntrySummary.json'
                required: [ok, entries, summary]
  /api/time/entry/edit:
    post:
      summary: Edit a time entry
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                entry_id:
                  type: integer
                project_id:
                  type: integer
                start_at:
                  type: string
                end_at:
                  type: string
                note:
                  type: string
              required: [entry_id]
      responses:
        '200':
          description: Entry updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  entry:
                    $ref: './schemas/TimeEntry.json'
                required: [ok, entry]
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/time/entry/approve:
    post:
      summary: Approve a time entry
      parameters:
        - $ref: '#/components/parameters/csrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                entry_id:
                  type: integer
              required: [entry_id]
      responses:
        '200':
          description: Entry approved
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  entry:
                    $ref: './schemas/TimeEntry.json'
                required: [ok, entry]
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './schemas/ErrorEnvelope.json'
  /api/time/export:
    get:
      summary: Export time entries as CSV
      parameters:
        - in: query
          name: range
          schema:
            type: string
            enum: [day, week]
            default: week
        - in: query
          name: date
          schema:
            type: string
            description: YYYY-MM-DD
        - in: query
          name: user
          schema:
            type: string
      responses:
        '200':
          description: CSV export
          content:
            text/csv:
              schema:
                type: string
components:
  parameters:
    csrfToken:
      in: header
      name: X-CSRF-Token
      required: true
      schema:
        type: string
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session
security:
  - sessionCookie: []
