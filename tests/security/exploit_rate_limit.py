import requests

URL = "http://127.0.0.1:5051/api/chat"


def test_rate_limit_bypass():
    print("--- Red-Team: Rate-Limit Attack ---")

    # 1. Direct Hammering
    for i in range(35):  # Limit is 30
        resp = requests.post(URL, json={"q": "ping"}, cookies={"tenant_id": "default"})
        if resp.status_code == 429:
            print(f"[OK] Blocked at request {i + 1} with 429.")
            break
    else:
        print("[FAIL] Rate limit not triggered!")
        return

    # 2. Header Spoofing Attempt (X-Forwarded-For)
    print("Trying to bypass with X-Forwarded-For...")
    resp = requests.post(
        URL,
        json={"q": "ping"},
        headers={"X-Forwarded-For": "1.2.3.4"},
        cookies={"tenant_id": "default"},
    )

    if resp.status_code == 429:
        print("[OK] Still blocked. System uses real remote_addr.")
    else:
        print("[FAIL] Bypass successful via Header Spoofing!")


if __name__ == "__main__":
    test_rate_limit_bypass()
