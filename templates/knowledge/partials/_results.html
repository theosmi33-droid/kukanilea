{% set next_url = '/knowledge' %}
<div class="card overflow-hidden">
  <table class="w-full text-sm">
    <thead>
      <tr class="border-b" style="border-color:var(--border)">
        <th class="text-left px-3 py-2">Titel</th>
        <th class="text-left px-3 py-2">Quelle</th>
        <th class="text-left px-3 py-2">Snippet</th>
        <th class="text-left px-3 py-2">Tags</th>
        <th class="text-left px-3 py-2">Score</th>
      </tr>
    </thead>
    <tbody>
      {% for row in results %}
      {% set entity_id = row.chunk_id or '' %}
      {% set item_tags = (tags_by_entity.get(entity_id) if tags_by_entity else []) or [] %}
      <tr class="border-b" style="border-color:var(--border)">
        <td class="px-3 py-2">{{ row.title or '-' }}</td>
        <td class="px-3 py-2">{{ row.source_type or '-' }}</td>
        <td class="px-3 py-2">{{ row.snippet or '' }}</td>
        <td class="px-3 py-2">
          <div class="flex flex-wrap gap-1 mb-2">
            {% for tag in item_tags %}
            <span class="inline-flex items-center gap-1 rounded px-2 py-0.5 text-xs" style="border:1px solid var(--border)">
              {{ tag.name }}
              {% if not read_only %}
              <form method="post" action="/tags/unassign">
                <input type="hidden" name="entity_type" value="knowledge_chunk">
                <input type="hidden" name="entity_id" value="{{ entity_id }}">
                <input type="hidden" name="tag_id" value="{{ tag.id }}">
                <input type="hidden" name="next" value="{{ next_url }}">
                <button class="text-[10px] muted" type="submit">âœ•</button>
              </form>
              {% endif %}
            </span>
            {% endfor %}
          </div>
          {% if not read_only and entity_id and all_tags %}
          <form class="flex items-center gap-1" method="post" action="/tags/assign">
            <input type="hidden" name="entity_type" value="knowledge_chunk">
            <input type="hidden" name="entity_id" value="{{ entity_id }}">
            <input type="hidden" name="next" value="{{ next_url }}">
            <select class="input px-2 py-1 text-xs" name="tag_id">
              {% for t in all_tags %}
              <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
            <button class="btn-outline px-2 py-1 text-xs" type="submit">Tag</button>
          </form>
          {% endif %}
        </td>
        <td class="px-3 py-2">{{ row.score if row.score is not none else 0.0 }}</td>
      </tr>
      {% else %}
      <tr><td class="px-3 py-3 muted" colspan="5">Keine Treffer.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
