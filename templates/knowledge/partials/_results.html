{% set next_url = '/knowledge' %}
<div class="space-y-10">
  {% for row in results %}
  {% set entity_id = row.chunk_id or '' %}
  {% set item_tags = (tags_by_entity.get(entity_id) if tags_by_entity else []) or [] %}
  <div class="group border-b border-zinc-50 pb-10 last:border-0">
    <div class="flex justify-between items-start gap-4 mb-3">
      <div class="flex-1">
        <div class="text-[9px] font-black text-zinc-300 uppercase tracking-widest mb-1">{{ row.source_type or 'DOC' }}</div>
        <h3 class="text-lg font-bold text-zinc-900 leading-tight">{{ row.title or 'Unbenanntes Dokument' }}</h3>
      </div>
      <div class="text-[10px] font-mono text-zinc-300">{{ (row.score * 100) | round(0) }}% Match</div>
    </div>
    
    <p class="text-sm text-zinc-500 leading-relaxed mb-6 max-w-3xl">
      {{ row.snippet or 'Kein Vorschautext verfügbar.' }}
    </p>

    <div class="flex flex-wrap gap-2 items-center">
      {% for tag in item_tags %}
      <span class="inline-flex items-center gap-2 px-3 py-1 bg-zinc-50 border border-zinc-100 rounded-full text-[9px] font-bold text-zinc-500 uppercase tracking-wider">
        {{ tag.name }}
        {% if not read_only %}
        <form method="post" action="/tags/unassign" class="inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="entity_type" value="knowledge_chunk">
          <input type="hidden" name="entity_id" value="{{ entity_id }}">
          <input type="hidden" name="tag_id" value="{{ tag.id }}">
          <input type="hidden" name="next" value="{{ next_url }}">
          <button class="hover:text-black transition-colors" type="submit">✕</button>
        </form>
        {% endif %}
      </span>
      {% endfor %}
      
      {% if not read_only and entity_id and all_tags %}
      <div class="w-px h-3 bg-zinc-100 ml-2"></div>
      <form class="flex items-center gap-2 ml-2" method="post" action="/tags/assign">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="entity_type" value="knowledge_chunk">
        <input type="hidden" name="entity_id" value="{{ entity_id }}">
        <input type="hidden" name="next" value="{{ next_url }}">
        <select class="bg-transparent border-none text-[9px] font-black uppercase tracking-widest text-zinc-400 focus:outline-none cursor-pointer" name="tag_id">
          <option value="" disabled selected>TAG+</option>
          {% for t in all_tags %}
          <option value="{{ t.id }}">{{ t.name }}</option>
          {% endfor %}
        </select>
        <button class="text-[9px] font-black text-black uppercase tracking-widest hover:underline" type="submit">Zuweisen</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="py-20 text-center">
    <div class="text-[10px] font-black text-zinc-300 uppercase tracking-widest">Keine Treffer gefunden</div>
  </div>
  {% endfor %}
</div>
