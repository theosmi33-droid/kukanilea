{% from 'components/alert.html' import banner %}
{% from 'components/button.html' import button_link, button_submit %}

<div class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-2">
    <div>
      <h1 class="text-xl font-semibold">{{ rule.name }}</h1>
      <div class="muted text-xs mt-1">Rule ID: {{ rule.id }}</div>
      {% if template_key %}
      <div class="muted text-xs">Template: {{ template_key }}</div>
      {% endif %}
    </div>
    <div class="flex items-center gap-2">
      {{ button_link('Zurueck', '/workflows', kind='outline') }}
      {{ button_link('Builder Detail', '/automation/' ~ rule.id, kind='outline') }}
    </div>
  </div>

  {% if read_only %}
  {{ banner('Read-only mode aktiv. Schreibaktionen sind deaktiviert.', kind='error') }}
  {% endif %}

  <div class="card p-4 space-y-3">
    <div class="flex flex-wrap items-center gap-2">
      <span class="badge">Enabled: {{ "yes" if rule.is_enabled else "no" }}</span>
      <span class="badge">Version: {{ rule.version }}</span>
      <span class="badge">Trigger: {{ rule.triggers|length }}</span>
      <span class="badge">Conditions: {{ rule.conditions|length }}</span>
      <span class="badge">Actions: {{ rule.actions|length }}</span>
    </div>
    <form method="post" action="/workflows/{{ rule.id }}/toggle">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="enabled" value="{{ 0 if rule.is_enabled else 1 }}">
      {{ button_submit("Disable" if rule.is_enabled else "Enable", kind='outline', size='sm', disabled=read_only) }}
    </form>
  </div>

  <div class="card p-4">
    <h2 class="font-semibold mb-2">Beschreibung</h2>
    <div class="text-sm whitespace-pre-wrap">{{ rule.description or "-" }}</div>
  </div>

  <div class="grid md:grid-cols-3 gap-3">
    <div class="card p-4">
      <h3 class="font-semibold mb-2">Trigger</h3>
      <pre class="text-xs overflow-x-auto">{{ rule.triggers | tojson(indent=2) }}</pre>
    </div>
    <div class="card p-4">
      <h3 class="font-semibold mb-2">Conditions</h3>
      <pre class="text-xs overflow-x-auto">{{ rule.conditions | tojson(indent=2) }}</pre>
    </div>
    <div class="card p-4">
      <h3 class="font-semibold mb-2">Actions</h3>
      <pre class="text-xs overflow-x-auto">{{ rule.actions | tojson(indent=2) }}</pre>
    </div>
  </div>

  <div class="card p-0 overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left border-b border-zinc-700/40">
          <th class="p-3">Started</th>
          <th class="p-3">Status</th>
          <th class="p-3">Trigger</th>
          <th class="p-3">Trigger Ref</th>
          <th class="p-3">Output</th>
        </tr>
      </thead>
      <tbody>
        {% for item in logs %}
        <tr class="border-b border-zinc-700/20">
          <td class="p-3">{{ item.started_at }}</td>
          <td class="p-3">{{ item.status }}</td>
          <td class="p-3">{{ item.trigger_type }}</td>
          <td class="p-3">{{ item.trigger_ref }}</td>
          <td class="p-3">{{ item.output_redacted }}</td>
        </tr>
        {% else %}
        <tr><td class="p-3 muted" colspan="5">Keine Workflow-Logs vorhanden.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
