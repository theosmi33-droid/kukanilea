<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-semibold">CRM Â· Kunden</h1>
    <a class="rounded-xl px-3 py-2 text-sm btn-outline" href="/crm/deals">Pipeline</a>
  </div>

  {% if read_only %}{% include 'crm/partials/read_only_banner.html' %}{% endif %}

  <div class="card p-4 space-y-3">
    <form id="customerSearch" class="grid gap-2 md:grid-cols-4" hx-get="/crm/_customers_table" hx-target="#customersTable" hx-swap="outerHTML">
      <input class="input px-3 py-2 text-sm" type="text" name="q" value="{{ q }}" placeholder="Suche Kunde / USt-ID">
      <select class="input px-3 py-2 text-sm" name="sort">
        <option value="name" {% if sort=='name' %}selected{% endif %}>Sort: Name</option>
        <option value="since" {% if sort=='since' %}selected{% endif %}>Sort: Erstellt</option>
        <option value="updated" {% if sort=='updated' %}selected{% endif %}>Sort: Aktualisiert</option>
      </select>
      <input type="hidden" name="page" value="{{ page }}">
      <input type="hidden" name="page_size" value="{{ page_size }}">
      <button class="btn-outline px-3 py-2 text-sm" type="submit">Aktualisieren</button>
    </form>

    <form id="createCustomerForm" class="grid gap-2 md:grid-cols-4">
      <input class="input px-3 py-2 text-sm" type="text" name="name" placeholder="Firmenname" {% if read_only %}disabled{% endif %} required>
      <input class="input px-3 py-2 text-sm" type="text" name="vat_id" placeholder="USt-ID" {% if read_only %}disabled{% endif %}>
      <input class="input px-3 py-2 text-sm md:col-span-2" type="text" name="notes" placeholder="Notizen" {% if read_only %}disabled{% endif %}>
      <button class="btn-primary px-3 py-2 text-sm md:col-span-4" type="submit" {% if read_only %}disabled{% endif %}>Neuen Kunden anlegen</button>
    </form>
  </div>

  {% include 'crm/partials/customers_table.html' %}
</div>

<script>
(function(){
  const form = document.getElementById('createCustomerForm');
  if (!form) return;
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const body = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/customers', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    if(res.ok){
      form.reset();
      document.getElementById('customerSearch')?.dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
    } else {
      const j = await res.json().catch(()=>({}));
      alert((j.error && j.error.message) || 'Fehler beim Speichern');
    }
  });
})();
</script>
