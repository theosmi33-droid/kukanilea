<div class="space-y-12">
  <div class="flex justify-between items-end">
    <div>
      <div class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.3em] mb-2">Relationship Management</div>
      <h1 class="text-3xl font-bold tracking-tight text-black">Kunden & Kontakte</h1>
    </div>
    <div class="flex gap-4">
      <a href="/crm/deals" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest hover:text-black transition-colors">Pipeline</a>
      <a href="/crm/quotes" class="text-[10px] font-black text-zinc-400 uppercase tracking-widest hover:text-black transition-colors">Angebote</a>
    </div>
  </div>

  <div class="space-y-10">
    <form id="customerSearch" class="relative group" hx-get="/crm/_customers_table" hx-target="#customersTable" hx-swap="outerHTML">
      <div class="bg-zinc-50 border border-zinc-200 rounded-2xl p-2 flex items-center shadow-sm focus-within:ring-2 focus-within:ring-blue-500/20 transition-all">
        <input class="flex-1 bg-transparent border-none px-6 py-4 text-lg focus:outline-none placeholder:text-zinc-300" type="text" name="q" value="{{ q }}" placeholder="Name oder USt-ID suchen...">
        <button type="submit" class="bg-black hover:bg-zinc-800 text-white p-4 rounded-xl transition-all active:scale-95 shadow-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
      </div>
    </form>

    <div class="pt-10 border-t border-zinc-50">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-[10px] font-black text-zinc-400 uppercase tracking-[0.2em]">Kundenstamm</h2>
        <button onclick="document.getElementById('createCustomerPanel').classList.toggle('hidden')" class="text-[10px] font-black text-blue-600 uppercase tracking-widest hover:underline">+ Neuanlage</button>
      </div>

      <div id="createCustomerPanel" class="hidden mb-12 p-8 bg-zinc-50 rounded-[2rem] border border-zinc-100">
        <form id="createCustomerForm" class="space-y-6">
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <label class="text-[9px] font-black text-zinc-400 uppercase tracking-widest mb-2 block">Firmenname</label>
              <input class="w-full bg-white border border-zinc-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-black transition-colors" type="text" name="name" {% if read_only %}disabled{% endif %} required>
            </div>
            <div>
              <label class="text-[9px] font-black text-zinc-400 uppercase tracking-widest mb-2 block">USt-ID</label>
              <input class="w-full bg-white border border-zinc-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-black transition-colors" type="text" name="vat_id" {% if read_only %}disabled{% endif %}>
            </div>
          </div>
          <div>
            <label class="text-[9px] font-black text-zinc-400 uppercase tracking-widest mb-2 block">Interne Notizen</label>
            <textarea class="w-full bg-white border border-zinc-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-black transition-colors h-24" name="notes" {% if read_only %}disabled{% endif %}></textarea>
          </div>
          <button type="submit" class="bg-black text-white w-full py-4 rounded-xl font-black uppercase tracking-widest hover:bg-zinc-800 transition-all disabled:opacity-50" {% if read_only %}disabled{% endif %}>Kunde Speichern</button>
        </form>
      </div>

      {% include 'crm/partials/customers_table.html' %}
    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('createCustomerForm');
  if (!form) return;
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const body = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/customers', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    if(res.ok){
      form.reset();
      document.getElementById('createCustomerPanel').classList.add('hidden');
      document.getElementById('customerSearch')?.dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
    } else {
      const j = await res.json().catch(()=>({}));
      alert((j.error && j.error.message) || 'Fehler beim Speichern');
    }
  });
})();
</script>

<script>
(function(){
  const form = document.getElementById('createCustomerForm');
  if (!form) return;
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const body = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/customers', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    if(res.ok){
      form.reset();
      document.getElementById('customerSearch')?.dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
    } else {
      const j = await res.json().catch(()=>({}));
      alert((j.error && j.error.message) || 'Fehler beim Speichern');
    }
  });
})();
</script>
