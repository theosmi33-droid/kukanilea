<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-semibold">Kunde · {{ customer.name }}</h1>
    <a class="btn-outline px-3 py-2 text-sm" href="/crm/customers">Zurück</a>
  </div>

  {% if read_only %}{% include 'crm/partials/read_only_banner.html' %}{% endif %}

  <div class="card p-4 space-y-3">
    <form id="customerEditForm" class="grid gap-2 md:grid-cols-3">
      <input class="input px-3 py-2 text-sm" type="text" name="name" value="{{ customer.name }}" {% if read_only %}disabled{% endif %} required>
      <input class="input px-3 py-2 text-sm" type="text" name="vat_id" value="{{ customer.vat_id or '' }}" {% if read_only %}disabled{% endif %}>
      <button class="btn-primary px-3 py-2 text-sm" type="submit" {% if read_only %}disabled{% endif %}>Kunde speichern</button>
      <textarea class="input px-3 py-2 text-sm md:col-span-3" name="notes" rows="3" {% if read_only %}disabled{% endif %}>{{ customer.notes or '' }}</textarea>
    </form>
  </div>

  <div class="card p-3">
    <div class="flex gap-2 text-sm">
      <button class="btn-outline px-2 py-1" hx-get="/crm/_customer_contacts/{{ customer.id }}" hx-target="#customerTabContent" hx-swap="innerHTML">Contacts</button>
      <button class="btn-outline px-2 py-1" hx-get="/crm/_customer_deals/{{ customer.id }}" hx-target="#customerTabContent" hx-swap="innerHTML">Deals</button>
      <button class="btn-outline px-2 py-1" hx-get="/crm/_customer_quotes/{{ customer.id }}" hx-target="#customerTabContent" hx-swap="innerHTML">Quotes</button>
      <button class="btn-outline px-2 py-1" hx-get="/crm/_customer_emails/{{ customer.id }}" hx-target="#customerTabContent" hx-swap="innerHTML">Emails</button>
    </div>
  </div>

  <div id="customerTabContent" class="space-y-3"
       hx-get="/crm/_customer_{{ active_subtab }}/{{ customer.id }}"
       hx-trigger="load"
       hx-swap="innerHTML"></div>
</div>

<script>
(function(){
  const form = document.getElementById('customerEditForm');
  if (!form) return;
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const body = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/customers/{{ customer.id }}', {
      method:'PUT',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const j = await res.json().catch(()=>({}));
      alert((j.error && j.error.message) || 'Fehler beim Speichern');
    }
  });
})();
</script>
