<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-semibold">Quote · {{ quote.quote_number or quote.id }}</h1>
    <a class="btn-outline px-3 py-2 text-sm" href="/crm/quotes">Zurück</a>
  </div>

  {% if read_only %}{% include 'crm/partials/read_only_banner.html' %}{% endif %}

  <div class="card p-4 text-sm space-y-2">
    <div>Kunde: <span class="font-medium">{{ quote.customer_id }}</span></div>
    <div>Status: <span class="font-medium">{{ quote.status }}</span></div>
    <div>Subtotal: <span class="font-medium">{{ quote.subtotal_text }}</span></div>
    <div>Steuer: <span class="font-medium">{{ quote.tax_text }}</span></div>
    <div>Total: <span class="font-semibold">{{ quote.total_text }}</span></div>
  </div>

  <div class="card p-4">
    <h3 class="font-semibold mb-2">Positionen</h3>
    <table class="w-full text-sm">
      <thead><tr class="border-b" style="border-color:var(--border)"><th class="text-left py-2">Beschreibung</th><th class="text-left py-2">Menge</th><th class="text-left py-2">Einzelpreis</th><th class="text-left py-2">Gesamt</th></tr></thead>
      <tbody>
        {% for it in quote_items %}
        <tr class="border-b" style="border-color:var(--border)">
          <td class="py-2">{{ it.description }}</td>
          <td class="py-2">{{ it.qty }}</td>
          <td class="py-2">{{ it.unit_price_text }}</td>
          <td class="py-2">{{ it.line_total_text }}</td>
        </tr>
        {% else %}
        <tr><td class="py-2 muted" colspan="4">Keine Positionen.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card p-4">
    <h3 class="font-semibold mb-2">Verknüpfungen</h3>
    <div id="quoteEntityLinks" hx-get="/entity-links/{{ link_entity_type }}/{{ link_entity_id }}" hx-trigger="load" hx-swap="innerHTML"></div>
  </div>

  <div class="card p-4">
    <form id="quoteItemForm" class="grid gap-2 md:grid-cols-4">
      <input class="input px-3 py-2 text-sm md:col-span-2" name="description" placeholder="Beschreibung" {% if read_only %}disabled{% endif %} required>
      <input class="input px-3 py-2 text-sm" name="qty" type="number" step="0.01" min="0.01" value="1" {% if read_only %}disabled{% endif %} required>
      <input class="input px-3 py-2 text-sm" name="unit_price_cents" type="number" min="0" placeholder="Preis (cents)" {% if read_only %}disabled{% endif %} required>
      <button class="btn-primary px-3 py-2 text-sm md:col-span-4" type="submit" {% if read_only %}disabled{% endif %}>Position hinzufügen</button>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('quoteItemForm');
  if (!form) return;
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const body = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/quotes/{{ quote.id }}/items', {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body)
    });
    if(res.ok){ location.reload(); }
    else {
      const j = await res.json().catch(()=>({}));
      alert((j.error && j.error.message) || 'Fehler beim Speichern');
    }
  });
})();
</script>
