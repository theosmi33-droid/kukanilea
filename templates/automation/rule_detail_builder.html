<div class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-2">
    <div>
      <h1 class="text-xl font-semibold">{{ rule.name }}</h1>
      <p class="text-sm opacity-80">{{ rule.description }}</p>
    </div>
    <div class="flex items-center gap-2">
      <a class="btn-outline px-3 py-2 text-sm" href="/automation/{{ rule.id }}/logs">Logs</a>
      <a class="btn-outline px-3 py-2 text-sm" href="/automation/{{ rule.id }}/export">Export JSON</a>
      <a class="btn-outline px-3 py-2 text-sm" href="/automation">Zurück</a>
    </div>
  </div>

  <div class="card p-4 text-sm">
    <div class="grid gap-2 md:grid-cols-4">
      <div><span class="opacity-70">Rule ID:</span> <code>{{ rule.id }}</code></div>
      <div><span class="opacity-70">Enabled:</span> {{ "yes" if rule.is_enabled else "no" }}</div>
      <div><span class="opacity-70">Version:</span> {{ rule.version }}</div>
      <div><span class="opacity-70">Updated:</span> {{ rule.updated_at }}</div>
    </div>
    <form method="post" action="/automation/{{ rule.id }}/toggle" class="mt-3">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="enabled" value="{{ 0 if rule.is_enabled else 1 }}">
      <button class="btn-primary px-3 py-2 text-sm" type="submit" {% if read_only %}disabled{% endif %}>
        {{ "Disable Rule" if rule.is_enabled else "Enable Rule" }}
      </button>
    </form>
    <form method="post" action="/automation/{{ rule.id }}/simulate" class="mt-3 flex flex-wrap items-center gap-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input class="input px-3 py-2 text-sm" name="event_id" placeholder="optional event id" />
      <button class="btn-outline px-3 py-2 text-sm" type="submit" {% if read_only %}disabled{% endif %}>
        Test Rule (Dry-Run)
      </button>
    </form>
  </div>

  <div class="grid gap-4 md:grid-cols-3">
    <div class="card p-4 space-y-2">
      <h2 class="font-semibold">Cron Trigger hinzufügen</h2>
      <p class="text-xs opacity-80">Format: <code>minute hour day month weekday</code> (nur <code>*</code> oder feste Zahlen)</p>
      <form method="post" action="/automation/{{ rule.id }}/trigger/cron" class="flex flex-wrap gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input class="input px-3 py-2 text-sm min-w-[260px]" name="cron_expression" placeholder="0 8 * * 1" required {% if read_only %}disabled{% endif %} />
        <button class="btn-outline px-3 py-2 text-sm" type="submit" {% if read_only %}disabled{% endif %}>Cron Trigger hinzufügen</button>
      </form>
    </div>
    <div class="card p-4 space-y-2">
      <h2 class="font-semibold">Email-Draft Action hinzufügen</h2>
      <form method="post" action="/automation/{{ rule.id }}/action/email-draft" class="grid gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input class="input px-3 py-2 text-sm" name="to" placeholder="kunde@example.com, team@example.com" required {% if read_only %}disabled{% endif %} />
        <input class="input px-3 py-2 text-sm" name="subject" placeholder="Betreff" required {% if read_only %}disabled{% endif %} />
        <textarea class="input px-3 py-2 text-sm" rows="4" name="body_template" placeholder="Sehr geehrte/r {customer_name}, ..." {% if read_only %}disabled{% endif %}></textarea>
        <input class="input px-3 py-2 text-sm" name="account_id" placeholder="optional account_id" {% if read_only %}disabled{% endif %} />
        <input class="input px-3 py-2 text-sm" name="attachments" placeholder="optionale doc IDs (kommagetrennt)" {% if read_only %}disabled{% endif %} />
        <button class="btn-outline px-3 py-2 text-sm w-fit" type="submit" {% if read_only %}disabled{% endif %}>Email-Draft Action hinzufügen</button>
      </form>
    </div>
    <div class="card p-4 space-y-2">
      <h2 class="font-semibold">Email-Send Action hinzufügen</h2>
      <p class="text-xs opacity-80">Nur pending + Confirm. Kein Auto-Send ohne Bestätigung.</p>
      <form method="post" action="/automation/{{ rule.id }}/action/email-send" class="grid gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input class="input px-3 py-2 text-sm" name="to" placeholder="kunde@example.com, team@example.com" required {% if read_only %}disabled{% endif %} />
        <input class="input px-3 py-2 text-sm" name="subject" placeholder="Betreff" required {% if read_only %}disabled{% endif %} />
        <textarea class="input px-3 py-2 text-sm" rows="4" name="body_template" placeholder="Sehr geehrte/r {customer_name}, ..." required {% if read_only %}disabled{% endif %}></textarea>
        <input class="input px-3 py-2 text-sm" name="account_id" placeholder="optional account_id" {% if read_only %}disabled{% endif %} />
        <input class="input px-3 py-2 text-sm" name="attachments" placeholder="optionale doc IDs (kommagetrennt)" {% if read_only %}disabled{% endif %} />
        <button class="btn-outline px-3 py-2 text-sm w-fit" type="submit" {% if read_only %}disabled{% endif %}>Email-Send Action hinzufügen</button>
      </form>
    </div>
  </div>

  <div class="card p-4 space-y-2">
    <h2 class="font-semibold">Webhook Action hinzufügen</h2>
    <p class="text-xs opacity-80">
      Nur HTTPS + Domain-Allowlist.
      {% if webhook_allowed_domains %}
      Erlaubte Domains: <code>{{ webhook_allowed_domains | join(", ") }}</code>
      {% else %}
      Keine Domains konfiguriert (<code>WEBHOOK_ALLOWED_DOMAINS</code>).
      {% endif %}
    </p>
    <form method="post" action="/automation/{{ rule.id }}/action/webhook" class="grid gap-2 md:grid-cols-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input class="input px-3 py-2 text-sm md:col-span-2" name="url" placeholder="https://example.com/hook" required {% if read_only %}disabled{% endif %} />
      <input class="input px-3 py-2 text-sm" name="method" value="POST" readonly {% if read_only %}disabled{% endif %} />
      <textarea class="input px-3 py-2 text-sm md:col-span-2" rows="3" name="body_template" placeholder='{"event":"{{event_type}}","entity_id":"{{entity_id}}"}' {% if read_only %}disabled{% endif %}></textarea>
      <textarea class="input px-3 py-2 text-sm md:col-span-2" rows="3" name="headers_json" placeholder='{"X-Source":"kukanilea"}' {% if read_only %}disabled{% endif %}></textarea>
      <button class="btn-outline px-3 py-2 text-sm w-fit" type="submit" {% if read_only %}disabled{% endif %}>Webhook Action hinzufügen</button>
    </form>
  </div>

  <div class="grid gap-4 md:grid-cols-3">
    <div class="card p-4">
      <h2 class="font-semibold mb-2">Triggers</h2>
      <pre class="text-xs whitespace-pre-wrap">{{ rule.triggers | tojson(indent=2) }}</pre>
    </div>
    <div class="card p-4">
      <h2 class="font-semibold mb-2">Conditions</h2>
      <pre class="text-xs whitespace-pre-wrap">{{ rule.conditions | tojson(indent=2) }}</pre>
    </div>
    <div class="card p-4">
      <h2 class="font-semibold mb-2">Actions</h2>
      <pre class="text-xs whitespace-pre-wrap">{{ rule.actions | tojson(indent=2) }}</pre>
    </div>
  </div>
</div>
