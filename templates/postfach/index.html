<div class="grid gap-4">
  <div class="card p-4 rounded-2xl border">
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-lg font-semibold">Postfach Hub (Phase 2)</div>
        <div class="text-sm opacity-80">Inbox, OAuth-Ready Accounts, Intake und Workflow-Aktionen im Thread.</div>
      </div>
      <div class="text-right text-xs opacity-70">Tenant: {{ tenant }}</div>
    </div>
    {% if read_only %}
      <div class="mt-3 rounded-xl border border-rose-500/40 bg-rose-500/10 p-3 text-sm">
        READ_ONLY aktiv: Mutationen (Account, Sync, Draft, Send) sind blockiert.
      </div>
    {% endif %}
    {% if not postfach_key_ready %}
      <div class="mt-3 rounded-xl border border-amber-500/40 bg-amber-500/10 p-3 text-sm">
        EMAIL_ENCRYPTION_KEY fehlt. Postfach-Funktionen sind fail-closed deaktiviert.
      </div>
    {% endif %}
    {% if postfach_status %}
      <div class="mt-3 rounded-xl border border-slate-700 bg-slate-950/40 p-3 text-sm">{{ postfach_status }}</div>
    {% endif %}
  </div>

  <div class="grid gap-4 lg:grid-cols-12">
    <div class="lg:col-span-4 card p-4 rounded-2xl border">
      <div class="text-base font-semibold mb-3">Konten</div>
      <form method="post" action="/postfach/accounts/add" class="grid gap-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input name="label" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="Label" required {% if read_only %}disabled{% endif %} />
        <div class="grid gap-2 md:grid-cols-2">
          <select name="auth_mode" class="rounded-xl border px-3 py-2 text-sm bg-transparent" {% if read_only %}disabled{% endif %}>
            <option value="password" selected>Passwort (IMAP/SMTP)</option>
            <option value="oauth_google">OAuth Google</option>
            <option value="oauth_microsoft">OAuth Microsoft 365</option>
          </select>
          <select name="oauth_provider" class="rounded-xl border px-3 py-2 text-sm bg-transparent" {% if read_only %}disabled{% endif %}>
            <option value="">Provider Auto</option>
            <option value="google">Google</option>
            <option value="microsoft">Microsoft</option>
          </select>
        </div>
        <div class="grid gap-2 md:grid-cols-2">
          <input name="imap_host" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="imap.example.com" required {% if read_only %}disabled{% endif %} />
          <input name="imap_port" type="number" value="993" class="rounded-xl border px-3 py-2 text-sm bg-transparent" required {% if read_only %}disabled{% endif %} />
        </div>
        <input name="imap_username" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="imap user" required {% if read_only %}disabled{% endif %} />
        <div class="grid gap-2 md:grid-cols-2">
          <input name="smtp_host" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="smtp.example.com" {% if read_only %}disabled{% endif %} />
          <input name="smtp_port" type="number" value="465" class="rounded-xl border px-3 py-2 text-sm bg-transparent" {% if read_only %}disabled{% endif %} />
        </div>
        <input name="smtp_username" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="smtp user (optional)" {% if read_only %}disabled{% endif %} />
        <label class="inline-flex items-center gap-2 text-xs opacity-80">
          <input type="checkbox" name="smtp_use_ssl" value="1" checked {% if read_only %}disabled{% endif %} />
          SMTP SSL verwenden
        </label>
        <input name="secret" type="password" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="Passwort / App-Password (bei Passwortmodus)" {% if read_only %}disabled{% endif %} />
        <button class="rounded-xl px-3 py-2 text-sm btn-primary" type="submit" {% if read_only %}disabled{% endif %}>Konto speichern</button>
      </form>

      <div class="mt-4 border-t border-slate-800 pt-3">
        <div class="text-sm font-semibold mb-2">Vorhandene Konten</div>
        <form method="get" action="/postfach" class="grid gap-2">
          <select name="account_id" class="rounded-xl border px-3 py-2 text-sm bg-transparent" onchange="this.form.submit()">
            {% for a in accounts %}
              <option value="{{a.id}}" {{ 'selected' if selected_account_id==a.id else '' }}>
                {{a.label}} · {{a.imap_host}} · {{a.auth_mode}}
              </option>
            {% else %}
              <option value="">Keine Konten</option>
            {% endfor %}
          </select>
          <input type="hidden" name="q" value="{{search_query}}" />
        </form>

        {% if selected_account_id %}
          {% set selected = (accounts | selectattr('id', 'equalto', selected_account_id) | list | first) %}
          <div class="mt-2 rounded-xl border border-slate-800 p-2 text-xs">
            <div>Status: {{selected.oauth_status or 'n/a'}}{% if selected.oauth_connected %} · token verbunden{% endif %}</div>
            <div>Sync: {{selected.last_sync_status or 'n/a'}} · {{selected.last_sync_at or '-'}} · +{{selected.last_sync_imported or 0}} / dup {{selected.last_sync_duplicates or 0}}</div>
            {% if selected.last_sync_error %}<div class="text-amber-300">{{selected.last_sync_error}}</div>{% endif %}
            {% if selected.oauth_last_error %}<div class="text-amber-300">{{selected.oauth_last_error}}</div>{% endif %}
          </div>

          <form method="post" action="/postfach/accounts/sync" class="grid gap-2 mt-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="account_id" value="{{selected_account_id}}" />
            <input name="limit" type="number" min="1" max="200" value="50" class="rounded-xl border px-3 py-2 text-sm bg-transparent" {% if read_only %}disabled{% endif %} />
            <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Jetzt syncen</button>
          </form>

          {% if selected.auth_mode in ['oauth_google','oauth_microsoft'] %}
          <form method="post" action="/postfach/accounts/oauth/start" class="grid gap-2 mt-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="account_id" value="{{selected_account_id}}" />
            <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>OAuth verbinden</button>
          </form>
          <form method="post" action="/postfach/accounts/oauth/disconnect" class="grid gap-2 mt-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="account_id" value="{{selected_account_id}}" />
            <input type="hidden" name="provider" value="{{selected.oauth_provider}}" />
            <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>OAuth trennen</button>
          </form>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="lg:col-span-8 card p-4 rounded-2xl border">
      <div class="flex items-center justify-between gap-2 mb-3">
        <div class="text-base font-semibold">Threads</div>
        <form method="get" action="/postfach" class="flex items-center gap-2">
          <input type="hidden" name="account_id" value="{{selected_account_id}}" />
          <input name="q" value="{{search_query}}" class="rounded-xl border px-3 py-2 text-sm bg-transparent" placeholder="Suche in Betreff/Text" />
          <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit">Filtern</button>
        </form>
      </div>

      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-5 overflow-auto max-h-[30rem] border border-slate-800 rounded-xl">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left muted">
                <th class="py-2 px-2">Betreff</th>
                <th class="py-2 px-2">Teilnehmer</th>
              </tr>
            </thead>
            <tbody>
              {% for t in threads %}
              <tr class="border-t border-slate-800 {{ 'bg-slate-900/40' if selected_thread_id==t.id else '' }}">
                <td class="py-2 px-2">
                  <a class="underline" href="/postfach?account_id={{selected_account_id}}&thread_id={{t.id}}&q={{search_query}}">{{t.subject_redacted}}</a>
                  <div class="text-xs muted">{{t.last_message_at or t.updated_at}} · {{t.message_count}} Msg</div>
                </td>
                <td class="py-2 px-2 text-xs">{{t.participants_redacted}}</td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="py-3 px-2 muted">Noch keine Threads.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="lg:col-span-7">
          {% if thread_data %}
            {% set thread = thread_data.thread %}
            <div class="mb-2 flex items-center justify-between">
              <div class="font-semibold">{{thread.subject_redacted}}</div>
              <a class="text-xs underline" href="/postfach/thread/{{thread.id}}">Detailansicht</a>
            </div>
            <div class="space-y-2 max-h-64 overflow-auto border border-slate-800 rounded-xl p-3">
              {% for m in thread_data.messages %}
              <div class="rounded-xl border border-slate-800 p-2">
                <div class="text-xs muted">{{m.direction}} · {{m.received_at or m.created_at}}</div>
                <div class="text-xs">Von: {{m.from_redacted}}</div>
                <div class="text-xs">An: {{m.to_redacted}}</div>
                <div class="text-sm font-medium">{{m.subject_redacted}}</div>
                <pre class="text-xs whitespace-pre-wrap">{{m.redacted_text}}</pre>
              </div>
              {% endfor %}
            </div>

            <div class="mt-3 grid gap-2 md:grid-cols-2">
              <form method="post" action="/postfach/thread/{{thread.id}}/intake" class="rounded-xl border border-slate-800 p-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <button class="w-full rounded-xl px-3 py-2 text-sm btn-outline" type="submit">Intake extrahieren</button>
              </form>

              <form method="post" action="/postfach/thread/{{thread.id}}/lead" class="rounded-xl border border-slate-800 p-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <button class="w-full rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Als Lead übernehmen</button>
              </form>

              <form method="post" action="/postfach/thread/{{thread.id}}/case" class="rounded-xl border border-slate-800 p-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <button class="w-full rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Case erstellen</button>
              </form>

              <form method="post" action="/postfach/thread/{{thread.id}}/tasks" class="rounded-xl border border-slate-800 p-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <button class="w-full rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Aufgaben erzeugen</button>
              </form>

              <form method="post" action="/postfach/thread/{{thread.id}}/followup" class="rounded-xl border border-slate-800 p-2 grid gap-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <input name="title" class="rounded-xl border px-2 py-1 text-xs bg-transparent" value="Follow-up {{thread.subject_redacted}}" {% if read_only %}disabled{% endif %} />
                <input name="owner" class="rounded-xl border px-2 py-1 text-xs bg-transparent" placeholder="Owner" {% if read_only %}disabled{% endif %} />
                <input name="due_at" class="rounded-xl border px-2 py-1 text-xs bg-transparent" placeholder="YYYY-MM-DDTHH:MM:SS" {% if read_only %}disabled{% endif %} />
                <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Aufgabe erstellen</button>
              </form>

              <form method="post" action="/postfach/thread/{{thread.id}}/link" class="rounded-xl border border-slate-800 p-2 grid gap-2">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                <input name="customer_id" class="rounded-xl border px-2 py-1 text-xs bg-transparent" placeholder="customer_id" {% if read_only %}disabled{% endif %} />
                <input name="project_id" class="rounded-xl border px-2 py-1 text-xs bg-transparent" placeholder="project_id" {% if read_only %}disabled{% endif %} />
                <input name="lead_id" class="rounded-xl border px-2 py-1 text-xs bg-transparent" placeholder="lead_id" {% if read_only %}disabled{% endif %} />
                <button class="rounded-xl px-3 py-2 text-sm btn-outline" type="submit" {% if read_only %}disabled{% endif %}>Kunde/Lead verknüpfen</button>
              </form>
            </div>

            <div class="mt-3 rounded-xl border border-slate-800 p-3">
              <div class="text-sm font-semibold mb-2">Antwort entwerfen / senden</div>
              <form method="post" action="/postfach/thread/{{thread.id}}/draft" class="grid gap-2 md:grid-cols-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input name="intent" value="antwort" class="rounded-xl border px-2 py-1 text-xs bg-transparent" {% if read_only %}disabled{% endif %} />
                <input name="tone" value="neutral" class="rounded-xl border px-2 py-1 text-xs bg-transparent" {% if read_only %}disabled{% endif %} />
                <label class="inline-flex items-center gap-2 text-xs px-2"><input type="checkbox" name="citations_required" value="1" checked {% if read_only %}disabled{% endif %} />Citations</label>
                <button class="rounded-xl px-3 py-2 text-sm btn-primary" type="submit" {% if read_only %}disabled{% endif %}>Antwort entwerfen</button>
              </form>

              {% if selected_draft %}
              <div class="mt-3 rounded-xl border border-slate-800 p-2">
                <div class="text-xs muted">Draft {{selected_draft.id}} · Status: {{selected_draft.status}}</div>
                <div class="text-xs">To: {{selected_draft.to_redacted}}</div>
                <div class="text-sm font-medium">{{selected_draft.subject_redacted}}</div>
                <pre class="text-xs whitespace-pre-wrap">{{selected_draft.body_redacted}}</pre>
                <form method="post" action="/postfach/drafts/safety-check" class="mt-2 grid gap-2 md:grid-cols-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="draft_id" value="{{selected_draft.id}}" />
                  <input type="hidden" name="thread_id" value="{{thread.id}}" />
                  <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                  <button class="rounded-xl px-3 py-2 text-sm btn-outline md:col-span-4" type="submit">Sicherheitscheck ausführen</button>
                </form>
                <form method="post" action="/postfach/drafts/send" class="mt-2 grid gap-2 md:grid-cols-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="draft_id" value="{{selected_draft.id}}" />
                  <input type="hidden" name="thread_id" value="{{thread.id}}" />
                  <input type="hidden" name="account_id" value="{{selected_account_id}}" />
                  <label class="inline-flex items-center gap-2 text-xs md:col-span-4">
                    <input type="checkbox" name="safety_ack" value="1" />
                    Sicherheitswarnungen wurden geprüft.
                  </label>
                  <label class="inline-flex items-center gap-2 text-xs md:col-span-4">
                    <input type="checkbox" name="user_confirmed" value="1" />
                    Ich habe den Entwurf geprüft und bestätige den Versand.
                  </label>
                  <button class="rounded-xl px-3 py-2 text-sm btn-primary" type="submit" {% if read_only %}disabled{% endif %}>Entwurf senden</button>
                </form>
              </div>
              {% endif %}
            </div>
          {% else %}
            <div class="text-sm muted">Bitte Konto auswählen und Sync ausführen, dann einen Thread öffnen.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card p-4 rounded-2xl border">
    <div class="text-base font-semibold mb-2">Outbox (lokal)</div>
    <div class="grid gap-2 md:grid-cols-2">
      {% for row in outbox %}
      <div class="rounded-xl border border-slate-800 p-2">
        <div class="text-xs muted">{{row.created_at}} · {{row.kind}}</div>
        <div class="text-xs">{{row.recipient_redacted}}</div>
        <div class="text-sm">{{row.body}}</div>
      </div>
      {% else %}
      <div class="text-sm muted">Keine Outbox-Einträge.</div>
      {% endfor %}
    </div>
  </div>
</div>
