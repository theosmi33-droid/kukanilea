name: ci

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_DEFAULT_TIMEOUT: "60"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
      - name: Install dependencies (resilient)
        run: |
          retry() {
            local tries="$1"
            shift
            local count=1
            until "$@"; do
              if [ "${count}" -ge "${tries}" ]; then
                return 1
              fi
              count=$((count + 1))
              sleep $((count * 5))
            done
          }

          python -m pip install --upgrade pip setuptools wheel
          retry 3 python -m pip install --prefer-binary --retries 5 --timeout 60 -r requirements.txt
          retry 3 python -m pip install --prefer-binary --retries 5 --timeout 60 -r requirements-dev.txt
          python -m pip cache info || true
      - run: pre-commit run --all-files
      - run: python -m app.smoke
      - name: Security static scan
        run: python -m app.devtools.security_scan
      - run: pytest -m "not e2e" -q
      - name: Security regression subset
        run: |
          pytest -q \
            tests/test_security_templates_no_safe.py \
            tests/test_security_forbidden_imports.py \
            tests/test_security_eventlog_payload_keys.py
      - run: >
          python -m app.devtools.triage --ci --fail-on-warnings
          --ignore-warning-regex "(?i)(swig|deprecation|userwarning|resourcewarning|warning:)"
