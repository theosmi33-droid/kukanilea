name: ci

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: python -m pip install -r requirements.txt
      - run: python -m pip install -r requirements-dev.txt
      - run: pre-commit run --all-files
      - run: python -m app.smoke
      - name: Security static scan
        run: python -m app.devtools.security_scan
      - run: pytest -m "not e2e" -q
      - name: Security regression subset
        run: |
          pytest -q \
            tests/test_security_templates_no_safe.py \
            tests/test_security_forbidden_imports.py \
            tests/test_security_eventlog_payload_keys.py
      - run: |
          PYTEST_ADDOPTS="-m not e2e" \
          python -m app.devtools.triage --ci --fail-on-warnings \
          --ignore-warning-regex "(?i)(swig|deprecation|userwarning|resourcewarning|warning:)"
