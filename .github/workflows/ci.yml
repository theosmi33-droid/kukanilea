name: ci

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: python -m pip install -r requirements.txt
      - run: python -m pip install -r requirements-dev.txt
      - run: pre-commit run --all-files
      - run: python -m app.smoke
      - run: pytest -q
      - name: Security regression subset
        run: |
          python - <<'PY'
          from pathlib import Path
          import subprocess
          import sys

          tests = sorted(Path("tests").glob("test_*.py"))
          hits = [
              str(t)
              for t in tests
              if any(k in t.stem for k in ("security_imports", "pii_redaction", "tenant_isolation"))
          ]
          if not hits:
              print("No matching security subset tests found; skipping.")
              raise SystemExit(0)
          cmd = [sys.executable, "-m", "pytest", "-q", "-k", "security_imports or pii_redaction or tenant_isolation"]
          raise SystemExit(subprocess.call(cmd))
          PY
      - run: >
          python -m app.devtools.triage --ci --fail-on-warnings
          --ignore-warning-regex "(?i)(swig|deprecation|userwarning|resourcewarning|warning:)"
