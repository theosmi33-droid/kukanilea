{% extends "layout.html" %}
{% block title %}Validierung{% endblock %}

{% block content %}
<div style="display: flex; gap: var(--spacing-4); height: calc(100vh - 120px); overflow: hidden;">
  <!-- Left Side: Document Preview -->
  <div class="panel" style="flex: 1; margin: 0; padding: 0; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; background: #0c0a09; border: none;">
    {% if preview %}
      <div id="preview-placeholder" style="position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 10;">
         <img src="data:image/png;base64,{{preview}}" style="max-width: 100%; max-height: 100%; opacity: 0.5; filter: blur(4px);" alt="Lade Vorschau...">
      </div>
    {% endif %}

    {% if is_pdf %}
      <iframe src="/file/{{token}}" style="width: 100%; height: 100%; border: none; position: relative; z-index: 20; background: transparent;" title="PDF Vorschau" onload="document.getElementById('preview-placeholder')?.remove()"></iframe>
    {% elif preview %}
      <img src="data:image/png;base64,{{preview}}" style="max-width: 100%; max-height: 100%; position: relative; z-index: 20;" alt="Beleg Vorschau">
    {% else %}
      <div style="color: var(--color-text-muted); text-align: center;">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" viewBox="0 0 24 24" style="margin-bottom: 16px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Keine Vorschau verf√ºgbar</div>
      </div>
    {% endif %}
  </div>

  <!-- Right Side: Data Form -->
  <div style="width: 480px; display: flex; flex-direction: column; overflow-y: auto;">
    <div class="panel" style="margin-bottom: 0;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-4);">
        <div>
          <h2 style="font-size: 20px; font-weight: 700; color: var(--color-text-main); margin-bottom: 4px;">Metadaten</h2>
          <p style="font-size: 11px; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">{{ filename }}</p>
        </div>
        <div class="badge" style="background: rgba(16, 185, 129, 0.1); color: var(--color-success); border-color: rgba(16, 185, 129, 0.2);">
          {{ confidence }}% KI Vertrauen
        </div>
      </div>

      {% if is_duplicate %}
      <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); color: var(--color-warning); padding: 12px; border-radius: var(--radius-md); margin-bottom: var(--spacing-3); font-size: 13px; font-weight: 500; display: flex; gap: 12px; align-items: flex-start;">
        <svg fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" viewBox="0 0 24 24" style="flex-shrink: 0;"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
        <div><strong>Duplikat erkannt:</strong> Dokument liegt bereits im Archiv.</div>
      </div>
      {% endif %}

      {% if msg %}
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--color-danger); padding: 12px; border-radius: var(--radius-md); margin-bottom: var(--spacing-3); font-size: 13px; font-weight: 500;">
        {{ msg }}
      </div>
      {% endif %}

      <form method="post" style="display: flex; flex-direction: column; gap: var(--spacing-3);">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="confirm" value="1">
        
        <div class="grid grid-cols-2 gap-4">
          <div class="input-group" style="margin-bottom: 0;">
            <label>Beleg-Typ</label>
            <select name="doctype" class="input" style="font-weight: 600;">
              {% for dt in doctypes %}
                <option value="{{dt}}" {{'selected' if w.doctype==dt or suggested_doctype==dt}}>{{dt}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="input-group" style="margin-bottom: 0;">
            <label>Datum</label>
            <input name="document_date" value="{{w.document_date or suggested_date}}" class="input" placeholder="YYYY-MM-DD">
          </div>
        </div>

        <div class="input-group">
          <label>Kundennummer (KDNR)</label>
          <input name="kdnr" id="kdnr_input" value="{{w.kdnr}}" list="kdnr_list" class="input" style="font-weight: 600;" placeholder="z.B. 12345" required>
          <datalist id="kdnr_list">
            {% for k in kdnr_ranked %}<option value="{{k}}">{% endfor %}
          </datalist>
          {% if kdnr_ranked %}
          <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
            {% for k in kdnr_ranked[:5] %}
            <span class="badge" style="cursor: pointer; font-size: 10px;" onclick="document.getElementById('kdnr_input').value='{{k}}'">{{k}}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="input-group">
          <label>Name / Firma</label>
          <input name="name" id="name_input" value="{{w.name}}" list="name_list" class="input">
          <datalist id="name_list">
            {% for n in name_suggestions %}<option value="{{n}}">{% endfor %}
          </datalist>
          {% if name_suggestions %}
          <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
            {% for n in name_suggestions[:5] %}
            <span class="badge" style="cursor: pointer; font-size: 10px;" onclick="document.getElementById('name_input').value='{{n}}'">{{n}}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="input-group">
          <label>Schlagworte (Auto-Detected)</label>
          <div id="keywords-container">
            {% if keywords %}
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                {% for kw in keywords[:10] %}
                  <span class="badge ripple" style="cursor: pointer; background: rgba(37,99,235,0.1); border-color: rgba(37,99,235,0.2); color: var(--color-accent);" 
                        onclick="const input = document.querySelector('input[name=name]'); input.value += (input.value ? ', ' : '') + '{{kw}}';">{{ kw }}</span>
                {% endfor %}
              </div>
            {% else %}
              <!-- Phase 4: Skeleton Screen -->
              <div style="display: flex; gap: 6px;">
                <div class="skeleton-tag"></div>
                <div class="skeleton-tag" style="width: 60px;"></div>
                <div class="skeleton-tag" style="width: 100px;"></div>
              </div>
            {% endif %}
          </div>
        </div>

        <div style="display: flex; gap: var(--spacing-2); margin-top: var(--spacing-2); padding-top: var(--spacing-3); border-top: 1px solid var(--color-border);">
          <button type="submit" class="btn btn-primary" style="flex: 1; height: 48px; font-size: 16px;">ARCHIVIEREN</button>
          <button type="submit" name="reextract" value="1" class="btn btn-secondary" style="height: 48px; font-weight: 600;" title="Deep OCR Scan">RE-SCAN</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
