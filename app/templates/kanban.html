{% extends "layout.html" %}
{% block title %}Kanban Board{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: var(--spacing-6); height: calc(100vh - 120px);">
    <!-- Board Header -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 28px; font-weight: 800; color: #fff; letter-spacing: -0.02em;">{{ project.name }}</h1>
            <p style="color: var(--color-text-muted); font-size: 14px;">{{ project.description or 'Projekt-Ãœbersicht' }}</p>
        </div>
        <button class="btn btn-primary" onclick="alert('Task Creation Dialog (v2.7)')">+ Aufgabe erstellen</button>
    </div>

    <!-- Kanban Grid -->
    <div style="display: flex; gap: 20px; flex: 1; overflow-x: auto; padding-bottom: 20px;">
        {% for col in ["To Do", "Doing", "Done"] %}
        <div style="width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 12px; background: rgba(255,255,255,0.02); border-radius: var(--radius-lg); border: 1px solid var(--color-border); padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary);">{{ col }}</h3>
                <span class="badge" style="font-size: 10px;">{{ tasks|selectattr('column_name', 'equalto', col)|list|length }}</span>
            </div>
            
            <div id="col-{{ col|replace(' ', '-') }}" class="kanban-column" style="display: flex; flex-direction: column; gap: 12px; flex: 1; min-height: 100px;">
                {% for task in tasks if task.column_name == col %}
                <div class="panel ripple task-card" style="margin: 0; padding: 16px; cursor: grab; background: var(--color-bg-panel); border-color: var(--color-border);" data-id="{{ task.id }}">
                    <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 8px;">{{ task.title }}</div>
                    {% if task.priority %}
                    <span class="badge" style="font-size: 9px; background: {{ 'rgba(239, 68, 68, 0.1)' if task.priority == 'HIGH' else 'rgba(37, 99, 235, 0.1)' }}; color: {{ 'var(--color-danger)' if task.priority == 'HIGH' else 'var(--color-accent)' }};">
                        {{ task.priority }}
                    </span>
                    {% endif %}
                    <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 10px; color: var(--text-tertiary);">#{{ task.id[:6] }}</div>
                        {% if task.assigned_user %}
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--color-accent); display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 800; color: #fff;">
                            {{ task.assigned_user[0]|upper }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="/static/vendor/sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(col => {
        new Sortable(col, {
            group: 'kanban',
            animation: 150,
            ghostClass: 'skeleton-tag', // Reuse skeleton style for ghost
            onEnd: async (evt) => {
                const taskId = evt.item.dataset.id;
                const newColumn = evt.to.id.replace('col-', '').replace('-', ' ');
                console.log(`Task ${taskId} moved to ${newColumn}`);
                
                // Task 116: Backend Sync
                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                    await fetch(`/api/tasks/${taskId}/move`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({ column: newColumn })
                    });
                } catch (e) {
                    console.error('Failed to sync task move', e);
                }
            }
        });
    });
});
</script>
{% endblock %}
