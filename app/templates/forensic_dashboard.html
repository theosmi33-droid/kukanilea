{% extends "layout.html" %}
{% block title %}Forensic Dashboard{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: var(--spacing-6);">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
        <div>
            <h1 style="font-size: 32px; font-weight: 800; color: var(--color-text-main); letter-spacing: -0.02em; margin-bottom: 4px;">Forensic Monitor</h1>
            <p style="color: var(--color-text-muted); font-size: 14px;">Echtzeit-Überwachung der System-Integrität und Nutzeraktivitäten.</p>
        </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary btn-sm" onclick="window.location.reload()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Aktualisieren
                </button>
                <div class="panel" style="margin: 0; padding: 8px 16px; display: flex; align-items: center; gap: 8px; background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
        
                <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-success); box-shadow: 0 0 10px var(--color-success);"></div>
                <span style="font-size: 12px; font-weight: 700; color: var(--color-success);">SYSTEM LIVE</span>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-4 gap-6">
        <div class="panel" style="margin: 0;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Aktive Sitzungen</div>
            <div style="font-size: 28px; font-weight: 800; color: var(--color-text-main);">{{ active_users|length }}</div>
            <div style="font-size: 11px; color: var(--color-success); margin-top: 4px;">↑ Stabil</div>
        </div>
        <div class="panel" style="margin: 0;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">DB-Latenz</div>
            <div style="font-size: 28px; font-weight: 800; color: var(--color-accent);">{{ perf.db_query_speed }}ms</div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">Soll: < 50ms</div>
        </div>
        <div class="panel" style="margin: 0;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Boot-Zeit</div>
            <div style="font-size: 28px; font-weight: 800; color: var(--color-text-main);">{{ perf.boot_time_ms }}ms</div>
            <div style="font-size: 11px; color: var(--color-warning); margin-top: 4px;">Inkrementell</div>
        </div>
        <div class="panel" style="margin: 0;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Audit-Events (24h)</div>
            <div style="font-size: 28px; font-weight: 800; color: var(--color-text-main);">{{ audit_count }}</div>
            <div style="font-size: 11px; color: var(--color-success); margin-top: 4px;">Lückenlos</div>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-6">
        <!-- Activity Feed -->
        <div class="panel" style="grid-column: span 2; margin: 0; display: flex; flex-direction: column;">
            <h2 style="font-size: 18px; font-weight: 700; color: var(--color-text-main); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                Forensischer Aktivitäts-Feed
            </h2>
            <div style="display: flex; flex-direction: column; gap: 1px; background: var(--color-border); border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--color-border);">
                {% for log in trail[:15] %}
                <div style="background: var(--color-bg-panel); padding: 12px 16px; display: flex; align-items: center; gap: 16px;">
                    <div style="font-size: 11px; font-family: var(--font-mono); color: var(--text-tertiary); width: 80px;">{{ log.ts[11:19] }}</div>
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;">{{ log.username[0]|upper }}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--color-text-main);">{{ log.action }}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">{{ log.resource }} • {{ log.details[:60] }}...</div>
                    </div>
                    <div class="badge" style="font-size: 9px;">{{ log.tenant_id }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- System Health -->
        <div class="panel" style="margin: 0;">
            <h2 style="font-size: 18px; font-weight: 700; color: var(--color-text-main); margin-bottom: 16px;">System Health</h2>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px;">
                        <span style="color: var(--text-tertiary);">CPU-Last</span>
                        <span style="color: var(--color-text-main); font-weight: 700;">{{ perf.cpu_usage }}%</span>
                    </div>
                    <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; background: var(--color-accent); width: {{ perf.cpu_usage }}%;"></div>
                    </div>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px;">
                        <span style="color: var(--text-tertiary);">RAM-Nutzung (RSS)</span>
                        <span style="color: var(--color-text-main); font-weight: 700;">{{ perf.memory_info.rss_mb|int if perf.memory_info != "N/A (psutil missing)" else "N/A" }} MB</span>
                    </div>
                    <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; background: var(--color-warning); width: 45%;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 8px; padding-top: 16px; border-top: 1px solid var(--color-border);">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 12px;">Letzte Integritätsprüfung</div>
                    <div style="padding: 12px; border-radius: 8px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.1); display: flex; align-items: center; gap: 12px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: var(--color-success);">Alle Hashes valide</div>
                            <div style="font-size: 10px; color: var(--text-tertiary);">Vor 42 Minuten durchgeführt</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
