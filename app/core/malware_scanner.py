"""
app/core/malware_scanner.py
Phase 5: Forensic ClamAV Stream-Scan Middleware.
Ensures every uploaded file is clean before processing.
"""

import logging
from pathlib import Path

logger = logging.getLogger("kukanilea.security")

try:
    import pyclamd
except ImportError:
    pyclamd = None

def scan_file_stream(file_path: Path) -> bool:
    """Scans a file for malware using ClamAV."""
    if pyclamd is None:
        logger.warning("ClamAV (pyclamd) not installed. Skipping real scan.")
        return True

    try:
        cd = pyclamd.ClamdUnixSocket()
        if not cd.ping():
            cd = pyclamd.ClamdNetworkSocket()
            
        res = cd.scan_file(str(file_path))
        if res:
            logger.error(f"MALWARE DETECTED in {file_path}: {res}")
            return False
        return True
    except Exception as e:
        logger.warning(f"ClamAV scan skipped (connection failed): {e}")
        # Fail open for development/demo if ClamAV is not reachable
        return True
